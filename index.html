<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>KRAVEAI — Panel</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0d12">
<style>
/* =========================================================
   KRAVE UI v2 — Tokens
   ========================================================= */
:root{
  --bg:#f6f8fb; --elev:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#66758e; --line:#e4e9f2;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --brand:linear-gradient(135deg,#7c5cff 0%,#00d3c2 100%);
  --r:14px; --gap:12px; --shadow:0 12px 30px rgba(0,0,0,.08);
}
[data-theme="dark"]{
  --bg:#0a0e14; --elev:#0e131b; --card:#101827; --text:#eaf0f8; --muted:#90a0b8; --line:#1e2a3d;
  --shadow:0 16px 44px rgba(0,0,0,.28);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:15px/1.45 system-ui,-apple-system,"SF Pro Text",Inter,Roboto;
  transition: background .25s ease,color .25s ease;
  background-image:
    radial-gradient(30rem 22rem at 12% 60%, color-mix(in oklab, var(--brand) 10%, transparent) , transparent 60%),
    radial-gradient(24rem 18rem at 88% 20%, color-mix(in oklab, var(--brand) 8%, transparent), transparent 60%);
}
@media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }
.app{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}

/* =========================================================
   Topbar + Back
   ========================================================= */
.top{
  position:sticky;top:0;z-index:30;
  display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;
  padding:10px max(14px,env(safe-area-inset-left)) 8px max(14px,env(safe-area-inset-right));
  background:color-mix(in oklab, var(--elev) 92%, transparent);
  backdrop-filter:saturate(1.05) blur(14px); border-bottom:1px solid var(--line);
}
.brand{display:flex;align-items:center;gap:10px}
.badge{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:var(--brand);box-shadow:0 12px 26px rgba(124,92,255,.25),0 10px 18px rgba(0,211,194,.16)}
.word{font-weight:900;letter-spacing:.16em;background:var(--brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.status{display:flex;align-items:center;gap:8px;justify-self:center;color:var(--muted)}
.status .dot{width:8px;height:8px;border-radius:50%;background:#8b94a8}
.status[data-online="true"] .dot{background:var(--ok);animation:pulse 2s ease-out infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}70%{box-shadow:0 0 0 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
.theme-toggle{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;cursor:pointer;background:rgba(0,0,0,.04);border:1px solid var(--line)}
.icon-moon{display:none}
[data-theme="dark"] .icon-sun{display:none}
[data-theme="dark"] .icon-moon{display:block}

.back{
  position:absolute;left:max(8px,env(safe-area-inset-left));top:10px;
  width:36px;height:36px;border-radius:12px;display:none;place-items:center;
  background:rgba(0,0,0,.04);border:1px solid var(--line);cursor:pointer;z-index:35;
}
.back svg{width:20px;height:20px}
body[data-can-back="true"] .back{display:grid}

/* =========================================================
   Bottom nav
   ========================================================= */
.nav{
  position:sticky;bottom:0;z-index:25;
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
  padding:8px max(12px,env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-right));
  background:color-mix(in oklab,var(--elev) 92%, transparent); border-top:1px solid var(--line);
  backdrop-filter:saturate(1.05) blur(14px);
}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:12px;color:var(--muted);border:1px solid transparent;cursor:pointer}
.tab svg{width:18px;height:18px}
.tab small{font-size:.72rem}
input[name="tab"]{position:absolute;opacity:0;pointer-events:none}
#tab-home:checked ~ .app .nav label[for="tab-home"],
#tab-clients:checked ~ .app .nav label[for="tab-clients"],
#tab-farm:checked ~ .app .nav label[for="tab-farm"],
#tab-accounts:checked ~ .app .nav label[for="tab-accounts"]{
  color:var(--text);background:rgba(0,0,0,.04);border-color:var(--line);
}

/* =========================================================
   Views
   ========================================================= */
.main{
  height:calc(100svh - 56px - 64px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  padding:12px max(14px,env(safe-area-inset-left)) 12px max(14px,env(safe-area-inset-right));
  overflow:auto;
}
.view{display:none;animation:fade .16s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
#tab-home:checked ~ .app .view[data-tab="home"],
#tab-clients:checked ~ .app .view[data-tab="clients"],
#tab-farm:checked ~ .app .view[data-tab="farm"],
#tab-accounts:checked ~ .app .view[data-tab="accounts"]{display:block}

/* =========================================================
   Cards & grids
   ========================================================= */
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
.grid{display:grid;gap:12px}
.section-title{display:flex;align-items:center;gap:8px;font-weight:900;margin:2px 0 6px}
.hint{color:var(--muted);font-size:.86rem;margin-bottom:8px}
.btn{border:1px solid var(--line);background:rgba(0,0,0,.04);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;font-size:.9rem;cursor:pointer}
.btn-primary{border:0;background:var(--brand);color:#0b0d13}

/* =========================================================
   HOME — Jerarquía (Home → Red → Servicio)
   ========================================================= */
.stack{position:relative}
.panel{display:none}
.panel.active{display:block}
.home-grid{
  display:grid;gap:12px;
  grid-template-columns:repeat(3, minmax(0,1fr));
}
@media (min-width:520px){.home-grid{grid-template-columns:repeat(4, minmax(0,1fr))}}
@media (min-width:900px){.home-grid{grid-template-columns:repeat(6, minmax(0,1fr))}}

.net-tile{
  padding:14px 10px;border-radius:16px;border:1px solid var(--line);background:var(--card);
  display:grid;place-items:center;gap:8px;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.net-tile:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.12);border-color:color-mix(in oklab,var(--brand) 25%, var(--line))}
.net-ico{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:rgba(0,0,0,.04);border:1px solid var(--line)}
.net-ico svg{width:22px;height:22px}
.net-lab{font-weight:800;font-size:.95rem}

/* Lista de servicios de una red */
.serv-list{display:grid;gap:10px}
.serv-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 12px;border:1px solid var(--line);border-radius:14px;background:var(--card);cursor:pointer}
.serv-left{display:flex;align-items:center;gap:10px}
.serv-ico{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:rgba(0,0,0,.05);border:1px solid var(--line)}
.serv-ico svg{width:18px;height:18px}
.serv-title{font-weight:800}
.arrow{opacity:.6}

/* Form genérico de servicio */
.input{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:rgba(0,0,0,.04);border-radius:12px;padding:10px}
.input input, .input textarea{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:.95rem}
.form-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.form-grid .input.full{grid-column:1/-1}

/* =========================================================
   CLIENTES — IG sólo handles y verificación oficial
   ========================================================= */
.clients{display:grid;gap:10px;grid-template-columns:1fr;max-width:700px}
.client{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:var(--card)}
.client-logo{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg, rgba(225,48,108,.12), rgba(155,28,78,.18));border:1px solid rgba(225,48,108,.35)}
.client-logo svg{width:16px;height:16px}
.handle{font-weight:800}
.verify{width:18px;height:18px}

/* =========================================================
   FARM — Mejorado
   ========================================================= */
.farm{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.farm-bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
.toggle{display:inline-flex;gap:8px;align-items:center}
.dev{display:grid;gap:10px;padding:12px}
.dev-head{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:.92rem}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:5px 8px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.04);font-size:.78rem}
.chip[data-status="live"]{background:rgba(34,197,94,.12);border-color:var(--ok);color:var(--ok)}
.screen{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#000;height:220px;position:relative}
.screen iframe,.screen img,.screen video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.screen .placeholder{position:absolute;inset:0;background:radial-gradient(120% 80% at 10% 10%, rgba(124,92,255,.25), transparent 60%),radial-gradient(120% 80% at 90% 90%, rgba(0,211,194,.18), transparent 60%),#000}
.ov{position:absolute;left:6px;top:6px;display:flex;gap:6px;z-index:2}
.toolbar{position:absolute;right:6px;bottom:6px;display:flex;gap:6px;z-index:2}
.tool{border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.38);color:#fff;padding:6px 8px;border-radius:10px;font-size:.78rem;cursor:pointer}

/* =========================================================
   Créditos (safe-area y sobre nav)
   ========================================================= */
.credit{
  position:fixed;right:max(12px,env(safe-area-inset-right));z-index:35;
  bottom:calc(var(--nav-h,64px) + env(safe-area-inset-bottom) + 8px);
  font-size:.86rem;color:var(--text);background:linear-gradient(180deg,color-mix(in oklab,var(--elev) 96%, transparent),color-mix(in oklab,var(--elev) 98%, transparent));border:1px solid var(--line);border-radius:999px;padding:7px 12px;backdrop-filter:blur(6px)
}
</style>
</head>
<body>

<!-- Radios de tabs -->
<input type="radio" name="tab" id="tab-home" checked>
<input type="radio" name="tab" id="tab-clients">
<input type="radio" name="tab" id="tab-farm">
<input type="radio" name="tab" id="tab-accounts">

<!-- ===== SVG sprite (logo + nav + redes + verificado) ===== -->
<svg width="0" height="0" aria-hidden="true" style="position:absolute">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#7c5cff"/><stop offset="100%" stop-color="#00d3c2"/>
    </linearGradient>

    <!-- Logo KRAVE -->
    <symbol id="klogo" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="url(#g)" opacity=".14"/>
      <path d="M18 14h10v16l16-16h12L40 30l16 20H44L28 36v14H18V14z" fill="url(#g)"/>
    </symbol>

    <!-- Nav icons -->
    <symbol id="ico-home" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v9a2 2 0 0 1-2 2h-4v-7H9v7H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-users" viewBox="0 0 24 24"><path d="M7 14a4 4 0 1 1 4-4M3 21a6 6 0 0 1 12 0M17 11a3 3 0 1 1 6 0M15 21a6 6 0 0 1 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-devices" viewBox="0 0 24 24"><rect x="3" y="4" width="14" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><rect x="19" y="8" width="2" height="8" rx="1" fill="currentColor"/></symbol>
    <symbol id="ico-lock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="9" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-back" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-moon" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.4 5.4 0 0 1-4.4 2.26 5.4 5.4 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>

    <!-- IG verified oficial (círculo azul con check) -->
    <symbol id="ig-verified" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#0095F6"/><path d="M8.8 12.2l2.2 2.2 5-5" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></symbol>

    <!-- Logos oficiales (minimal vector) -->
    <symbol id="logo-instagram" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="12" cy="12" r="4" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="17.2" cy="6.8" r="1.2" fill="#E1306C"/>
    </symbol>
    <symbol id="logo-tiktok" viewBox="0 0 24 24">
      <path d="M10 4v9.2a3.8 3.8 0 1 1-2.8 6.2" fill="none" stroke="#69C9D0" stroke-width="2"/>
      <path d="M14 4c.5 2.3 2.2 4 5 4" fill="none" stroke="#ff0050" stroke-width="2"/>
    </symbol>
    <symbol id="logo-youtube" viewBox="0 0 24 24">
      <rect x="3" y="6" width="18" height="12" rx="3" fill="#FF0000"/><path d="M10 9l6 3-6 3z" fill="#fff"/>
    </symbol>
    <symbol id="logo-threads" viewBox="0 0 24 24"><path d="M6 12c0-4 3-7 6-7s6 3 6 7-3 7-6 7c-2 0-3.5-1-3.5-2.5S9 14 12 14c2.5 0 3.8-1.2 3.8-3S14.5 8 12 8" fill="none" stroke="#000" stroke-width="2"/></symbol>
    <symbol id="logo-x" viewBox="0 0 24 24"><path d="M4 4l16 16M20 4L4 20" stroke="#000" stroke-width="2"/></symbol>
    <symbol id="logo-facebook" viewBox="0 0 24 24"><path d="M14 8h3V5h-3c-2 0-3 .9-3 3v2H8v3h3v6h3v-6h3l1-3h-4V8c0-.7.3-1 1-1z" fill="#1877F2"/></symbol>
    <symbol id="logo-linkedin" viewBox="0 0 24 24"><rect x="3" y="8" width="4" height="12" fill="#0A66C2"/><circle cx="5" cy="5.5" r="2" fill="#0A66C2"/><rect x="9" y="8" width="12" height="12" rx="2" fill="none" stroke="#0A66C2" stroke-width="2"/></symbol>
    <symbol id="logo-telegram" viewBox="0 0 24 24"><path d="M21 3L3 11l6 2 2 6 3-4 4-10z" fill="#0088cc"/></symbol>
    <symbol id="logo-whatsapp" viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 1 0 18 9.4 9.4 0 0 1-4-.9L5 21l.9-3.1A9.4 9.4 0 0 1 3 12 9 9 0 0 1 12 3z" fill="#25D366"/><path d="M9 8c0 3 3 6 5 6l1-1" stroke="#fff" stroke-width="2"/></symbol>
  </defs>
</svg>

<div class="app" id="app">
  <!-- Topbar -->
  <header class="top">
    <button class="back" id="back-btn" title="Volver"><svg><use href="#ico-back"/></svg></button>
    <div class="brand">
      <div class="badge"><svg viewBox="0 0 64 64" width="20" height="20"><use href="#klogo"/></svg></div>
      <div class="word">KRAVEAI</div>
    </div>
    <div class="status" id="status"><span class="dot"></span><small id="status-text">Conectando…</small></div>
    <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema" title="Cambiar tema">
      <svg class="icon-sun" width="20" height="20"><use href="#ico-sun"/></svg>
      <svg class="icon-moon" width="20" height="20"><use href="#ico-moon"/></svg>
    </button>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- HOME (stack con paneles) -->
    <section class="view" data-tab="home">
      <div class="stack" id="home-stack">
        <!-- Panel 1: Home raíz (solo redes) -->
        <div class="panel active" data-panel="home-root">
          <div class="section-title">Redes sociales</div>
          <div class="hint">Toca una red para ver sus servicios.</div>
          <div class="home-grid" id="home-grid"></div>
        </div>

        <!-- Panel 2: Red social → lista de servicios -->
        <div class="panel" data-panel="network">
          <div class="section-title" id="net-title">Servicios</div>
          <div class="serv-list" id="serv-list"></div>
        </div>

        <!-- Panel 3: Servicio concreto (form o plantilla) -->
        <div class="panel" data-panel="service">
          <div class="section-title" id="svc-title">Servicio</div>
          <div id="svc-body"></div>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section class="view" data-tab="clients">
      <div class="section-title">Clientes recientes</div>
      <div class="hint">Cuentas verificadas en Instagram</div>
      <div class="clients">
        <div class="card client">
          <div class="client-logo"><svg><use href="#logo-instagram"/></svg></div>
          <div class="handle">@aaronmercury</div>
          <svg class="verify"><use href="#ig-verified"/></svg>
        </div>
        <div class="card client">
          <div class="client-logo"><svg><use href="#logo-instagram"/></svg></div>
          <div class="handle">@televisadigital</div>
          <svg class="verify"><use href="#ig-verified"/></svg>
        </div>
        <div class="card client">
          <div class="client-logo"><svg><use href="#logo-instagram"/></svg></div>
          <div class="handle">@joscanela</div>
          <svg class="verify"><use href="#ig-verified"/></svg>
        </div>
        <div class="card client">
          <div class="client-logo"><svg><use href="#logo-instagram"/></svg></div>
          <div class="handle">@jimenagallegotv</div>
          <svg class="verify"><use href="#ig-verified"/></svg>
        </div>
      </div>
    </section>

    <!-- FARM -->
    <section class="view" data-tab="farm">
      <div class="section-title">Device Farm</div>
      <div class="farm-bar">
        <div class="toggle">
          <label><input type="checkbox" id="dense"> Vista densa</label>
        </div>
        <small class="hint">Streams: HLS .m3u8, MJPEG .mjpg o visor http</small>
      </div>
      <div class="farm" id="farm-grid"></div>
    </section>

    <!-- ACCOUNTS -->
    <section class="view" data-tab="accounts">
      <div class="section-title">Cuentas</div>
      <div class="grid" style="grid-template-columns:1fr;max-width:880px">
        <div class="card" style="padding:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <div class="serv-ico"><svg><use href="#ico-lock"/></svg></div>
            <div><div class="serv-title">Sesión</div><small class="hint" id="session-sub" style="margin:0">Verificando…</small></div>
          </div>
          <div class="form-grid" style="margin-top:10px">
            <div class="input full"><span>@</span><input id="login-username" placeholder="Usuario"></div>
            <div class="input full"><span>🔒</span><input id="login-password" type="password" placeholder="Contraseña"></div>
            <button class="btn btn-primary" id="login-btn">Iniciar sesión</button>
            <button class="btn" id="logout-btn">Cerrar sesión</button>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <div class="serv-ico"><svg><use href="#logo-instagram"/></svg></div>
            <div><div class="serv-title">Agregar cuenta manual</div><small class="hint" style="margin:0">Se valida y se inserta</small></div>
          </div>
          <div class="form-grid" style="margin-top:10px">
            <div class="input full"><span>@</span><input id="manual-username" placeholder="@usuario"></div>
            <div class="input full"><span>🔒</span><input id="manual-password" type="password" placeholder="••••••••"></div>
            <button class="btn btn-primary" id="add-account-btn">Guardar cuenta</button>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <div class="serv-ico"><svg><use href="#ico-users"/></svg></div>
            <div><div class="serv-title">Cuentas activas</div><small class="hint" style="margin:0">Actualiza cada 30s</small></div>
          </div>
          <div id="accounts-list" class="grid" style="grid-template-columns:1fr;gap:8px;margin-top:10px"><div class="hint">Cargando…</div></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="nav" id="nav">
    <label class="tab" for="tab-home"><svg><use href="#ico-home"/></svg><small>Inicio</small></label>
    <label class="tab" for="tab-clients"><svg><use href="#ico-users"/></svg><small>Clientes</small></label>
    <label class="tab" for="tab-farm"><svg><use href="#ico-devices"/></svg><small>Farm</small></label>
    <label class="tab" for="tab-accounts"><svg><use href="#ico-lock"/></svg><small>Cuentas</small></label>
  </nav>
</div>

<!-- Firma (safe-area aware) -->
<div class="credit" id="credit">Created by Karmean Gómez</div>

<script>
(function(){
  const API_URL = "https://api.kraveapi.xyz";

  /* ===== Tema sin “pantalla negra” ===== */
  const themeToggle = document.getElementById('theme-toggle');
  const saved = localStorage.getItem('theme');
  if(saved) document.documentElement.setAttribute('data-theme', saved);
  themeToggle.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });

  /* ===== Estado backend ===== */
  const status = document.getElementById('status');
  const statusText = document.getElementById('status-text');
  async function checkHealth(){
    try{
      const r = await fetch(\`\${API_URL}/health\`, {credentials:'include'});
      if(r.ok){status.setAttribute('data-online','true'); statusText.textContent='Conectado';}
      else throw new Error();
    }catch{ status.removeAttribute('data-online'); statusText.textContent='Sin conexión'; }
  }
  checkHealth(); setInterval(checkHealth, 120000);

  /* ===== Safe position de “Created by” sobre el nav ===== */
  const nav = document.getElementById('nav');
  const credit = document.getElementById('credit');
  function positionCredit(){ document.body.style.setProperty('--nav-h', nav.getBoundingClientRect().height + 'px'); }
  window.addEventListener('resize', positionCredit); positionCredit();

  /* =====================================================
     HOME — solo logos → red → servicio
     ===================================================== */
  const NETWORKS = [
    {key:'instagram', label:'Instagram', color:'#E1306C', logo:'#logo-instagram', services:[
      {key:'comentarios', label:'Comentarios', icon:'💬', type:'form'},
      {key:'likes', label:'Likes', icon:'❤️', type:'template'},
      {key:'seguidores', label:'Seguidores', icon:'👥', type:'template'},
      {key:'vistas', label:'Vistas', icon:'▶️', type:'template'},
    ]},
    {key:'tiktok', label:'TikTok', color:'#69C9D0', logo:'#logo-tiktok', services:[
      {key:'vistas', label:'Vistas', icon:'▶️', type:'template'},
      {key:'likes', label:'Likes', icon:'❤️', type:'template'},
      {key:'seguidores', label:'Seguidores', icon:'👥', type:'template'},
      {key:'compartidos', label:'Compartidos', icon:'🔁', type:'template'},
    ]},
    {key:'youtube', label:'YouTube', color:'#FF0000', logo:'#logo-youtube', services:[
      {key:'vistas', label:'Vistas', icon:'▶️', type:'template'},
      {key:'likes', label:'Likes', icon:'👍', type:'template'},
      {key:'suscripciones', label:'Suscripciones', icon:'🔔', type:'template'},
      {key:'comentarios', label:'Comentarios', icon:'💬', type:'template'},
    ]},
    {key:'x', label:'X', color:'#111', logo:'#logo-x', services:[
      {key:'likes', label:'Likes', icon:'❤️', type:'template'},
      {key:'reposts', label:'Reposts', icon:'🔁', type:'template'},
      {key:'seguidores', label:'Seguidores', icon:'👥', type:'template'},
      {key:'respuestas', label:'Respuestas', icon:'💬', type:'template'},
    ]},
    {key:'facebook', label:'Facebook', color:'#1877F2', logo:'#logo-facebook', services:[
      {key:'reacciones', label:'Reacciones', icon:'👍', type:'template'},
      {key:'comentarios', label:'Comentarios', icon:'💬', type:'template'},
      {key:'compartidos', label:'Compartidos', icon:'🔁', type:'template'},
    ]},
    {key:'linkedin', label:'LinkedIn', color:'#0A66C2', logo:'#logo-linkedin', services:[
      {key:'reacciones', label:'Reacciones', icon:'👍', type:'template'},
      {key:'comentarios', label:'Comentarios', icon:'💬', type:'template'},
      {key:'conexiones', label:'Conexiones', icon:'👥', type:'template'},
    ]},
    {key:'whatsapp', label:'WhatsApp', color:'#25D366', logo:'#logo-whatsapp', services:[
      {key:'mensajes', label:'Mensajes', icon:'💬', type:'template'},
      {key:'grupos', label:'Grupos', icon:'👥', type:'template'},
    ]},
    {key:'telegram', label:'Telegram', color:'#0088cc', logo:'#logo-telegram', services:[
      {key:'mensajes', label:'Mensajes', icon:'💬', type:'template'},
      {key:'miembros', label:'Miembros', icon:'👥', type:'template'},
      {key:'reacciones', label:'Reacciones', icon:'👍', type:'template'},
    ]},
  ];

  const homeGrid = document.getElementById('home-grid');
  homeGrid.innerHTML = NETWORKS.map(n=>`
    <article class="net-tile" data-net="${n.key}">
      <div class="net-ico" style="color:${n.color}"><svg><use href="${n.logo}"/></svg></div>
      <div class="net-lab">${n.label}</div>
    </article>
  `).join('');

  const stack = document.getElementById('home-stack');
  const panels = {
    root: stack.querySelector('[data-panel="home-root"]'),
    net: stack.querySelector('[data-panel="network"]'),
    svc: stack.querySelector('[data-panel="service"]'),
  };
  const netTitle = document.getElementById('net-title');
  const servList = document.getElementById('serv-list');
  const svcTitle = document.getElementById('svc-title');
  const svcBody = document.getElementById('svc-body');

  let navStack = ['home-root']; // para back
  function showPanel(name){
    stack.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    if(name==='home-root'){panels.root.classList.add('active')}
    if(name==='network'){panels.net.classList.add('active')}
    if(name==='service'){panels.svc.classList.add('active')}
    document.body.toggleAttribute('data-can-back', navStack.length>1);
  }

  // abrir red
  homeGrid.addEventListener('click', (e)=>{
    const tile = e.target.closest('.net-tile'); if(!tile) return;
    const key = tile.dataset.net;
    const net = NETWORKS.find(n=>n.key===key);
    if(!net) return;
    netTitle.textContent = net.label;
    servList.innerHTML = net.services.map(s=>`
      <div class="card serv-item" data-net="${net.key}" data-service="${s.key}">
        <div class="serv-left">
          <div class="serv-ico"><span aria-hidden="true">${s.icon}</span></div>
          <div class="serv-title">${s.label}</div>
        </div>
        <div class="arrow">›</div>
      </div>
    `).join('');
    navStack.push('network'); showPanel('network');
  });

  // abrir servicio
  servList.addEventListener('click', (e)=>{
    const it = e.target.closest('.serv-item'); if(!it) return;
    const net = it.dataset.net; const svc = it.dataset.service;
    const netObj = NETWORKS.find(n=>n.key===net);
    const svcObj = netObj?.services.find(s=>s.key===svc);
    if(!svcObj) return;
    svcTitle.textContent = netObj.label + ' — ' + svcObj.label;

    // Cuerpo (sólo IG Comentarios cableado; lo demás plantilla)
    if(net==='instagram' && svc==='comentarios'){
      svcBody.innerHTML = `
        <div class="card" style="padding:12px">
          <div class="form-grid">
            <div class="input full"><span>🔗</span><input id="ig-url" placeholder="URL del post (https://www.instagram.com/p/...)" required></div>
            <div class="input"><span>#</span><input id="ig-cantidad" type="number" min="1" max="100" value="30" placeholder="Cantidad"></div>
            <div class="input"><span>🎛️</span><input id="ig-modo" value="auto" list="modos" placeholder="Modo"></div>
            <datalist id="modos"><option value="auto"><option value="personalizado"><option value="manual"></datalist>
            <div class="input full"><span>🧑‍💼</span><input id="ig-apodo" placeholder="Apodo (opcional)"></div>
            <div class="input"><span>🎯</span><input id="ig-estilo" placeholder="Estilo (fitness, sexy, etc)"></div>
            <div class="input"><span>🏷️</span><input id="ig-actividad" placeholder="Actividad (entrenador, etc)"></div>
            <div class="input full"><span>📝</span><textarea id="ig-ejemplos" rows="2" placeholder="Ejemplos (uno por línea)"></textarea></div>
            <button class="btn btn-primary" id="ig-send">Lanzar</button>
            <button class="btn" id="ig-cancel">Cancelar</button>
          </div>
          <div id="ig-status" class="hint" style="margin-top:8px">—</div>
        </div>`;
      // listeners del form IG
      const igSend = () => (async ()=>{
        const payload = {
          url: document.getElementById('ig-url').value.trim(),
          cantidad: document.getElementById('ig-cantidad').value.trim(),
          modo: document.getElementById('ig-modo').value.trim(),
          apodo: document.getElementById('ig-apodo').value.trim(),
          estilo: document.getElementById('ig-estilo').value.trim(),
          actividad: document.getElementById('ig-actividad').value.trim(),
          ejemplos: document.getElementById('ig-ejemplos').value.trim(),
        };
        const st=document.getElementById('ig-status');
        if(!payload.url){ st.textContent='❌ Falta URL'; return; }
        try{
          st.textContent='Enviando…';
          const r=await fetch(\`\${API_URL}/instagram/comentarios\`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify(payload)
          });
          const d=await r.json().catch(()=>({}));
          if(r.ok){ st.textContent='✅ Comentarios en proceso'; }
          else throw new Error(d.mensaje||'Error en comentarios');
        }catch(err){ st.textContent='❌ '+err.message; }
      })();
      setTimeout(()=>{
        document.getElementById('ig-send').addEventListener('click', igSend);
        document.getElementById('ig-cancel').addEventListener('click', ()=> document.getElementById('ig-status').textContent='—');
      },0);
    }else{
      svcBody.innerHTML = `
        <div class="card" style="padding:14px">
          <div class="hint">Plantilla lista para cablear a <strong>${netObj.label} → ${svcObj.label}</strong>.</div>
          <div class="form-grid">
            <div class="input full"><span>🔗</span><input placeholder="URL / identificador"></div>
            <div class="input"><span>#</span><input type="number" min="1" placeholder="Cantidad"></div>
            <button class="btn btn-primary">Enviar</button>
          </div>
        </div>`;
    }

    navStack.push('service'); showPanel('service');
  });

  /* ===== Back button + swipe-back ===== */
  const backBtn = document.getElementById('back-btn');
  function goBack(){
    if(navStack.length>1){ navStack.pop(); showPanel(navStack[navStack.length-1]); }
    else window.history.back();
  }
  backBtn.addEventListener('click', goBack);

  // Gesto: deslizar desde el borde izquierdo
  let startX=null, startY=null, tracking=false;
  document.addEventListener('pointerdown', (e)=>{
    if(e.clientX < 24){ startX=e.clientX; startY=e.clientY; tracking=true; }
  });
  document.addEventListener('pointermove', (e)=>{
    if(!tracking) return;
    const dx=e.clientX-startX, dy=Math.abs(e.clientY-startY);
    if(dx>70 && dy<40){ tracking=false; goBack(); }
    if(dx<-10 || dy>50) tracking=false;
  });
  document.addEventListener('pointerup', ()=> tracking=false);

  // Cambiar tabs (limpia stack al volver a Home)
  document.querySelectorAll('input[name="tab"]').forEach(r=> r.addEventListener('change', ()=>{
    if(document.getElementById('tab-home').checked){ navStack=['home-root']; showPanel('home-root'); }
    document.body.toggleAttribute('data-can-back', navStack.length>1);
  }));

  /* =====================================================
     CUENTAS
     ===================================================== */
  const sessionSub=document.getElementById('session-sub');
  async function checkSession(){
    try{
      const r=await fetch(\`\${API_URL}/estado-sesion\`,{credentials:'include'});
      const d=await r.json();
      sessionSub.textContent=(d.status==='activo')?(\`Sesión activa como @\${d.usuario}\`):'No hay sesión activa';
    }catch{ sessionSub.textContent='Error al verificar sesión'; }
  }
  checkSession();

  document.getElementById('login-btn').addEventListener('click', async ()=>{
    const u=document.getElementById('login-username').value.trim().replace('@','');
    const p=document.getElementById('login-password').value.trim();
    if(!u||!p){ sessionSub.textContent='Completa usuario y contraseña'; return; }
    try{
      const btn=document.getElementById('login-btn'); btn.textContent='Iniciando…'; btn.disabled=true;
      const r=await fetch(\`\${API_URL}/iniciar-sesion\`,{
        method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',
        body:JSON.stringify({usuario:u,contrasena:p})
      });
      const d=await r.json();
      if(d.exito){ sessionSub.textContent=\`Sesión activa como @\${d.usuario}\`; }
      else throw new Error(d.mensaje||'Error al iniciar');
    }catch(err){ sessionSub.textContent=err.message; }
    finally{ const btn=document.getElementById('login-btn'); btn.textContent='Iniciar sesión'; btn.disabled=false; }
  });

  document.getElementById('logout-btn').addEventListener('click', async ()=>{
    try{
      const btn=document.getElementById('logout-btn'); btn.textContent='Cerrando…'; btn.disabled=true;
      const r=await fetch(\`\${API_URL}/cerrar-sesion\`,{credentials:'include'}); const d=await r.json();
      if(d.exito){ sessionSub.textContent='No hay sesión activa'; }
      else throw new Error(d.mensaje||'Error al cerrar');
    }catch(err){ sessionSub.textContent=err.message; }
    finally{ const btn=document.getElementById('logout-btn'); btn.textContent='Cerrar sesión'; btn.disabled=false; }
  });

  const accountsList=document.getElementById('accounts-list');
  async function loadAccounts(){
    try{
      const r=await fetch(\`\${API_URL}/cuentas-activas\`,{credentials:'include'}); const arr=await r.json();
      if(!Array.isArray(arr)||arr.length===0){accountsList.innerHTML='<div class="hint">No hay cuentas activas</div>';return}
      accountsList.innerHTML=arr.map(acc=>\`
        <div class="card" style="padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="width:10px;height:10px;border-radius:50%;background:\${acc.status==='activo'?'var(--ok)':'var(--err)'}"></span>
            <strong>@\${acc.username}</strong>
          </div>
          <div style="display:flex;gap:6px">
            \${acc.status==='activo' ? \`<button class="btn" data-logout="\${acc.username}">Logout</button>\` : \`<button class="btn btn-primary" data-login="\${acc.username}">Login</button>\`}
          </div>
        </div>\`).join('');
    }catch{ accountsList.innerHTML='<div class="hint">Error al cargar cuentas</div>'; }
  }
  loadAccounts(); setInterval(loadAccounts, 30000);

  accountsList.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.login){
      try{
        const r=await fetch(\`\${API_URL}/iniciar-sesion-cuenta\`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.login})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        loadAccounts();
      }catch(err){ alert(err.message); }
    }
    if(b.dataset.logout){
      try{
        const r=await fetch(\`\${API_URL}/cerrar-sesion-cuenta\`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.logout})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        loadAccounts();
      }catch(err){ alert(err.message); }
    }
  });

  /* =====================================================
     FARM
     ===================================================== */
  const defaultDevices=[
    {id:'dev1',name:'iPhone 14 Pro',os:'iOS',ip:'10.0.0.8'},
    {id:'dev2',name:'Galaxy S23',os:'Android',ip:'10.0.0.9'},
    {id:'dev3',name:'iPhone 13',os:'iOS',ip:'10.0.0.10'},
    {id:'dev4',name:'Pixel 8',os:'Android',ip:'10.0.0.11'}
  ];
  const farmGrid=document.getElementById('farm-grid');
  const denseToggle=document.getElementById('dense');
  denseToggle.addEventListener('change',()=>{ farmGrid.style.gridTemplateColumns = denseToggle.checked?'repeat(auto-fit,minmax(200px,1fr))':'repeat(auto-fit,minmax(260px,1fr))'; });

  function renderFarm(){
    farmGrid.innerHTML = defaultDevices.map(d=>{
      const src = localStorage.getItem('stream:'+d.id)||'';
      const live = !!src;
      return `
      <div class="card dev" data-id="${d.id}">
        <div class="dev-head">
          <div><strong>${d.name}</strong> · ${d.os}</div>
          <div class="chips">
            <span class="chip" data-status="${live?'live':''}">${live?'Live':'Idle'}</span>
            <span class="chip" data-copy="${d.ip}" title="Copiar IP">${d.ip}</span>
          </div>
        </div>
        <div class="screen" data-screen>
          <div class="ov"><span class="chip">${live?'Live':'Idle'}</span></div>
          <div class="placeholder" data-ph></div>
          <div class="toolbar">
            <button class="tool" data-set="${d.id}">Stream</button>
            <button class="tool" data-toggle="${d.id}">Pausa</button>
            <button class="tool" data-pip="${d.id}">PiP</button>
            <button class="tool" data-full="${d.id}">Full</button>
            <button class="tool" data-clear="${d.id}">Clear</button>
          </div>
        </div>
      </div>`;
    }).join('');
    initFarmStreams();
  }

  function initFarmStreams(){
    farmGrid.querySelectorAll('.dev').forEach(card=>{
      const id = card.dataset.id;
      const src = localStorage.getItem('stream:'+id)||'';
      const screen = card.querySelector('[data-screen]');
      const ph = screen.querySelector('[data-ph]');
      if(!src) return;
      ph?.remove();
      if(src.endsWith('.mjpg')||src.endsWith('.mjpeg')){
        const img = document.createElement('img'); img.src = src; img.crossOrigin='anonymous'; screen.appendChild(img);
      } else if(src.endsWith('.m3u8')){
        const v = document.createElement('video'); v.src = src; v.autoplay=true; v.muted=true; v.playsInline=true; screen.appendChild(v);
      } else {
        const f = document.createElement('iframe'); f.src = src; f.allow='autoplay; encrypted-media'; f.allowFullscreen=true; f.loading='lazy'; screen.appendChild(f);
      }
    });
  }

  function teardownFarm(){ farmGrid.querySelectorAll('video').forEach(v=> v.pause()); }

  farmGrid.addEventListener('click', (e)=>{
    const b=e.target.closest('button,.chip'); if(!b) return;
    const card=b.closest('.dev'); const id=card.dataset.id; const screen=card.querySelector('[data-screen]');
    if(b.dataset.copy){ navigator.clipboard?.writeText(b.dataset.copy); alert('IP copiada'); }
    if(b.dataset.set){
      const cur=localStorage.getItem('stream:'+id)||'';
      const url=prompt('URL stream (HLS .m3u8, MJPEG .mjpg, o https):',cur);
      if(url!==null){ localStorage.setItem('stream:'+id,url.trim()); renderFarm(); }
    }
    if(b.dataset.clear){ localStorage.removeItem('stream:'+id); renderFarm(); }
    if(b.dataset.full){ if(screen.requestFullscreen) screen.requestFullscreen(); }
    if(b.dataset.pip){
      const v = screen.querySelector('video');
      if(v && 'pictureInPictureEnabled' in document){
        if(document.pictureInPictureElement) document.exitPictureInPicture();
        else v.requestPictureInPicture().catch(()=>{});
      } else { alert('PiP solo disponible con video'); }
    }
    if(b.dataset.toggle){
      const v = screen.querySelector('video');
      const img = screen.querySelector('img');
      const iframe = screen.querySelector('iframe');
      const btn = b;
      if(v){ v.paused ? v.play() : v.pause(); btn.textContent = v.paused ? 'Reanudar' : 'Pausa'; }
      else if(img){ img.src = img.src ? '' : (localStorage.getItem('stream:'+id)||''); btn.textContent = img.src ? 'Pausa' : 'Reanudar'; }
      else if(iframe){ iframe.style.opacity = (iframe.style.opacity==='0.3'?'1':'0.3'); btn.textContent = (iframe.style.opacity==='0.3')?'Reanudar':'Pausa'; }
    }
  });

  // Lazy: iniciar streams al entrar a Farm y pausar al salir
  function onTabChange(){
    const inFarm = document.getElementById('tab-farm').checked;
    if(inFarm){
      if(!farmGrid.childElementCount) renderFarm(); else initFarmStreams();
    } else { teardownFarm(); }
  }
  document.querySelectorAll('input[name="tab"]').forEach(r=> r.addEventListener('change', onTabChange));
  onTabChange();

})();
</script>
</body>
</html> 