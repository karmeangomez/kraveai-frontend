<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <title>KraveAI - Panel de Control</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* [Todo el CSS original se mantiene sin cambios] */
    :root {
      --primary: #6e44ff;
      --primary-dark: #5a35d5;
      --secondary: #00c9b7;
      --dark: #121212;
      --darker: #0a0a0a;
      --light: #f0f0f0;
      --gray: #8c8ca1;
      --card-bg: #1a1a1a;
      --success: #4CAF50;
      --warning: #ff9800;
      --error: #f44336;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: linear-gradient(135deg, var(--darker), var(--dark));
      color: var(--light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* [Resto del CSS original se mantiene intacto] */
    /* ... (incluye todas las definiciones de .app-header, .app-content, .social-grid, etc.) ... */
  </style>
</head>
<body>
  <!-- [Todo el HTML original se mantiene sin cambios] -->
  <div class="app-header">
    <div class="logo">
      <i class="fas fa-brain"></i>
      <span>KraveAI</span>
    </div>
    <div class="user-avatar">KG</div>
    <div class="refresh-btn" id="refresh-btn">
      <i class="fas fa-sync-alt"></i>
    </div>
  </div>

  <div class="app-content">
    <!-- [Secciones originales como social-grid, clients-list, automation-box] -->
  </div>

  <!-- Instagram Panel -->
  <div id="instagram-panel">
    <!-- [Contenido original] -->
  </div>

  <!-- Create Accounts Panel -->
  <div id="create-accounts-panel">
    <!-- [Contenido original] -->
  </div>

  <!-- Login Panel -->
  <div id="login-panel">
    <div class="back-button" id="volver-login">
      <i class="fas fa-arrow-left"></i> Volver
    </div>

    <div class="app-content">
      <div class="section">
        <div class="section-title">
          <i class="fas fa-key"></i> Gestión de Sesiones
        </div>
        <div class="section-subtitle">Controla tus inicios de sesión en Instagram</div>

        <div class="create-form" id="login-form">
          <!-- [Formularios de login y agregar cuenta manual] -->
        </div>

        <div class="create-form" style="margin-top: 20px;">
          <div class="form-group">
            <label class="form-label">Cuentas activas:</label>
            <ul id="cuentas-activas-list" class="cuentas-list">
              <li>Cargando cuentas...</li>
            </ul>
          </div>
        </div>

        <!-- [Sección de búsqueda de usuario] -->
      </div>
    </div>
  </div>

  <!-- Comments Panel -->
  <div id="comments-panel">
    <!-- [Contenido original] -->
  </div>

  <div class="nav-bar">
    <!-- [Navegación original] -->
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i> <span id="notification-text"></span>
  </div>

  <script>
    // Configuración de la API
    const API_URL = "http://127.0.0.1:8000"; // Ajusta según tu backend

    // Elementos DOM
    const instagramLink = document.getElementById('instagram-link');
    const volverInicio = document.getElementById('volver-inicio');
    const crearCuentasLink = document.getElementById('crear-cuentas-link');
    const volverInstagram = document.getElementById('volver-instagram');
    const loginLink = document.getElementById('login-link');
    const volverLogin = document.getElementById('volver-login');
    const commentsLink = document.getElementById('comments-link');
    const volverInicioComments = document.getElementById('volver-inicio-comments');
    const instagramPanel = document.getElementById('instagram-panel');
    const createAccountsPanel = document.getElementById('create-accounts-panel');
    const loginPanel = document.getElementById('login-panel');
    const commentsPanel = document.getElementById('comments-panel');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    const automationInput = document.getElementById('automation-input');
    const sendBtn = document.getElementById('send-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const beastModeBtn = document.querySelector('.beast-mode');
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const sessionStatus = document.getElementById('session-status');
    const sessionStatusText = document.getElementById('session-status-text');
    const addAccountBtn = document.getElementById('add-account-btn');
    const manualUsername = document.getElementById('manual-username');
    const manualPassword = document.getElementById('manual-password');
    const searchUserBtn = document.getElementById('search-user-btn');
    const usernameSearch = document.getElementById('username-search');
    const userResult = document.getElementById('user-result');
    const systemStatusDot = document.getElementById('system-status-dot');
    const systemStatusText = document.getElementById('system-status-text');
    const cuentasActivasList = document.getElementById('cuentas-activas-list');
    const cancelBtn = document.getElementById('cancel-btn');
    const createBtn = document.getElementById('create-btn');
    const accountCountInput = document.getElementById('account-count');

    // Estado
    let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    let cuentasActivas = [];

    // Mostrar notificación
    function showNotification(message, isError = false) {
      notificationText.textContent = message;
      notification.style.background = isError 
        ? 'rgba(244, 67, 54, 0.9)' 
        : 'rgba(26, 26, 46, 0.9)';
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // Navegación entre paneles
    instagramLink.addEventListener('click', (e) => { e.preventDefault(); instagramPanel.classList.add('active'); });
    volverInicio.addEventListener('click', (e) => { e.preventDefault(); instagramPanel.classList.remove('active'); });
    crearCuentasLink.addEventListener('click', (e) => { e.preventDefault(); createAccountsPanel.classList.add('active'); instagramPanel.classList.remove('active'); });
    volverInstagram.addEventListener('click', (e) => { e.preventDefault(); createAccountsPanel.classList.remove('active'); instagramPanel.classList.add('active'); });
    loginLink.addEventListener('click', (e) => { e.preventDefault(); loginPanel.classList.add('active'); instagramPanel.classList.remove('active'); checkSessionStatus(); });
    volverLogin.addEventListener('click', (e) => { e.preventDefault(); loginPanel.classList.remove('active'); instagramPanel.classList.add('active'); });
    commentsLink.addEventListener('click', (e) => { e.preventDefault(); commentsPanel.classList.add('active'); instagramPanel.classList.remove('active'); });
    volverInicioComments.addEventListener('click', (e) => { e.preventDefault(); commentsPanel.classList.remove('active'); instagramPanel.classList.add('active'); });

    // Botones de acción
    sendBtn.addEventListener('click', () => {
      if (automationInput.value.trim()) showNotification(`Automatizando: "${automationInput.value}"`);
      automationInput.value = '';
    });

    refreshBtn.addEventListener('click', () => {
      refreshBtn.style.animation = 'rotate 1s linear';
      showNotification('Datos actualizados');
      setTimeout(() => refreshBtn.style.animation = '', 1000);
    });

    beastModeBtn.addEventListener('click', () => {
      beastModeBtn.innerHTML = '<i class="fas fa-paw"></i> ¡Activando Modo Bestia!';
      beastModeBtn.style.background = 'linear-gradient(135deg, #ff8c00, #ff0080)';
      setTimeout(() => {
        beastModeBtn.innerHTML = '<i class="fas fa-paw"></i> ¡Modo Bestia Activado!';
        beastModeBtn.style.background = 'linear-gradient(135deg, #00c9b7, #6e44ff)';
        showNotification('Modo Bestia activado');
      }, 1500);
    });

    // Conexión al backend
    async function checkBackendConnection() {
      try {
        const response = await fetch(`${API_URL}/health`);
        if (response.ok) {
          systemStatusDot.style.backgroundColor = 'var(--success)';
          systemStatusText.textContent = 'Conectado al backend | Sistema al 100%';
          return true;
        }
        throw new Error('Backend responded with error');
      } catch {
        systemStatusDot.style.backgroundColor = 'var(--error)';
        systemStatusText.textContent = 'Error de conexión con el backend';
        return false;
      }
    }

    // Funcionalidades de login
    async function checkSessionStatus() {
      try {
        const response = await fetch(`${API_URL}/estado-sesion`);
        const data = await response.json();
        if (data.status === 'activo') {
          isLoggedIn = true;
          localStorage.setItem('isLoggedIn', 'true');
          sessionStatus.className = 'status-indicator-panel status-active';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
          sessionStatusText.textContent = `✅ Sesión activa como @${data.usuario || 'krave'}`;
          loginForm.style.display = 'none';
          logoutBtn.classList.remove('hidden');
        } else {
          isLoggedIn = false;
          localStorage.setItem('isLoggedIn', 'false');
          sessionStatus.className = 'status-indicator-panel status-error';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
          sessionStatusText.textContent = '❌ No hay sesión activa';
          loginForm.style.display = 'block';
          logoutBtn.classList.add('hidden');
        }
        actualizarListaCuentasActivas();
      } catch (error) {
        isLoggedIn = false;
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = '❌ Error al verificar sesión';
        loginForm.style.display = 'block';
        logoutBtn.classList.add('hidden');
        showNotification('Error al verificar sesión', true);
      }
    }

    async function login() {
      const username = loginUsername.value.trim().replace('@', '');
      const password = loginPassword.value.trim();
      if (!username || !password) {
        showNotification('Por favor completa ambos campos', true);
        return;
      }
      try {
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesión...';
        loginBtn.disabled = true;
        const response = await fetch(`${API_URL}/iniciar-sesion`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username, contrasena: password })
        });
        const data = await response.json();
        if (data.exito) {
          isLoggedIn = true;
          localStorage.setItem('isLoggedIn', 'true');
          sessionStatus.className = 'status-indicator-panel status-active';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
          sessionStatusText.textContent = `✅ Sesión iniciada como @${data.usuario}`;
          loginForm.style.display = 'none';
          logoutBtn.classList.remove('hidden');
          showNotification(`Sesión iniciada como @${data.usuario}`);
        } else {
          throw new Error(data.mensaje || 'Error al iniciar sesión');
        }
      } catch (error) {
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = `❌ ${error.message}`;
        showNotification(`Error: ${error.message}`, true);
      } finally {
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesión';
        loginBtn.disabled = false;
      }
    }

    async function logout() {
      try {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cerrando...';
        logoutBtn.disabled = true;
        const response = await fetch(`${API_URL}/cerrar-sesion`, { method: 'GET' });
        const data = await response.json();
        if (data.exito) {
          isLoggedIn = false;
          localStorage.setItem('isLoggedIn', 'false');
          sessionStatus.className = 'status-indicator-panel status-error';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
          sessionStatusText.textContent = '❌ Sesión cerrada';
          loginForm.style.display = 'block';
          logoutBtn.classList.add('hidden');
          showNotification('Sesión cerrada correctamente');
        } else {
          throw new Error(data.mensaje || 'Error al cerrar sesión');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      } finally {
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Cerrar sesión';
        logoutBtn.disabled = false;
      }
    }

    async function addAccount() {
      const username = manualUsername.value.trim();
      const password = manualPassword.value.trim();
      if (!username || !password) {
        showNotification('Por favor completa ambos campos', true);
        return;
      }
      try {
        addAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        addAccountBtn.disabled = true;
        const response = await fetch(`${API_URL}/guardar-cuenta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username, contrasena: password })
        });
        const data = await response.json();
        if (data.exito) {
          showNotification(`Cuenta @${username} guardada exitosamente`);
          manualUsername.value = '';
          manualPassword.value = '';
          cuentasActivas.push({ username, status: 'activo', addedAt: new Date().toISOString() });
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al guardar la cuenta');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      } finally {
        addAccountBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cuenta';
        addAccountBtn.disabled = false;
      }
    }

    async function searchUser() {
      const username = usernameSearch.value.trim().replace('@', '');
      if (!username) {
        showNotification('Por favor ingresa un nombre de usuario', true);
        return;
      }
      if (!isLoggedIn) {
        showNotification('Debes iniciar sesión primero para buscar usuarios', true);
        return;
      }
      try {
        searchUserBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        searchUserBtn.disabled = true;
        const response = await fetch(`${API_URL}/buscar-usuario`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const userData = await response.json();
        document.getElementById('user-avatar').src = userData.foto || 'https://via.placeholder.com/150?text=Sin+imagen';
        document.getElementById('user-username').innerHTML = `@${userData.username}` + (userData.verificado ? '<span class="verified-tick"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="12" fill="#0095f6"/><path d="M9 12.5L11 14.5L15 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>' : '');
        document.getElementById('user-fullname').textContent = userData.nombre || 'Sin nombre';
        document.getElementById('user-posts').textContent = userData.publicaciones?.toLocaleString() || '0';
        document.getElementById('user-followers').textContent = userData.seguidores?.toLocaleString() || '0';
        document.getElementById('user-following').textContent = userData.seguidos?.toLocaleString() || '0';
        document.getElementById('user-bio-text').textContent = userData.biografia || 'Sin biografía disponible';
        document.getElementById('user-private').innerHTML = `<div class="status-dot-panel" style="background-color: ${userData.privado ? 'var(--warning)' : 'var(--success)'}"></div><span>Privado: ${userData.privado ? 'Sí' : 'No'}</span>`;
        document.getElementById('user-verified').innerHTML = `<div class="status-dot-panel" style="background-color: ${userData.verificado ? 'var(--success)' : 'var(--gray)'}"></div><span>Verificado: ${userData.verificado ? 'Sí' : 'No'}</span>`;
        document.getElementById('user-business').innerHTML = `<div class="status-dot-panel" style="background-color: ${userData.negocio ? 'var(--primary)' : 'var(--gray)'}"></div><span>Negocio: ${userData.negocio ? 'Sí' : 'No'}</span>`;
        userResult.style.display = 'block';
        showNotification(`Usuario @${userData.username} encontrado`);
      } catch (error) {
        showNotification(`Error: ${error.message || 'No se pudo encontrar el usuario'}`, true);
      } finally {
        searchUserBtn.innerHTML = '<i class="fas fa-search"></i> Buscar usuario';
        searchUserBtn.disabled = false;
      }
    }

    async function iniciarCreacionCuentas() {
      try {
        const cantidad = parseInt(accountCountInput.value);
        if (!cantidad || cantidad <= 0 || cantidad > 100) {
          showNotification('⚠️ Ingresa una cantidad válida (1-100)', true);
          return;
        }
        showNotification('Funcionalidad de creación pendiente de implementación completa');
      } catch (error) {
        showNotification('❌ Error iniciando creación de cuentas', true);
      }
    }

    async function actualizarListaCuentasActivas() {
      const lista = document.getElementById("cuentas-activas-list");
      if (!lista) return;

      try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        cuentasActivas = data.accounts.map(username => ({ username, status: SESSIONS[username] ? 'activo' : 'inactivo', addedAt: new Date().toISOString() }));

        if (cuentasActivas.length === 0) {
          lista.innerHTML = "<li>No hay cuentas activas aún</li>";
        } else {
          lista.innerHTML = "";
          cuentasActivas.forEach(acc => {
            const item = document.createElement("li");
            item.className = `status-${acc.status}`;

            const infoDiv = document.createElement("div");
            infoDiv.className = "cuenta-info";
            const statusDot = document.createElement("div");
            statusDot.className = "status-dot";
            infoDiv.appendChild(statusDot);
            infoDiv.appendChild(document.createTextNode(`@${acc.username}`));
            item.appendChild(infoDiv);

            const actionsDiv = document.createElement("div");
            actionsDiv.className = "cuenta-actions";
            const loginBtn = document.createElement("button");
            loginBtn.className = "cuenta-btn";
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            loginBtn.onclick = () => iniciarSesionCuenta(acc.username);
            actionsDiv.appendChild(loginBtn);

            const logoutBtn = document.createElement("button");
            logoutBtn.className = "cuenta-btn";
            logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
            logoutBtn.onclick = () => cerrarSesionCuenta(acc.username);
            actionsDiv.appendChild(logoutBtn);
            item.appendChild(actionsDiv);

            lista.appendChild(item);
          });
        }
      } catch (err) {
        lista.innerHTML = "<li>Error al cargar las cuentas</li>";
      }
    }

    async function iniciarSesionCuenta(username) {
      showNotification(`Iniciando sesión con @${username}...`);
      try {
        const response = await fetch(`${API_URL}/iniciar-sesion`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username, contrasena: prompt(`Ingresa la contraseña para @${username}:`) })
        });
        const data = await response.json();
        if (data.exito) {
          showNotification(`✅ Sesión iniciada con @${username}`);
          checkSessionStatus();
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al iniciar sesión');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      }
    }

    async function cerrarSesionCuenta(username) {
      showNotification(`Cerrando sesión con @${username}...`);
      try {
        const response = await fetch(`${API_URL}/cerrar-sesion`, { method: 'GET' });
        const data = await response.json();
        if (data.exito) {
          showNotification(`✅ Sesión cerrada con @${username}`);
          checkSessionStatus();
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al cerrar sesión');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      }
    }

    // Event Listeners
    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', logout);
    addAccountBtn.addEventListener('click', addAccount);
    searchUserBtn.addEventListener('click', searchUser);
    usernameSearch.addEventListener('keypress', (e) => e.key === 'Enter' && searchUser());
    createBtn.addEventListener('click', iniciarCreacionCuentas);

    // Inicialización
    document.addEventListener('DOMContentLoaded', async () => {
      showNotification('KraveAI listo - ¡Bienvenido!');
      await checkBackendConnection();
      setInterval(checkBackendConnection, 120000);
      if (loginPanel.classList.contains('active')) await checkSessionStatus();
    });

    // Toggle contraseña
    document.getElementById('togglePassword')?.addEventListener('click', () => {
      const pwd = document.getElementById('login-password');
      pwd.type = pwd.type === 'password' ? 'text' : 'password';
    });
  </script>
</body>
</html>