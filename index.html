<script>
  // Elementos DOM para navegación
  const instagramLink = document.getElementById('instagram-link');
  const volverInicio = document.getElementById('volver-inicio');
  const crearCuentasLink = document.getElementById('crear-cuentas-link');
  const volverInstagram = document.getElementById('volver-instagram');
  const sendBtn = document.getElementById('send-btn');
  const refreshBtn = document.getElementById('refresh-btn');
  const beastModeBtn = document.querySelector('.beast-mode');
  const instagramPanel = document.getElementById('instagram-panel');
  const createAccountsPanel = document.getElementById('create-accounts-panel');
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notification-text');
  const automationInput = document.getElementById('automation-input');
  
  // Elementos para el panel de Login
  const loginLink = document.getElementById('login-link');
  const volverLoginBtn = document.getElementById('volver-login');
  const loginPanel = document.getElementById('login-panel');
  const loginForm = document.getElementById('login-form');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const loginUsername = document.getElementById('login-username');
  const loginPassword = document.getElementById('login-password');
  const sessionStatus = document.getElementById('session-status');
  const sessionStatusText = document.getElementById('session-status-text');
  const searchUserBtn = document.getElementById('search-user-btn');
  const usernameSearch = document.getElementById('username-search');
  const userResult = document.getElementById('user-result');
  
  // Elementos DOM para creación de cuentas
  const cancelBtn = document.getElementById('cancel-btn');
  const createBtn = document.getElementById('create-btn');
  const accountCountInput = document.getElementById('account-count');
  const progressSection = document.getElementById('progress-section');
  const progressBar = document.getElementById('progress-bar');
  const createdCount = document.getElementById('created-count');
  const totalCount = document.getElementById('total-count');
  const accountsContainer = document.getElementById('accounts-container');
  const statusIndicator = document.getElementById('backend-status');
  const statusText = document.getElementById('status-text');
  const statusDot = document.querySelector('#backend-status .status-dot-panel');
  
  // Elementos para cuentas existentes
  const existingAccountsContainer = document.getElementById('existing-accounts-container');
  const filterButtons = document.querySelectorAll('.filter-btn');
  
  // Elementos de estado del sistema
  const systemStatusDot = document.getElementById('system-status-dot');
  const systemStatusText = document.getElementById('system-status-text');
  
  // Configuración de la API
  const API_URL = "https://api.kraveapi.xyz";
  
  // Estado de la creación
  let creationInProgress = false;
  let accountsCreated = 0;
  let totalAccounts = 0;
  let eventSource = null;
  let reconnectAttempts = 0;
  
  // Estado de sesión
  let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
  
  // Navegación entre paneles
  instagramLink.addEventListener('click', function(e) {
    e.preventDefault();
    instagramPanel.classList.add('active');
  });

  volverInicio.addEventListener('click', function(e) {
    e.preventDefault();
    instagramPanel.classList.remove('active');
  });

  crearCuentasLink.addEventListener('click', function(e) {
    e.preventDefault();
    createAccountsPanel.classList.add('active');
    cargarCuentasExistentes();
  });

  volverInstagram.addEventListener('click', function(e) {
    e.preventDefault();
    createAccountsPanel.classList.remove('active');
  });
  
  loginLink.addEventListener('click', function(e) {
    e.preventDefault();
    loginPanel.classList.add('active');
    checkSessionStatus();
    if (isLoggedIn) {
      logoutBtn.classList.remove('hidden');
    } else {
      logoutBtn.classList.add('hidden');
    }
  });

  volverLoginBtn.addEventListener('click', function() {
    loginPanel.classList.remove('active');
  });

  // Botón de enviar
  sendBtn.addEventListener('click', function() {
    if(automationInput.value.trim() !== '') {
      showNotification(`Automatizando: "${automationInput.value}"`);
      automationInput.value = '';
    }
  });

  // Botón de refresh
  refreshBtn.addEventListener('click', function() {
    this.style.animation = 'rotate 1s linear';
    showNotification('Datos actualizados');
    
    setTimeout(() => {
      this.style.animation = '';
    }, 1000);
  });

  // Botón Modo Bestia
  beastModeBtn.addEventListener('click', function() {
    this.innerHTML = '<i class="fas fa-paw"></i> ¡Activando Modo Bestia!';
    this.style.background = 'linear-gradient(135deg, #ff8c00, #ff0080)';
    
    setTimeout(() => {
      this.innerHTML = '<i class="fas fa-paw"></i> ¡Modo Bestia Activado!';
      this.style.background = 'linear-gradient(135deg, #00c9b7, #6e44ff)';
      showNotification('Modo Bestia activado');
    }, 1500);
  });

  // Mostrar notificación
  function showNotification(message) {
    notificationText.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // Manejar el envío con Enter
  automationInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendBtn.click();
    }
  });
  
  // ===== [ FUNCIONALIDAD DE LOGIN ] ===== //
  
  async function checkSessionStatus() {
    try {
      const response = await fetch(`${API_URL}/estado-sesion`);
      const data = await response.json();
      
      if (data.status === 'activo') {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        sessionStatus.className = 'status-indicator-panel status-active';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
        sessionStatusText.textContent = `✅ Sesión activa como @${data.usuario}`;
        loginForm.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        showNotification(`Sesión activa como @${data.usuario}`);
      } else {
        isLoggedIn = false;
        localStorage.setItem('isLoggedIn', 'false');
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = '❌ No hay sesión activa';
        loginForm.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
      }
    } catch (error) {
      isLoggedIn = false;
      localStorage.setItem('isLoggedIn', 'false');
      sessionStatus.className = 'status-indicator-panel status-error';
      sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
      sessionStatusText.textContent = '❌ Error al verificar sesión';
      loginForm.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      showNotification('Error al verificar sesión');
    }
  }

  async function login() {
    const username = loginUsername.value.trim().replace('@', '');
    const password = loginPassword.value.trim();
    
    if (!username || !password) {
      showNotification('Por favor completa ambos campos');
      return;
    }
    
    try {
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesión...';
      loginBtn.disabled = true;
      
      const response = await fetch(`${API_URL}/iniciar-sesion`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          usuario: username,
          contrasena: password
        })
      });
      
      const data = await response.json();
      
      if (data.exito) {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        sessionStatus.className = 'status-indicator-panel status-active';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
        sessionStatusText.textContent = `✅ Sesión iniciada como @${data.usuario}`;
        loginForm.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        showNotification(`Sesión iniciada como @${data.usuario}`);
      } else {
        throw new Error(data.mensaje || 'Error al iniciar sesión');
      }
    } catch (error) {
      sessionStatus.className = 'status-indicator-panel status-error';
      sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
      sessionStatusText.textContent = `❌ ${error.message}`;
      loginForm.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      showNotification(`Error: ${error.message}`);
    } finally {
      loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesión';
      loginBtn.disabled = false;
    }
  }

  async function logout() {
    try {
      logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cerrando...';
      logoutBtn.disabled = true;
      
      const response = await fetch(`${API_URL}/cerrar-sesion`);
      const data = await response.json();
      
      if (data.exito) {
        isLoggedIn = false;
        localStorage.setItem('isLoggedIn', 'false');
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = '❌ Sesión cerrada';
        loginForm.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        showNotification('Sesión cerrada correctamente');
      } else {
        throw new Error(data.mensaje || 'Error al cerrar sesión');
      }
    } catch (error) {
      showNotification(`Error: ${error.message}`);
    } finally {
      logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Cerrar sesión';
      logoutBtn.disabled = false;
    }
  }

  async function searchUser() {
    const username = usernameSearch.value.trim().replace('@', '');
    if (!username) {
      showNotification('Por favor ingresa un nombre de usuario');
      return;
    }
    
    if (!isLoggedIn) {
      showNotification('Debes iniciar sesión primero para buscar usuarios');
      return;
    }
    
    try {
      searchUserBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
      searchUserBtn.disabled = true;
      
      const response = await fetch(`${API_URL}/buscar-usuario?username=${username}`);
      const userData = await response.json();
      
      document.getElementById('user-avatar').src = userData.foto || 'https://via.placeholder.com/150?text=Sin+imagen';
      
      const usernameElement = document.getElementById('user-username');
      usernameElement.innerHTML = `@${userData.username}`;
      if (userData.verificado) {
        usernameElement.innerHTML += `
          <span class="verified-tick">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="12" fill="#0095f6"/>
              <path d="M9 12.5L11 14.5L15 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        `;
      }
      
      document.getElementById('user-fullname').textContent = userData.nombre || 'Sin nombre';
      document.getElementById('user-posts').textContent = userData.publicaciones?.toLocaleString() || '0';
      document.getElementById('user-followers').textContent = userData.seguidores?.toLocaleString() || '0';
      document.getElementById('user-following').textContent = userData.seguidos?.toLocaleString() || '0';
      document.getElementById('user-bio-text').textContent = userData.biografia || 'Sin biografía disponible';
      
      document.getElementById('user-private').innerHTML = `
        <div class="status-dot-panel" style="background-color: ${userData.privado ? 'var(--warning)' : 'var(--success)'}"></div>
        <span>Privado: ${userData.privado ? 'Sí' : 'No'}</span>
      `;
      
      document.getElementById('user-verified').innerHTML = `
        <div class="status-dot-panel" style="background-color: ${userData.verificado ? 'var(--success)' : 'var(--gray)'}"></div>
        <span>Verificado: ${userData.verificado ? 'Sí' : 'No'}</span>
      `;
      
      document.getElementById('user-business').innerHTML = `
        <div class="status-dot-panel" style="background-color: ${userData.negocio ? 'var(--primary)' : 'var(--gray)'}"></div>
        <span>Negocio: ${userData.negocio ? 'Sí' : 'No'}</span>
      `;
      
      userResult.style.display = 'block';
      showNotification(`Usuario @${userData.username} encontrado`);
      
    } catch (error) {
      console.error('Error buscando usuario:', error);
      showNotification(`Error: ${error.message || 'No se pudo encontrar el usuario'}`);
    } finally {
      searchUserBtn.innerHTML = '<i class="fas fa-search"></i> Buscar usuario';
      searchUserBtn.disabled = false;
    }
  }

  loginBtn.addEventListener('click', login);
  logoutBtn.addEventListener('click', logout);
  searchUserBtn.addEventListener('click', searchUser);
  
  usernameSearch.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchUser();
    }
  });
  
  // ===== [ FIN FUNCIONALIDAD DE LOGIN ] ===== //
  
  document.addEventListener('DOMContentLoaded', async function() {
    showNotification('KraveAI activo - Conectando al backend...');
    
    if (await checkBackendConnection()) {
      showNotification('Conexión con el backend establecida');
      await testTelegramConnection();
    } else {
      showNotification('⚠️ Error conectando con el backend');
    }
    
    setInterval(async () => {
      await checkBackendConnection();
      await testTelegramConnection();
    }, 120000);
    
    cargarCuentasExistentes();
  });
  
  async function checkBackendConnection() {
    try {
      const response = await fetch(`${API_URL}/health`);
      if (response.ok) {
        systemStatusDot.style.backgroundColor = 'var(--success)';
        systemStatusText.textContent = 'Conectado al backend | Sistema al 100%';
        return true;
      } else {
        throw new Error('Backend responded with error');
      }
    } catch (error) {
      systemStatusDot.style.backgroundColor = 'var(--error)';
      systemStatusText.textContent = 'Error de conexión con el backend';
      return false;
    }
  }
  
  async function testTelegramConnection() {
    try {
      const response = await fetch(`${API_URL}/test-telegram`);
      if (response.ok) {
        return true;
      } else {
        showNotification('⚠️ Error conectando con Telegram');
        return false;
      }
    } catch (error) {
      showNotification('⚠️ Error conectando con Telegram');
      return false;
    }
  }
  
  async function cargarCuentasExistentes() {
    try {
      const response = await fetch(`${API_URL}/cuentas`);
      if (!response.ok) throw new Error('Error al cargar cuentas');
      const cuentas = await response.json();

      existingAccountsContainer.innerHTML = '';

      if (cuentas.length === 0) {
        existingAccountsContainer.innerHTML = '<div class="account-item" style="justify-content:center; color:var(--gray);">No hay cuentas creadas</div>';
        return;
      }

      cuentas.forEach(cuenta => {
        const accountItem = document.createElement('div');
        accountItem.className = 'account-item fade-in';
        accountItem.innerHTML = `
          <div class="account-info">
            <div class="account-username">${cuenta.usuario || 'N/A'}</div>
            <div class="account-email">${cuenta.email || 'N/A'}</div>
            <div class="account-proxy">${cuenta.proxy ? cuenta.proxy.substring(0, 20) + '...' : 'N/A'}</div>
          </div>
          <div class="account-status ${cuenta.status === 'active' ? 'account-success' : 'account-error'}">
            ${cuenta.status === 'active' ? '<i class="fas fa-check-circle"></i> Activa' : '<i class="fas fa-exclamation-circle"></i> Inactiva'}
          </div>
        `;
        existingAccountsContainer.appendChild(accountItem);
      });
    } catch (error) {
      console.error('Error:', error);
      existingAccountsContainer.innerHTML = '<div class="account-item" style="justify-content:center; color:var(--error);">Error al cargar las cuentas</div>';
    }
  }

  // ===== [ FUNCIONALIDAD DE CREACIÓN DE CUENTAS ] ===== //

  createBtn.addEventListener('click', iniciarCreacionCuentas);

  async function iniciarCreacionCuentas() {
    const cantidad = parseInt(document.getElementById('account-count').value);
    if (!cantidad || cantidad <= 0) {
      alert('⚠️ Ingresa una cantidad válida');
      return;
    }

    // Mostrar progreso
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('created-count').textContent = '0';
    document.getElementById('total-count').textContent = cantidad;
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('accounts-container').innerHTML = '';

    let creadas = 0;

    const sse = new EventSource(`https://api.kraveapi.xyz/create-accounts-sse?count=${cantidad}`);

    sse.addEventListener("account-created", (event) => {
      const cuenta = JSON.parse(event.data);
      creadas++;

      const cuentaHTML = `
        <div class="account-item fade-in">
          <div class="account-info">
            <div class="account-username">${cuenta.usuario || cuenta.username}</div>
            <div class="account-email">${cuenta.email || "N/A"}</div>
            <div class="account-proxy">${cuenta.proxy || "sin proxy"}</div>
          </div>
          <div class="account-status account-success">
            <i class="fas fa-check-circle"></i> Creada
          </div>
        </div>
      `;
      document.getElementById('accounts-container').insertAdjacentHTML('beforeend', cuentaHTML);
      document.getElementById('created-count').textContent = creadas;
      document.getElementById('progress-bar').style.width = `${(creadas / cantidad) * 100}%`;
    });

    sse.addEventListener("error", (event) => {
      console.error("Error SSE:", event);
      alert("❌ Error creando cuentas");
    });

    sse.addEventListener("complete", () => {
      alert("✅ Proceso de creación finalizado");
      sse.close();
    });
  }

</script>
