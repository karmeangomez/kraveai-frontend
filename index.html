<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0b0b10" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="author" content="Karmean G√≥mez">
  <title>KRAVEAI ‚Äî Automation OS</title>
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="%237C5CFF"/><stop offset="100%" stop-color="%2300DBC1"/></linearGradient></defs><rect rx="14" width="64" height="64" fill="black"/><path d="M18 14h10v16l16-16h12L40 30l16 20H44L28 36v14H18V14z" fill="url(%23g)"/></svg>'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ================= TOKENS ================= */
    :root{
      --bg:#0b0b10; --elev:#111218; --card:#151722; --text:#ECEEF4; --muted:#9aa0a6; --line:#24263a;
      --accent:#7C5CFF; --accent2:#00DBC1; --success:#34d399; --warn:#ffb454; --err:#ff5f74;
      --glass:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.08);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --r:18px; --r-lg:22px;
      /* Device Farm sizing */
      --device-h: 220px;           /* altura por ‚Äúpantalla de tel√©fono‚Äù */
      --device-min-col: 180px;     /* ancho m√≠nimo de columna */
    }
    :root.light{
      --bg:#f6f7fb; --elev:#ffffff; --card:#ffffff; --text:#0B0D13; --muted:#68707b; --line:#e7e9ef;
      --glass:rgba(0,0,0,.04); --glass-2:rgba(0,0,0,.06); --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 15px/1.45 ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Inter, Roboto;
      -webkit-font-smoothing:antialiased;
      overscroll-behavior-y: none;
    }
    /* Aurora fondo sutil */
    .aurora{
      position:fixed; inset:-10% -20%; z-index:-1; filter:saturate(1.1) blur(36px); opacity:.5; pointer-events:none;
      background:
        radial-gradient(60% 40% at 85% 10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(45% 35% at 10% 0%, rgba(0,219,193,.25), transparent 70%),
        radial-gradient(40% 30% at 15% 85%, rgba(255,95,116,.18), transparent 70%);
      animation:aur 18s ease-in-out infinite alternate;
    }
    @keyframes aur{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(-2%,1%,0) scale(1.05)}}

    /* =============== APP CHROME =============== */
    .topbar{
      position:sticky; top:0; z-index:60;
      display:grid; grid-template-columns:auto 1fr auto auto; gap:8px; align-items:center;
      padding: calc(12px + env(safe-area-inset-top)) 14px 12px; /* safe area iOS */
      background: color-mix(in oklab, var(--elev) 90%, transparent);
      backdrop-filter:saturate(1.15) blur(16px);
      border-bottom:1px solid var(--line);
    }
    .brand-mini{ display:flex; align-items:center; gap:10px }
    .wordmark{ font-weight:900; letter-spacing:.16em; font-size:1.02rem }
    .wordmark.sm{ font-size:.95rem; letter-spacing:.14em }

    .status{
      justify-self:start; display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px;
      background:var(--glass); border:1px solid var(--line);
    }
    .status i{font-size:.6rem}
    .chip{
      width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
      background:var(--glass);border:1px solid var(--line); color:var(--muted);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .chip.glow{ box-shadow:0 0 0 0 rgba(124,92,255,.55); animation:pulseGlow 1.8s ease infinite }
    .chip:active{ transform:scale(.96) }
    @keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(124,92,255,.45)}70%{box-shadow:0 0 0 18px rgba(124,92,255,0)}100%{box-shadow:0 0 0 0 rgba(124,92,255,0)}}

    .screen{
      padding: 14px 16px calc(100px + env(safe-area-inset-bottom)); /* nada se tapa con la tabbar */
      max-width: 1200px;
      margin-inline: auto;
    }
    .section{ margin:12px 0 18px }
    .section h3{ margin:0 0 8px; font-size:1.05rem; display:flex; align-items:center; gap:10px; opacity:.95 }
    .muted{ color:var(--muted) }

    /* Hero */
    .hero{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .hero .brand{display:flex;gap:10px;align-items:center}
    .logo-badge{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 12px 26px rgba(124,92,255,.35), 0 10px 22px rgba(0,219,193,.18);
    }
    .k-logo{ width:28px;height:28px; filter: drop-shadow(0 2px 8px rgba(124,92,255,.35)); animation: logoPulse 4.2s ease-in-out infinite }
    .k-logo.sm{ width:22px;height:22px }
    @keyframes logoPulse {
      0% { filter: drop-shadow(0 2px 8px rgba(124,92,255,.35)); }
      50% { filter: drop-shadow(0 6px 18px rgba(124,92,255,.55)); }
      100% { filter: drop-shadow(0 2px 8px rgba(124,92,255,.35)); }
    }

    /* Tiles */
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)) }
    @media (min-width:700px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    @media (min-width:980px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }

    .card{
      background:linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, transparent), color-mix(in oklab, var(--card) 98%, transparent));
      border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow)
    }
    .tile{display:flex;align-items:center;gap:12px;padding:16px;cursor:pointer;position:relative;overflow:hidden;
      transition:transform .18s ease, box-shadow .2s ease, border-color .2s ease}
    .tile::before{content:"";position:absolute;inset:-40%;background:radial-gradient(60% 40% at 50% 10%,rgba(124,92,255,.08),transparent 60%);transform:translateY(30%);transition:opacity .25s ease;opacity:0}
    .tile:hover{ transform:translateY(-2px) } .tile:hover::before{opacity:1}
    .tile:active{ transform:translateY(0) scale(.98) }
    .tile .icon{ width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:var(--glass-2);border:1px solid var(--line) }
    .tile .label{ font-weight:600 }

    .input-wrap{ display:flex;align-items:center;gap:10px;border:1px solid var(--line); background:var(--glass); border-radius:14px; padding:10px 12px }
    .input-wrap input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:1rem}

    .btn{ border:1px solid var(--line); background:linear-gradient(180deg, color-mix(in oklab, var(--card) 94%, transparent), color-mix(in oklab, var(--card) 100%, transparent));
      color:var(--text); padding:12px 14px; border-radius:14px; font-weight:600; cursor:pointer; transition:transform .15s ease, box-shadow .2s ease}
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0b0b10; border:0;
      box-shadow:0 12px 36px rgba(124,92,255,.45),0 10px 28px rgba(0,219,193,.25) }
    .pill{ display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--glass);font-size:.9rem }

    /* Tab bar */
    .tabbar{ position:fixed; inset-inline:0; bottom:0; z-index:55; display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
      padding:8px 10px calc(8px + env(safe-area-inset-bottom)); background:color-mix(in oklab, var(--elev) 90%, transparent);
      border-top:1px solid var(--line); backdrop-filter:saturate(1.15) blur(16px) }
    .tab{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;border-radius:12px;padding:8px 6px;color:var(--muted);border:1px solid transparent}
    .tab.active{color:var(--text); background:var(--glass); border-color:var(--line)}
    .tab i{font-size:1.1rem}

    /* Panels deslizables */
    .panel{ position:fixed; inset:0; z-index:70; display:none }
    .panel.active{ display:block }
    .panel .inner{ height:100%; width:100%; background:var(--bg); animation:slide .25s ease; overflow:auto; -webkit-overflow-scrolling:touch; }
    @keyframes slide{ from{ transform:translateX(18px); opacity:0 } to{ transform:translateX(0); opacity:1 } }

    /* Service Center */
    .svc-grid{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)) }
    @media (min-width:700px){ .svc-grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .svc-card .title{ padding:16px; display:flex; gap:12px; align-items:center; font-weight:700 }
    .svc-card .hint{ padding:0 16px 14px; color:var(--muted); font-size:.9rem }
    .form{ display:grid; gap:10px }
    .row{ display:grid; gap:8px }
    .row label{ color:var(--muted); font-size:.9rem }
    .ctrl{ border:1px solid var(--line); background:var(--glass); color:var(--text); border-radius:12px; padding:12px; outline:none }
    textarea.ctrl{ min-height:96px; resize:vertical }

    /* Device Farm */
    .farm-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(var(--device-min-col), 1fr)); }
    .device{ display:grid; gap:10px; padding:12px }
    .device-head{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .chips{ display:flex; gap:6px; flex-wrap:wrap }
    .chip-b{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:var(--glass); font-size:.8rem }
    .device-screen{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#000;
      height: var(--device-h);
      position:relative;
    }
    .device-screen video,.device-screen img{ width:100%; height:100%; object-fit:cover; display:block }
    .device-screen .overlay{ position:absolute; left:8px; top:8px; display:flex; gap:6px }
    .actions{ display:flex; gap:8px; justify-content:flex-end }

    /* Cuentas */
    .list{ display:grid; gap:10px }
    .list-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border:1px solid var(--line); border-radius:12px; background:var(--glass) }

    /* Toast + Firma */
    .toast{ position:fixed; top:14px; left:50%; transform:translateX(-50%); background:color-mix(in oklab,var(--elev) 96%, transparent);
      border:1px solid var(--line); border-radius:999px; padding:10px 14px; z-index:90; display:none; box-shadow:var(--shadow) }
    .toast.show{ display:block; animation:fade .25s ease } @keyframes fade{ from{opacity:0; transform:translate(-50%,-8px)} to{opacity:1; transform:translate(-50%,0)} }
    .credit{ position:fixed; right:12px; bottom:calc(58px + env(safe-area-inset-bottom)); z-index:80; font-size:.9rem; color:var(--muted);
      background:var(--glass); border:1px solid var(--line); border-radius:999px; padding:8px 12px; backdrop-filter:blur(6px); box-shadow:0 8px 18px rgba(0,0,0,.25) }
    .credit::before{content:"‚òÖ";margin-right:8px;color:var(--accent)}
  </style>
</head>
<body>
  <!-- ===== Sprite de logo KRAVEAI ===== -->
  <svg width="0" height="0" style="position:absolute" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="g-krave" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#7C5CFF"/><stop offset="100%" stop-color="#00DBC1"/>
      </linearGradient>
      <symbol id="logo-krave" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="30" fill="url(#g-krave)" opacity="0.14"/>
        <path d="M18 14h10v16l16-16h12L40 30l16 20H44L28 36v14H18V14z" fill="url(#g-krave)"/>
      </symbol>
    </defs>
  </svg>

  <div class="aurora"></div>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand-mini">
      <svg viewBox="0 0 64 64" class="k-logo sm"><use href="#logo-krave"/></svg>
      <span class="wordmark sm">KRAVEAI</span>
    </div>
    <div class="status"><i class="fa-solid fa-circle" style="color:#E34D5A"></i><span id="status-text">Error de conexi√≥n</span></div>
    <button class="chip glow" id="notif-btn" title="Notificaciones"><i class="fa-regular fa-bell"></i></button>
    <button class="chip" id="theme-btn" title="Tema"><i class="fa-solid fa-moon"></i></button>
  </header>

  <!-- HOME -->
  <main id="home" class="screen">
    <section class="section hero">
      <div class="brand">
        <div class="logo-badge">
          <svg viewBox="0 0 64 64" class="k-logo"><use href="#logo-krave"/></svg>
        </div>
        <div>
          <div class="wordmark">KRAVEAI</div>
          <div class="muted" style="font-size:.9rem">Automation Operating System</div>
        </div>
      </div>
      <div class="pill"><i class="fa-regular fa-circle-check" style="color:var(--success)"></i> Listo para ejecutar</div>
    </section>

    <section class="section">
      <h3><i class="fa-solid fa-hashtag"></i> Redes sociales</h3>
      <div class="grid" id="social-grid">
        <div class="card tile" data-platform="instagram"><div class="icon"><i class="fa-brands fa-instagram" style="color:#E1306C"></i></div><div><div class="label">Instagram</div><small class="muted">Acciones r√°pidas</small></div></div>
        <div class="card tile" data-platform="tiktok"><div class="icon"><i class="fa-brands fa-tiktok" style="color:#69C9D0"></i></div><div><div class="label">TikTok</div><small class="muted">Vistas ¬∑ Likes</small></div></div>
        <div class="card tile" data-platform="youtube"><div class="icon"><i class="fa-brands fa-youtube" style="color:#FF0000"></i></div><div><div class="label">YouTube</div><small class="muted">Vistas ¬∑ Comentarios</small></div></div>
        <div class="card tile" data-platform="threads"><div class="icon"><i class="fa-brands fa-threads" style="color:#fff"></i></div><div><div class="label">Threads</div><small class="muted">Respuestas</small></div></div>
        <div class="card tile" data-platform="x"><div class="icon"><i class="fa-brands fa-x-twitter" style="color:#fff"></i></div><div><div class="label">X</div><small class="muted">Likes ¬∑ Reposts</small></div></div>
        <div class="card tile" data-platform="facebook"><div class="icon"><i class="fa-brands fa-facebook" style="color:#1877F2"></i></div><div><div class="label">Facebook</div><small class="muted">Reacciones</small></div></div>
        <div class="card tile" data-platform="linkedin"><div class="icon"><i class="fa-brands fa-linkedin" style="color:#0A66C2"></i></div><div><div class="label">LinkedIn</div></div></div>
        <div class="card tile" data-platform="snapchat"><div class="icon"><i class="fa-brands fa-snapchat" style="color:#FFFC00"></i></div><div><div class="label">Snapchat</div></div></div>
        <div class="card tile" data-platform="discord"><div class="icon"><i class="fa-brands fa-discord" style="color:#5865F2"></i></div><div><div class="label">Discord</div></div></div>
        <div class="card tile" data-platform="telegram"><div class="icon"><i class="fa-brands fa-telegram" style="color:#0088cc"></i></div><div><div class="label">Telegram</div></div></div>
        <div class="card tile" data-platform="whatsapp"><div class="icon"><i class="fa-brands fa-whatsapp" style="color:#25D366"></i></div><div><div class="label">WhatsApp</div></div></div>
        <div class="card tile" data-platform="twitch"><div class="icon"><i class="fa-brands fa-twitch" style="color:#9146FF"></i></div><div><div class="label">Twitch</div></div></div>
        <div class="card tile" data-platform="reddit"><div class="icon"><i class="fa-brands fa-reddit" style="color:#FF4500"></i></div><div><div class="label">Reddit</div></div></div>
        <div class="card tile" data-platform="spotify"><div class="icon"><i class="fa-brands fa-spotify" style="color:#1DB954"></i></div><div><div class="label">Spotify</div></div></div>
      </div>
    </section>

    <section class="section">
      <h3><i class="fa-solid fa-bolt"></i> Automatizaci√≥n</h3>
      <div class="input-wrap">
        <i class="fa-solid fa-wand-magic-sparkles" style="color:var(--muted)"></i>
        <input id="automation-input" placeholder="¬øQu√© quieres automatizar hoy?">
        <button class="btn btn-primary" id="automation-run"><i class="fa-solid fa-paper-plane"></i> Ejecutar</button>
      </div>
      <div class="pill" style="margin-top:10px"><i class="fa-solid fa-circle" style="color:var(--success);font-size:.65rem"></i> Sin acciones en curso</div>
    </section>

    <section class="section">
      <div class="card tile" id="open-farm"><div class="icon"><i class="fa-solid fa-mobile-screen-button"></i></div><div class="label">Ver Device Farm</div></div>
    </section>

    <section class="section">
      <h3><i class="fa-solid fa-users"></i> Clientes recientes</h3>
      <div class="grid">
        <div class="card tile"><div class="icon"><i class="fa-brands fa-instagram" style="color:#E1306C"></i></div><div class="label">@arianaoficial</div><span class="muted">Instagram</span></div>
        <div class="card tile"><div class="icon"><i class="fa-brands fa-youtube" style="color:#FF0000"></i></div><div class="label">@plenkay</div><span class="muted">YouTube</span></div>
      </div>
    </section>
  </main>

  <!-- Firma siempre visible -->
  <div class="credit">Created by Karmean G√≥mez</div>

  <!-- SERVICE CENTER -->
  <div class="panel" id="svc-panel">
    <div class="inner screen">
      <div class="section" style="display:flex;align-items:center;justify-content:space-between">
        <h3 id="svc-title"><i class="fa-solid fa-wand-magic-sparkles"></i> Servicios</h3>
        <button class="btn" id="svc-back"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      </div>
      <div class="svc-grid" id="svc-grid"></div>

      <div class="card" id="svc-form-card" style="display:none;margin-top:12px;padding:16px">
        <div class="section"><h3 id="svc-form-title"><i class="fa-solid fa-sliders"></i> Configurar</h3></div>
        <form class="form" id="svc-form"></form>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn btn-primary" id="svc-run"><i class="fa-solid fa-play"></i> Ejecutar</button>
          <button class="btn" id="svc-cancel">Cancelar</button>
        </div>
        <div id="svc-kpis" style="display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- DEVICE FARM -->
  <div class="panel" id="farm-panel">
    <div class="inner screen">
      <div class="section" style="display:flex;align-items:center;justify-content:space-between">
        <h3><i class="fa-solid fa-mobile-screen-button"></i> Device Farm</h3>
        <button class="btn" id="farm-back"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      </div>

      <!-- Toolbar de zoom -->
      <div class="section" style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:-6px">
        <span class="muted">Zoom</span>
        <button class="btn" id="zoom-out">‚Äì</button>
        <button class="btn" id="zoom-in">+</button>
      </div>

      <p class="muted">Monitorea m√∫ltiples dispositivos en tiempo real.</p>
      <div class="farm-grid" id="farm-grid"></div>
    </div>
  </div>

  <!-- CUENTAS -->
  <div class="panel" id="accounts-panel">
    <div class="inner screen">
      <div class="section" style="display:flex;align-items:center;justify-content:space-between">
        <h3><i class="fa-solid fa-users"></i> Cuentas</h3>
        <button class="btn" id="acc-back"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      </div>

      <div class="card" style="padding:16px">
        <div class="section"><h3><i class="fa-solid fa-key"></i> Sesi√≥n</h3></div>
        <div id="session-status" class="pill"><i class="fa-solid fa-circle" style="color:var(--err);font-size:.65rem"></i><span id="session-status-text">No hay sesi√≥n</span></div>
        <div class="form" id="login-form" style="margin-top:12px">
          <div class="row"><label>Usuario</label><input id="login-username" class="ctrl" placeholder="@usuario"></div>
          <div class="row"><label>Contrase√±a</label><input id="login-password" class="ctrl" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" id="login-btn">Iniciar sesi√≥n</button>
            <button class="btn" id="logout-btn">Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="card" style="padding:16px; margin-top:12px">
        <div class="section"><h3><i class="fa-solid fa-user-plus"></i> Agregar cuenta manual</h3></div>
        <div class="form">
          <div class="row"><label>Usuario</label><input id="manual-username" class="ctrl" placeholder="@usuario"></div>
          <div class="row"><label>Contrase√±a</label><input id="manual-password" class="ctrl" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
          <button class="btn btn-primary" id="add-account-btn">Guardar Cuenta</button>
        </div>
      </div>

      <div class="card" style="padding:16px; margin-top:12px">
        <div class="section"><h3><i class="fa-solid fa-list-check"></i> Cuentas activas</h3></div>
        <div id="active-accounts">Cargando‚Ä¶</div>
      </div>

      <div class="card" style="padding:16px; margin-top:12px">
        <div class="section"><h3><i class="fa-solid fa-magnifying-glass"></i> Buscar usuario (Instagram)</h3></div>
        <div class="form">
          <div class="row"><label>@usuario</label><input id="username-search" class="ctrl" placeholder="@username"></div>
          <button class="btn" id="search-user-btn">Buscar</button>
        </div>
        <div id="user-result" style="display:none;margin-top:12px">
          <div style="display:flex;align-items:center;gap:12px">
            <img id="user-avatar" style="width:64px;height:64px;border-radius:12px;border:1px solid var(--line);object-fit:cover" alt="">
            <div>
              <div style="font-weight:700" id="user-username"></div>
              <div class="muted" id="user-fullname"></div>
            </div>
          </div>
          <div class="list" style="grid-template-columns:repeat(3,1fr);margin-top:10px">
            <div class="list-item"><div class="muted">Posts</div><div id="user-posts">0</div></div>
            <div class="list-item"><div class="muted">Seguidores</div><div id="user-followers">0</div></div>
            <div class="list-item"><div class="muted">Siguiendo</div><div id="user-following">0</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AJUSTES -->
  <div class="panel" id="settings-panel">
    <div class="inner screen">
      <div class="section" style="display:flex;align-items:center;justify-content:space-between">
        <h3><i class="fa-solid fa-gear"></i> Ajustes</h3>
        <button class="btn" id="set-back"><i class="fa-solid fa-arrow-left"></i> Volver</button>
      </div>
      <div class="card" style="padding:16px">
        <div class="section"><h3><i class="fa-solid fa-wand-magic-sparkles"></i> Apariencia</h3></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="toggle-theme"><i class="fa-solid fa-sun"></i> Alternar tema</button>
          <button class="btn" id="toggle-aurora"><i class="fa-regular fa-lightbulb"></i> Aurora on/off</button>
          <button class="btn" id="bigger-tiles"><i class="fa-solid fa-maximize"></i> Tiles grandes</button>
          <button class="btn" id="smaller-tiles"><i class="fa-solid fa-minimize"></i> Tiles compactas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB BAR -->
  <nav class="tabbar">
    <button class="tab active" data-tab="home"><i class="fa-solid fa-house"></i><span style="font-size:.8rem">Inicio</span></button>
    <button class="tab" data-tab="accounts"><i class="fa-solid fa-users"></i><span style="font-size:.8rem">Cuentas</span></button>
    <button class="tab" data-tab="actions"><i class="fa-solid fa-screwdriver-wrench"></i><span style="font-size:.8rem">Acciones</span></button>
    <button class="tab" data-tab="farm"><i class="fa-solid fa-mobile-screen-button"></i><span style="font-size:.8rem">Farm</span></button>
    <button class="tab" data-tab="settings"><i class="fa-solid fa-gear"></i><span style="font-size:.8rem">Ajustes</span></button>
  </nav>

  <!-- TOAST -->
  <div class="toast" id="toast"><span id="toast-text"></span></div>

  <script>
    /* ===== Config ===== */
    const API_URL = "https://api.kraveapi.xyz";

    /* ===== Tema ===== */
    const themeBtn=document.getElementById('theme-btn');
    (function initTheme(){
      const t=localStorage.getItem('krave.theme');
      if(t==='light') document.documentElement.classList.add('light');
      themeBtn.querySelector('i').className = document.documentElement.classList.contains('light') ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    })();
    themeBtn.addEventListener('click',toggleTheme);
    document.getElementById('toggle-theme')?.addEventListener('click',toggleTheme);
    function toggleTheme(){
      document.documentElement.classList.toggle('light');
      const light=document.documentElement.classList.contains('light');
      themeBtn.querySelector('i').className = light ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      localStorage.setItem('krave.theme', light?'light':'dark');
    }
    // aurora toggle
    document.getElementById('toggle-aurora')?.addEventListener('click',()=>{
      const a=document.querySelector('.aurora'); a.style.display = (a.style.display==='none'?'block':'none');
    });
    // tiles size
    document.getElementById('bigger-tiles')?.addEventListener('click',()=>document.documentElement.style.setProperty('--r','22px'));
    document.getElementById('smaller-tiles')?.addEventListener('click',()=>document.documentElement.style.setProperty('--r','12px'));

    /* ===== Toast ===== */
    function toast(msg, err=false){
      const t=document.getElementById('toast'), s=document.getElementById('toast-text');
      s.textContent=msg; t.style.borderColor = err?'var(--err)':'var(--line)';
      t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2300);
    }

    /* ===== Health badge ===== */
    async function checkHealth(){
      try{
        const r=await fetch(`${API_URL}/health`,{credentials:'include'});
        document.getElementById('status-text').textContent = r.ok?'Conectado':'Error de conexi√≥n';
      }catch{ document.getElementById('status-text').textContent='Error de conexi√≥n'; }
    }
    checkHealth(); setInterval(checkHealth,120000);

    /* ===== Service Center ===== */
    const SERVICES={
      instagram:{label:'Instagram',actions:{
        comentarios:{label:'Comentarios masivos',icon:'fa-regular fa-comment',endpoint:`${API_URL}/instagram/comentarios`,fields:[
          {key:'url',label:'URL del Post',type:'text',required:true,placeholder:'https://www.instagram.com/p/Cxxxxx/'},
          {key:'cantidad',label:'Cantidad',type:'number',min:1,max:200,value:30},
          {key:'modo',label:'Modo',type:'select',options:[{v:'auto',t:'Auto (imagen)'},{v:'personalizado',t:'Personalizado'},{v:'manual',t:'Manual'}]},
          {key:'comentarios',label:'Comentarios (uno por l√≠nea)',type:'textarea',showIf:{field:'modo',equals:'manual'}},
          {key:'apodo',label:'Apodo',type:'text'},{key:'estilo',label:'Estilo',type:'text',placeholder:'fitness, guapo‚Ä¶'},
          {key:'actividad',label:'Actividad',type:'text',placeholder:'entrenador personal'}
        ]},
        likes:{label:'Likes',icon:'fa-regular fa-heart',endpoint:`${API_URL}/instagram/likes`,fields:[
          {key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:1,max:500,value:50}
        ]},
        seguidores:{label:'Seguidores',icon:'fa-solid fa-user-plus',endpoint:`${API_URL}/instagram/seguidores`,fields:[
          {key:'usuario',label:'Usuario objetivo',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:1,max:1000,value:100}
        ]},
        vistas:{label:'Vistas',icon:'fa-regular fa-eye',endpoint:`${API_URL}/instagram/vistas`,fields:[
          {key:'url',label:'URL del Reel/Video',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:50000,value:1000}
        ]}
      }},
      tiktok:{label:'TikTok',actions:{
        vistas:{label:'Vistas',icon:'fa-regular fa-eye',endpoint:`${API_URL}/tiktok/vistas`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:100000,value:5000}]},
        likes:{label:'Likes',icon:'fa-regular fa-heart',endpoint:`${API_URL}/tiktok/likes`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:100000,value:1000}]},
        seguidores:{label:'Seguidores',icon:'fa-solid fa-user-plus',endpoint:`${API_URL}/tiktok/seguidores`,fields:[{key:'usuario',label:'Usuario objetivo',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:10000,value:300}]}
      }},
      youtube:{label:'YouTube',actions:{
        vistas:{label:'Vistas',icon:'fa-regular fa-eye',endpoint:`${API_URL}/youtube/vistas`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:500000,value:10000}]},
        likes:{label:'Likes',icon:'fa-regular fa-thumbs-up',endpoint:`${API_URL}/youtube/likes`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:10,max:100000,value:500}]},
        comentarios:{label:'Comentarios',icon:'fa-regular fa-comment',endpoint:`${API_URL}/youtube/comentarios`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'comentarios',label:'Comentarios',type:'textarea',required:true}]}
      }},
      x:{label:'X (Twitter)',actions:{
        likes:{label:'Me gusta',icon:'fa-regular fa-heart',endpoint:`${API_URL}/x/likes`,fields:[{key:'url',label:'URL del post',type:'text',required:true}]},
        retweets:{label:'Reposts',icon:'fa-solid fa-retweet',endpoint:`${API_URL}/x/retweets`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:1,max:500,value:50}]},
        follows:{label:'Seguir cuentas',icon:'fa-solid fa-user-plus',endpoint:`${API_URL}/x/seguidores`,fields:[{key:'usuario',label:'Usuario objetivo',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:1,max:1000,value:100}]}
      }},
      facebook:{label:'Facebook',actions:{
        likes:{label:'Reacciones',icon:'fa-regular fa-thumbs-up',endpoint:`${API_URL}/facebook/reacciones`,fields:[{key:'url',label:'URL del post',type:'text',required:true},{key:'tipo',label:'Tipo',type:'select',options:[{v:'like',t:'üëç Like'},{v:'love',t:'‚ù§Ô∏è Love'},{v:'care',t:'ü•∞ Care'}]}]},
        comentarios:{label:'Comentarios',icon:'fa-regular fa-comment',endpoint:`${API_URL}/facebook/comentarios`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'comentarios',label:'Comentarios',type:'textarea',required:true}]}
      }},
      threads:{label:'Threads',actions:{
        likes:{label:'Likes',icon:'fa-regular fa-heart',endpoint:`${API_URL}/threads/likes`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'cantidad',label:'Cantidad',type:'number',min:1,max:1000,value:100}]},
        comentarios:{label:'Respuestas',icon:'fa-regular fa-comment',endpoint:`${API_URL}/threads/respuestas`,fields:[{key:'url',label:'URL',type:'text',required:true},{key:'comentarios',label:'Respuestas (una por l√≠nea)',type:'textarea'}]}
      }}
    };

    const svcPanel=document.getElementById('svc-panel');
    const svcGrid=document.getElementById('svc-grid');
    const svcFormCard=document.getElementById('svc-form-card');
    const svcForm=document.getElementById('svc-form');
    const svcRun=document.getElementById('svc-run');
    let CURRENT_ENDPOINT=null;

    function openServiceCenter(platform){
      const def=SERVICES[platform]; if(!def){ toast('Plataforma no soportada a√∫n',true); return; }
      document.getElementById('svc-title').innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> ${def.label}`;
      svcPanel.classList.add('active'); svcGrid.innerHTML=''; svcFormCard.style.display='none';
      Object.values(def.actions).forEach(cfg=>{
        const el=document.createElement('div'); el.className='card svc-card';
        el.innerHTML=`<div class="title"><i class="${cfg.icon}"></i>${cfg.label}</div><div class="hint">${cfg.endpoint.replace(API_URL,'')}</div>`;
        el.addEventListener('click',()=>openAction(cfg)); svcGrid.appendChild(el);
      });
    }
    function openAction(cfg){
      CURRENT_ENDPOINT=cfg.endpoint; svcFormCard.style.display='block';
      document.getElementById('svc-form-title').innerHTML=`<i class="fa-solid fa-sliders"></i> ${cfg.label}`;
      svcForm.innerHTML='';
      (cfg.fields||[]).forEach(f=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<label>${f.label}</label>`;
        let el;
        if(f.type==='textarea'){ el=document.createElement('textarea'); el.className='ctrl'; el.name=f.key; el.placeholder=f.placeholder||''; el.required=!!f.required; }
        else if(f.type==='select'){ el=document.createElement('select'); el.className='ctrl'; el.name=f.key; (f.options||[]).forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; el.appendChild(op); }); }
        else { el=document.createElement('input'); el.className='ctrl'; el.type=f.type||'text'; el.name=f.key; if(f.value!=null) el.value=f.value; if(f.min!=null) el.min=f.min; if(f.max!=null) el.max=f.max; el.placeholder=f.placeholder||''; el.required=!!f.required; }
        if(f.showIf){ el.dataset.dep=f.showIf.field; el.dataset.depval=f.showIf.equals; }
        row.appendChild(el); svcForm.appendChild(row);
      });
      applyDeps(); svcForm.querySelectorAll('select,input').forEach(i=>i.addEventListener('change',applyDeps));
      function applyDeps(){
        const st=Object.fromEntries(new FormData(svcForm).entries());
        [...svcForm.querySelectorAll('[data-dep]')].forEach(el=>{
          const row=el.closest('.row'); if(!row) return;
          row.style.display = (st[el.dataset.dep]===el.dataset.depval) ? 'grid' : 'none';
        });
      }
    }
    document.getElementById('svc-back').addEventListener('click',()=>svcPanel.classList.remove('active'));
    document.getElementById('svc-cancel').addEventListener('click',(e)=>{e.preventDefault();svcFormCard.style.display='none';});
    document.getElementById('svc-run').addEventListener('click',async (e)=>{
      e.preventDefault(); if(!CURRENT_ENDPOINT) return;
      const payload=Object.fromEntries(new FormData(svcForm).entries());
      try{
        svcRun.disabled=true; svcRun.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Ejecutando‚Ä¶';
        const r=await fetch(CURRENT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});
        const data=await r.json().catch(()=>({status:'ok'}));
        toast(data.message || 'Tarea lanzada');
        const k=document.getElementById('svc-kpis'); k.innerHTML='';
        if(data.kpis) Object.entries(data.kpis).forEach(([key,val])=>{
          const c=document.createElement('div'); c.className='card'; c.style.padding='12px';
          c.innerHTML=`<div class="muted">${key}</div><div style="font-weight:700">${val}</div>`; k.appendChild(c);
        });
      }catch{ toast('Error al ejecutar servicio',true) }
      finally{ svcRun.disabled=false; svcRun.innerHTML='<i class="fa-solid fa-play"></i> Ejecutar'; }
    });

    // Social tiles ‚Üí Service Center
    document.getElementById('social-grid').addEventListener('click',(e)=>{
      const tile=e.target.closest('.tile[data-platform]'); if(!tile) return; openServiceCenter(tile.dataset.platform);
    });

    /* ===== Device Farm ===== */
    const farmPanel=document.getElementById('farm-panel');
    const farmGrid=document.getElementById('farm-grid');
    document.getElementById('open-farm').addEventListener('click',()=>{ farmPanel.classList.add('active'); loadDevices(); });
    document.querySelector('[data-tab="farm"]').addEventListener('click',()=>{ farmPanel.classList.add('active'); loadDevices(); });
    document.getElementById('farm-back').addEventListener('click',()=>farmPanel.classList.remove('active'));
    let sse=null;

    // Zoom
    const zoomIn = document.getElementById('zoom-in');
    const zoomOut = document.getElementById('zoom-out');
    function setDeviceHeight(px){ document.documentElement.style.setProperty('--device-h', px + 'px'); }
    function getDeviceHeight(){ return parseInt(getComputedStyle(document.documentElement).getPropertyValue('--device-h')) || 220; }
    zoomIn?.addEventListener('click', ()=> setDeviceHeight(Math.min(getDeviceHeight()+40, 420)));
    zoomOut?.addEventListener('click', ()=> setDeviceHeight(Math.max(getDeviceHeight()-40, 140)));

    async function loadDevices(){
      try{
        const r=await fetch(`${API_URL}/devices`,{credentials:'include'}); const list=await r.json();
        renderDevices(list||[]); attachSSE();
      }catch{ toast('No se pudo cargar la farm',true) }
    }
    function renderDevices(list){ farmGrid.innerHTML=''; list.forEach(d=> farmGrid.appendChild(deviceCard(d))); }
    function deviceCard(d){
      const card=document.createElement('div'); card.className='card device'; card.dataset.id=d.id;
      const head=document.createElement('div'); head.className='device-head';
      head.innerHTML=`<div>${d.emoji||'üì±'} <strong>${d.name||d.model||'Device'}</strong> ¬∑ ${d.platform||''}</div>`;
      const chips=document.createElement('div'); chips.className='chips';
      chips.innerHTML=`<span class="chip-b">${d.status||'idle'}</span>${d.ip?`<span class="chip-b">${d.ip}</span>`:''}`;
      head.appendChild(chips);

      const screen=document.createElement('div'); screen.className='device-screen';
      const overlay=document.createElement('div'); overlay.className='overlay'; overlay.innerHTML=`<span class="chip-b">${d.task||'Idle'}</span>`;
      const vid=document.createElement('video'); vid.autoplay=true; vid.muted=true; vid.playsInline=true; vid.controls=false; vid.style.display='none';
      const img=document.createElement('img'); if(d.mjpeg_url) img.src=d.mjpeg_url; img.alt='stream';
      screen.append(overlay,vid,img);

      const actions=document.createElement('div'); actions.className='actions';
      actions.append(btn('Iniciar',()=>ctrl(d.id,'start')), btn('Detener',()=>ctrl(d.id,'stop')), btn('Pantalla completa',()=>screen.requestFullscreen && screen.requestFullscreen(), true));
      card.append(head,screen,actions);

      if(d.webrtc) openStream(d.id,vid,img);
      return card;
    }
    function btn(t,fn,ghost=false){ const b=document.createElement('button'); b.className='btn'+(ghost?'':' btn-primary'); b.textContent=t; b.onclick=fn; return b }
    async function ctrl(id,action){
      try{
        const r=await fetch(`${API_URL}/devices/${id}/control`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({action})});
        const data=await r.json(); toast(data.message||'OK');
      }catch{ toast('Error enviando comando',true) }
    }
    function attachSSE(){
      try{
        if(sse) sse.close();
        sse=new EventSource(`${API_URL}/devices/subscribe`,{withCredentials:true});
        sse.onmessage=(ev)=>{ try{ const m=JSON.parse(ev.data||'{}'); if(m.type==='device.update') updateDevice(m.payload) }catch{} };
      }catch{}
    }
    function updateDevice(d){
      const card=farmGrid.querySelector(`[data-id="${d.id}"]`);
      if(!card){ farmGrid.appendChild(deviceCard(d)); return; }
      card.querySelector('.device-head div').innerHTML = `${d.emoji||'üì±'} <strong>${d.name||d.model||'Device'}</strong> ¬∑ ${d.platform||''}`;
      card.querySelector('.chips').innerHTML = `<span class="chip-b">${d.status||'idle'}</span>${d.ip?`<span class="chip-b">${d.ip}</span>`:''}`;
      card.querySelector('.overlay').innerHTML = `<span class="chip-b">${d.task||'Idle'}</span>`;
      if(d.mjpeg_url){ const im=card.querySelector('img'); if(im && im.src!==d.mjpeg_url) im.src=d.mjpeg_url; }
      if(d.webrtc){ const v=card.querySelector('video'); const im=card.querySelector('img'); openStream(d.id,v,im); }
    }
    async function openStream(id,video,img){
      try{
        const pc=new RTCPeerConnection(); pc.ontrack=(e)=>{ video.srcObject=e.streams[0]; video.style.display='block'; if(img) img.style.display='none'; };
        const offer=await pc.createOffer({offerToReceiveVideo:true}); await pc.setLocalDescription(offer);
        const r=await fetch(`${API_URL}/devices/${id}/stream/webrtc`,{method:'POST',headers:{'Content-Type':'application/sdp'},credentials:'include',body:offer.sdp});
        const answer=await r.text(); await pc.setRemoteDescription({type:'answer',sdp:answer});
      }catch{/* fallback MJPEG */}
    }

    /* ===== Cuentas ===== */
    const accPanel=document.getElementById('accounts-panel');
    document.getElementById('acc-back').addEventListener('click',()=>accPanel.classList.remove('active'));
    const sessPill=document.getElementById('session-status'); const sessText=document.getElementById('session-status-text');
    const loginBtn=document.getElementById('login-btn'); const logoutBtn=document.getElementById('logout-btn');
    const loginUsername=document.getElementById('login-username'); const loginPassword=document.getElementById('login-password');
    const addAccountBtn=document.getElementById('add-account-btn');
    const manualUsername=document.getElementById('manual-username'); const manualPassword=document.getElementById('manual-password');
    const activeAccounts=document.getElementById('active-accounts');
    let cuentasActivasInterval;

    async function checkSessionStatus(){
      try{
        const r=await fetch(`${API_URL}/estado-sesion`,{credentials:'include'});
        const data=await r.json();
        if(data.status==='activo'){
          sessPill.innerHTML=`<i class="fa-solid fa-circle" style="color:var(--success);font-size:.65rem"></i><span id="session-status-text">Sesi√≥n activa como @${data.usuario}</span>`;
          document.getElementById('login-form').style.display='none';
        }else{
          sessPill.innerHTML=`<i class="fa-solid fa-circle" style="color:var(--err);font-size:.65rem"></i><span id="session-status-text">No hay sesi√≥n</span>`;
          document.getElementById('login-form').style.display='block';
        }
      }catch{
        sessPill.innerHTML=`<i class="fa-solid fa-circle" style="color:var(--err);font-size:.65rem"></i><span id="session-status-text">Error al verificar sesi√≥n</span>`;
        document.getElementById('login-form').style.display='block';
      }
    }
    loginBtn.addEventListener('click',async ()=>{
      const u=loginUsername.value.trim().replace('@',''); const p=loginPassword.value.trim();
      if(!u||!p) return toast('Completa usuario y contrase√±a',true);
      try{
        loginBtn.disabled=true; loginBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Iniciando‚Ä¶';
        const r=await fetch(`${API_URL}/iniciar-sesion`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:u,contrasena:p})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error al iniciar sesi√≥n');
        toast(`Sesi√≥n iniciada como @${d.usuario}`); checkSessionStatus(); actualizarListaCuentasActivas();
      }catch(e){ toast(e.message||'Error',true) }
      finally{ loginBtn.disabled=false; loginBtn.innerHTML='Iniciar sesi√≥n'; }
    });
    logoutBtn.addEventListener('click',async ()=>{
      try{
        logoutBtn.disabled=true; logoutBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Cerrando‚Ä¶';
        const r=await fetch(`${API_URL}/cerrar-sesion`,{credentials:'include'}); const d=await r.json();
        if(!d.exito) throw new Error(d.mensaje||'Error al cerrar sesi√≥n');
        toast('Sesi√≥n cerrada'); checkSessionStatus(); actualizarListaCuentasActivas();
      }catch(e){ toast(e.message||'Error',true) }
      finally{ logoutBtn.disabled=false; logoutBtn.innerHTML='Cerrar sesi√≥n'; }
    });
    addAccountBtn.addEventListener('click',async ()=>{
      const u=manualUsername.value.trim().replace('@',''); const p=manualPassword.value.trim();
      if(!u||!p) return toast('Completa usuario y contrase√±a',true);
      try{
        addAccountBtn.disabled=true; addAccountBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Guardando‚Ä¶';
        // Validar login r√°pido
        const l=await fetch(`${API_URL}/iniciar-sesion`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:u,contrasena:p})});
        const lj=await l.json(); if(!lj.exito) throw new Error(lj.mensaje||'Error al iniciar con la cuenta');
        const s=await fetch(`${API_URL}/guardar-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({username:u,password:p})});
        const sj=await s.json(); if(sj.status!=='ok') throw new Error(sj.message||'No se pudo guardar');
        toast(`Cuenta @${u} guardada`); manualUsername.value=''; manualPassword.value=''; actualizarListaCuentasActivas();
      }catch(e){ toast(e.message||'Error',true) }
      finally{ addAccountBtn.disabled=false; addAccountBtn.innerHTML='Guardar Cuenta'; }
    });
    async function actualizarListaCuentasActivas(){
      try{
        const r=await fetch(`${API_URL}/cuentas-activas`,{credentials:'include'}); const cuentas=await r.json();
        if(!Array.isArray(cuentas) || !cuentas.length){ activeAccounts.textContent='No hay cuentas activas'; return; }
        const ul=document.createElement('div'); ul.className='list';
        cuentas.forEach(acc=>{
          const item=document.createElement('div'); item.className='list-item';
          item.innerHTML=`<div style="display:flex;align-items:center;gap:8px"><span class="chip-b" style="padding:4px 8px">${acc.status||'idle'}</span>@${acc.username}</div>`;
          const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
          if(acc.status==='activo'){
            const b=document.createElement('button'); b.className='btn'; b.textContent='Logout';
            b.onclick=()=>cerrarSesionCuenta(acc.username); actions.appendChild(b);
          }else{
            const b=document.createElement('button'); b.className='btn btn-primary'; b.textContent='Login';
            b.onclick=()=>iniciarSesionCuenta(acc.username); actions.appendChild(b);
          }
          item.appendChild(actions); ul.appendChild(item);
        });
        activeAccounts.innerHTML=''; activeAccounts.appendChild(ul);
      }catch{ activeAccounts.textContent='Error al cargar cuentas'; }
    }
    async function iniciarSesionCuenta(username){
      try{
        toast(`Iniciando @${username}‚Ä¶`);
        const r=await fetch(`${API_URL}/iniciar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:username})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        toast(`Sesi√≥n iniciada @${username}`); actualizarListaCuentasActivas();
      }catch(e){ toast(e.message||'Error',true) }
    }
    async function cerrarSesionCuenta(username){
      try{
        toast(`Cerrando @${username}‚Ä¶`);
        const r=await fetch(`${API_URL}/cerrar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:username})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        toast(`Sesi√≥n cerrada @${username}`); actualizarListaCuentasActivas();
      }catch(e){ toast(e.message||'Error',true) }
    }

    // Buscar usuario
    const searchUserBtn=document.getElementById('search-user-btn');
    searchUserBtn?.addEventListener('click',searchUser);
    async function searchUser(){
      const u=document.getElementById('username-search').value.trim().replace('@','');
      if(!u) return toast('Escribe un usuario',true);
      try{
        searchUserBtn.disabled=true; searchUserBtn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Buscando‚Ä¶';
        const r=await fetch(`${API_URL}/buscar-usuario?username=${u}`,{credentials:'include'});
        const d=await r.json();
        document.getElementById('user-avatar').src = d.profile_pic_url_hd || 'https://via.placeholder.com/128?text=No+img';
        document.getElementById('user-username').textContent='@'+(d.username||u);
        document.getElementById('user-fullname').textContent=d.full_name||'';
        document.getElementById('user-posts').textContent=(d.media_count||0).toLocaleString();
        document.getElementById('user-followers').textContent=(d.follower_count||0).toLocaleString();
        document.getElementById('user-following').textContent=(d.following_count||0).toLocaleString();
        document.getElementById('user-result').style.display='block';
        toast(`Usuario @${d.username||u} encontrado`);
      }catch(e){ toast(e.message||'No se pudo buscar',true) }
      finally{ searchUserBtn.disabled=false; searchUserBtn.innerHTML='Buscar'; }
    }

    /* ===== Tabbar ===== */
    document.querySelectorAll('.tabbar .tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('.tabbar .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const k=t.dataset.tab;
      if(k==='home'){ [accPanel,svcPanel,farmPanel,document.getElementById('settings-panel')].forEach(p=>p.classList.remove('active')); window.scrollTo({top:0,behavior:'smooth'}); }
      if(k==='accounts'){ accPanel.classList.add('active'); checkSessionStatus(); actualizarListaCuentasActivas(); if(cuentasActivasInterval) clearInterval(cuentasActivasInterval); cuentasActivasInterval=setInterval(actualizarListaCuentasActivas,30000); }
      if(k==='actions'){ openServiceCenter('instagram'); }
      if(k==='farm'){ farmPanel.classList.add('active'); loadDevices(); }
      if(k==='settings'){ document.getElementById('settings-panel').classList.add('active'); }
    }));
    document.getElementById('set-back').addEventListener('click',()=>document.getElementById('settings-panel').classList.remove('active'));

    /* ===== Automatizaci√≥n r√°pida ===== */
    document.getElementById('automation-run').addEventListener('click',()=>{
      const v=(document.getElementById('automation-input').value||'').trim();
      if(!v) return toast('Escribe qu√© automatizar',true);
      toast(`Automatizando: "${v}"`); document.getElementById('automation-input').value='';
    });

    // Abrir Farm desde Home
    document.getElementById('open-farm').addEventListener('click',()=>{ farmPanel.classList.add('active'); loadDevices(); });
  </script>
</body>
</html>