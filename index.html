<!DOCTYPE html>
<html lang="es" data-theme="auto">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>KraveAI — Panel</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0d12">
<style>
/* ===================== TOKENS ===================== */
:root{
  --bg: #0b0f16; --elev:#0f1420; --card:#111a2a; --text:#eaf0f8; --muted:#97a4b8; --line:#1f2940;
  --ac1:#7c5cff; --ac2:#00d3c2; --ok:#22c55e; --err:#ef4444;
  --r:16px; --gap:12px; --shadow:0 14px 40px rgba(0,0,0,.28);
  --pill: linear-gradient(135deg, var(--ac1), var(--ac2));
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f7f9fc; --elev:#ffffff; --card:#ffffff; --text:#0c1420; --muted:#667389; --line:#e5eaf3; --shadow:0 14px 40px rgba(0,0,0,.08); }
}
html,body{height:100%}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:15px/1.45 system-ui, -apple-system, "SF Pro Text", Inter, Roboto;
}
.app{min-height:100svh; display:grid; grid-template-rows:auto 1fr auto}

/* ===================== TOPBAR ===================== */
.top{
  position:sticky; top:0; z-index:30; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
  padding:10px max(14px, env(safe-area-inset-left)) 8px max(14px, env(safe-area-inset-right));
  background: color-mix(in oklab, var(--elev) 92%, transparent);
  border-bottom:1px solid var(--line); backdrop-filter:saturate(1.1) blur(14px);
}
.brand{display:flex; align-items:center; gap:10px}
.badge{width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:var(--pill); box-shadow:0 10px 24px rgba(124,92,255,.28),0 8px 16px rgba(0,211,194,.16)}
.word{font-weight:900; letter-spacing:.16em}
.status{justify-self:center; display:flex; align-items:center; gap:8px; color:var(--muted)}
.status .dot{width:8px; height:8px; border-radius:50%; background:var(--err)}
.theme{width:36px; height:36px; border-radius:12px; display:grid; place-items:center; border:1px solid var(--line); background:rgba(255,255,255,.04); cursor:pointer}

/* ===================== NAV (bottom) ===================== */
.nav{
  position:sticky; bottom:0; z-index:25; display:grid; grid-template-columns:repeat(5,1fr); gap:8px;
  padding:8px max(12px, env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-right));
  background: color-mix(in oklab, var(--elev) 92%, transparent); border-top:1px solid var(--line);
  backdrop-filter:saturate(1.1) blur(14px);
}
.tab{display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px; border-radius:12px; color:var(--muted); border:1px solid transparent; cursor:pointer}
.tab small{font-size:.72rem}
input[name="tab"]{position:absolute; opacity:0; pointer-events:none}
#tab-home:checked ~ .app .nav label[for="tab-home"],
#tab-explorar:checked ~ .app .nav label[for="tab-explorar"],
#tab-clientes:checked ~ .app .nav label[for="tab-clientes"],
#tab-farm:checked ~ .app .nav label[for="tab-farm"],
#tab-cuentas:checked ~ .app .nav label[for="tab-cuentas"]{ color:var(--text); background:rgba(255,255,255,.05); border-color:var(--line)}

/* ===================== MAIN & VIEWS ===================== */
.main{
  height:calc(100svh - 56px - 64px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  padding:12px max(14px,env(safe-area-inset-left)) 12px max(14px,env(safe-area-inset-right));
  overflow: hidden; /* no scroll global */
}
.view{display:none; height:100%;}
#tab-home:checked ~ .app .view[data-tab="home"],
#tab-explorar:checked ~ .app .view[data-tab="explorar"],
#tab-clientes:checked ~ .app .view[data-tab="clientes"],
#tab-farm:checked ~ .app .view[data-tab="farm"],
#tab-cuentas:checked ~ .app .view[data-tab="cuentas"]{ display:block }

/* ===================== CARDS & GRID ===================== */
.card{ background:linear-gradient(180deg, color-mix(in oklab, var(--card) 96%, transparent), color-mix(in oklab, var(--card) 100%, transparent)); border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow)}
.section{display:flex; flex-direction:column; gap:12px; height:100%}
.h1{font-size:1.6rem; font-weight:900}
.muted{color:var(--muted)}
.grid{display:grid; gap:12px}
.grid.social{ grid-template-columns: repeat(auto-fit, minmax(clamp(150px, 25vw, 240px), 1fr)); align-content:start }
.btn{border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
.btn-primary{border:0; background:var(--pill); color:#0b0d13}

/* social tile */
.tile{padding:12px; display:flex; align-items:center; gap:10px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02); cursor:pointer}
.ico{width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:rgba(255,255,255,.06); border:1px solid var(--line)}
.ico svg{width:20px; height:20px}
.lab{font-weight:800}

/* clientes list */
.clients-wrap{display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:4px}
.client{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)}
.ava{width:28px; height:28px; border-radius:999px; overflow:hidden; background:#111; display:grid; place-items:center}
.ava svg{width:18px; height:18px}
.tag-ig{display:inline-flex; align-items:center; gap:6px}
.badge-verified{width:18px; height:18px; display:inline-grid; place-items:center}

/* quick bar */
.quick{display:flex; align-items:center; gap:8px; padding:10px 10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)}
.quick input{flex:1; border:0; background:transparent; outline:none; color:var(--text)}

/* subviews de servicios */
.subview{display:none}
.subview.active{display:block}
.service-grid{display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))}

/* ===================== FARM (phones) ===================== */
.farm-grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); align-content:start; height:100%; overflow:auto; padding-right:4px}
.phone{padding:12px}
.phone-head{display:flex; justify-content:space-between; align-items:center; font-size:.92rem; margin-bottom:8px}
.screen{position:relative; border-radius:28px; overflow:hidden; background:#000; aspect-ratio:19.5/9; border:1px solid #0b0b0b; box-shadow:inset 0 0 0 8px #0b0b0b, 0 10px 24px rgba(0,0,0,.5)}
.notch{position:absolute; top:8px; left:50%; transform:translateX(-50%); width:34%; height:12px; background:#000; border-radius:12px;}
.screen video,.screen img,.screen iframe{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
.phone .actions{display:flex; gap:8px; margin-top:10px}

/* ===================== ACCOUNTS ===================== */
.accounts{display:grid; gap:12px; grid-template-columns:1fr}
.row{display:flex; align-items:center; gap:8px}
.input{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)}
.input input{flex:1; border:0; background:transparent; outline:none; color:var(--text)}

/* ===================== CREATOR PILL ===================== */
.creator{
  position:fixed; left:50%; bottom:calc(64px + env(safe-area-inset-bottom) + 8px);
  transform:translateX(-50%); z-index:26; pointer-events:none; /* no tapa clics */
  padding:8px 14px; border-radius:999px; color:#0c1220; font-weight:800;
  background:var(--pill); box-shadow:0 0 18px rgba(124,92,255,.55), 0 0 28px rgba(0,211,194,.45);
  animation:breath 3.6s ease-in-out infinite;
}
@keyframes breath{ 0%,100%{transform:translateX(-50%) scale(1)} 50%{transform:translateX(-50%) scale(1.05)} }

/* ===================== ICONOS ===================== */
svg{display:block}

/* light tweaks */
@media (prefers-color-scheme: light){
  .ico{background:rgba(0,0,0,.04)}
}
</style>
</head>
<body>

<!-- Tabs (sin JS) -->
<input type="radio" name="tab" id="tab-home" checked>
<input type="radio" name="tab" id="tab-explorar">
<input type="radio" name="tab" id="tab-clientes">
<input type="radio" name="tab" id="tab-farm">
<input type="radio" name="tab" id="tab-cuentas">

<!-- ====== SPRITE: LOGOS OFICIALES Y UI ====== -->
<svg width="0" height="0" style="position:absolute" aria-hidden="true">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#7c5cff"/><stop offset="100%" stop-color="#00d3c2"/>
    </linearGradient>

    <!-- Brand -->
    <symbol id="logo-app" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="url(#g)" opacity=".18"/>
      <path d="M18 14h10v16l16-16h12L40 30l16 20H44L28 36v14H18V14z" fill="url(#g)"/>
    </symbol>

    <!-- IG verified REAL -->
    <symbol id="ig-verified" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="#0095F6"/>
      <path d="M8.8 12.4l2.2 2.2 4.8-4.8" fill="none" stroke="#fff" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Redes (oficiales/precisas) -->
    <symbol id="logo-instagram" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="12" cy="12" r="4.2" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="17.2" cy="6.8" r="1.2" fill="#E1306C"/>
    </symbol>
    <symbol id="logo-tiktok" viewBox="0 0 24 24">
      <!-- versión oficial estilizada -->
      <path d="M10 4v9.2a3.8 3.8 0 1 1-2.8 6.2" fill="none" stroke="#69C9D0" stroke-width="2"/>
      <path d="M14 4c.4 2.3 2.2 4 5 4" fill="none" stroke="#ff0050" stroke-width="2"/>
    </symbol>
    <symbol id="logo-youtube" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="3" fill="#FF0000"/><path d="M10 9l6 3-6 3z" fill="#fff"/></symbol>
    <symbol id="logo-x" viewBox="0 0 24 24"><path d="M4 4l16 16M20 4L4 20" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="logo-threads" viewBox="0 0 24 24"><path d="M6 12c0-4 3-7 6-7s6 3 6 7-3 7-6 7c-2 0-3.6-1-3.6-2.6S9 14 12 14c2.5 0 3.9-1.2 3.9-3S14.5 8 12 8" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="logo-facebook" viewBox="0 0 24 24"><path d="M14 8h3V5h-3c-2 0-3 .9-3 3v2H8v3h3v6h3v-6h3l1-3h-4V8c0-.7.3-1 1-1z" fill="#1877F2"/></symbol>
    <symbol id="logo-linkedin" viewBox="0 0 24 24"><rect x="3" y="8" width="4" height="12" fill="#0A66C2"/><circle cx="5" cy="5.5" r="2" fill="#0A66C2"/><rect x="9" y="8" width="12" height="12" rx="2" fill="none" stroke="#0A66C2" stroke-width="2"/></symbol>
    <symbol id="logo-whatsapp" viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 1 0 18 9.4 9.4 0 0 1-4-.9L5 21l.9-3.1A9.4 9.4 0 0 1 3 12 9 9 0 0 1 12 3z" fill="#25D366"/><path d="M9 8c0 3 3 6 5 6l1-1" stroke="#fff" stroke-width="2"/></symbol>
    <symbol id="logo-telegram" viewBox="0 0 24 24"><path d="M21 3L3 11l6 2 2 6 3-4 4-10z" fill="#0088cc"/></symbol>
    <symbol id="logo-spotify" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#1DB954"/><path d="M7 10c3-1 7-1 10 1M7 13c3-1 6-1 9 1M7 16c2-.5 4-.5 6 .5" stroke="#fff" stroke-width="2" fill="none"/></symbol>

    <!-- UI icons -->
    <symbol id="ico-home" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v9a2 2 0 0 1-2 2h-4v-7H9v7H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-grid" viewBox="0 0 24 24"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-users" viewBox="0 0 24 24"><path d="M7 14a4 4 0 1 1 4-4M3 21a6 6 0 0 1 12 0M17 11a3 3 0 1 1 6 0M15 21a6 6 0 0 1 6-6" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-devices" viewBox="0 0 24 24"><rect x="3" y="4" width="14" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><rect x="19" y="8" width="2" height="8" rx="1" fill="currentColor"/></symbol>
    <symbol id="ico-lock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="9" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 1v2m0 18v2M4.2 4.2l1.4 1.4m12.8 12.8l1.4 1.4M1 12h2m18 0h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-moon" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.45-.04-.9-.1-1.33a5.4 5.4 0 0 1-4.4 2.2 5.4 5.4 0 0 1-3.1-9.8c-.43-.06-.9-.09-1.4-.09z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  </defs>
</svg>

<div class="app" id="app">
  <!-- Topbar -->
  <header class="top">
    <div class="brand">
      <div class="badge"><svg viewBox="0 0 64 64" width="20" height="20"><use href="#logo-app"/></svg></div>
      <div class="word">KraveAI</div>
    </div>
    <div class="status"><span class="dot" id="status-dot"></span><small id="status-text">Sin conexión</small></div>
    <button class="theme" id="theme-toggle" title="Tema">
      <svg width="20" height="20"><use id="theme-icon" href="#ico-moon"/></svg>
    </button>
  </header>

  <main class="main">
    <!-- ================== HOME ================== -->
    <section class="view section" data-tab="home">
      <div>
        <div class="h1">Redes sociales</div>
        <div class="muted">Domina todas tus redes con IA</div>
      </div>

      <!-- Grid de redes -->
      <div class="grid social" id="social-grid"></div>

      <!-- Clientes recientes (scroll si crece) -->
      <div class="card" style="padding:12px; display:flex; flex-direction:column; gap:10px; min-height:0;">
        <div class="h1" style="font-size:1.05rem">Clientes recientes</div>
        <div id="recent-clients" class="clients-wrap" style="min-height:0; max-height:28svh"></div>
      </div>

      <!-- Barra rápida -->
      <div class="quick card">
        <span>➕</span>
        <input id="quick-input" placeholder="¿Qué quieres automatizar hoy?">
        <button class="btn-primary" id="quick-run">Enviar</button>
      </div>
    </section>

    <!-- ================== EXPLORAR ================== -->
    <section class="view section" data-tab="explorar">
      <div class="h1">Explorar</div>
      <div class="muted">Accesos directos y próximos servicios.</div>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
        <button class="btn">Abrir Device Farm</button>
        <button class="btn">Importar cuentas</button>
        <button class="btn">Documentación</button>
      </div>
    </section>

    <!-- ================== CLIENTES ================== -->
    <section class="view section" data-tab="clientes">
      <div class="h1">Clientes recientes</div>
      <div class="card clients-wrap" id="clients-page" style="padding:12px; max-height:100%; min-height:0"></div>
    </section>

    <!-- ================== FARM ================== -->
    <section class="view section" data-tab="farm">
      <div class="h1">Device Farm</div>
      <div class="muted">Streams: HLS .m3u8, MJPEG .mjpg, visor https (se guarda en localStorage).</div>
      <div class="farm-grid" id="farm-grid"></div>
    </section>

    <!-- ================== CUENTAS ================== -->
    <section class="view section" data-tab="cuentas">
      <div class="h1">Cuentas</div>
      <div class="accounts">
        <div class="card" style="padding:12px">
          <div class="row" style="margin-bottom:8px"><svg width="18" height="18"><use href="#ico-lock"/></svg><strong>Sesión</strong><small id="session-sub" class="muted">Verificando…</small></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
            <div class="input" style="grid-column:1/-1"><span>@</span><input id="login-username" placeholder="Usuario"></div>
            <div class="input" style="grid-column:1/-1"><span>🔒</span><input id="login-password" type="password" placeholder="Contraseña"></div>
            <button class="btn-primary" id="login-btn">Iniciar sesión</button>
            <button class="btn" id="logout-btn">Cerrar sesión</button>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div class="row" style="margin-bottom:8px"><svg width="18" height="18"><use href="#logo-instagram"/></svg><strong>Buscar usuario de Instagram</strong></div>
          <div class="input"><span>@</span><input id="ig-search" placeholder="ej. karmeangomez"><button class="btn" id="ig-search-btn">Buscar</button></div>
          <div id="ig-search-result" class="muted" style="margin-top:8px">—</div>
        </div>

        <div class="card" style="padding:12px">
          <div class="row" style="margin-bottom:8px"><svg width="18" height="18"><use href="#logo-instagram"/></svg><strong>Agregar cuenta manual</strong></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
            <div class="input" style="grid-column:1/-1"><span>@</span><input id="manual-username" placeholder="@usuario"></div>
            <div class="input" style="grid-column:1/-1"><span>🔒</span><input id="manual-password" type="password" placeholder="••••••••"></div>
            <button class="btn-primary" id="add-account-btn">Guardar cuenta</button>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div class="row" style="margin-bottom:8px"><svg width="18" height="18"><use href="#ico-users"/></svg><strong>Cuentas activas</strong><small class="muted">Actualiza cada 30s</small></div>
          <div id="accounts-list" class="grid" style="grid-template-columns:1fr; gap:8px"><div class="muted">Cargando…</div></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="nav">
    <label class="tab" for="tab-home"><svg width="18" height="18"><use href="#ico-home"/></svg><small>Inicio</small></label>
    <label class="tab" for="tab-explorar"><svg width="18" height="18"><use href="#ico-grid"/></svg><small>Explorar</small></label>
    <label class="tab" for="tab-clientes"><svg width="18" height="18"><use href="#ico-users"/></svg><small>Clientes</small></label>
    <label class="tab" for="tab-farm"><svg width="18" height="18"><use href="#ico-devices"/></svg><small>Farm</small></label>
    <label class="tab" for="tab-cuentas"><svg width="18" height="18"><use href="#ico-lock"/></svg><small>Cuentas</small></label>
  </nav>
</div>

<!-- Creator pill -->
<div class="creator">Created by Karmean Gómez</div>

<script>
(function(){
  const API_URL = "https://api.kraveapi.xyz";

  // ===== THEME (auto / persist) =====
  const toggle = document.getElementById('theme-toggle');
  const icon = document.getElementById('theme-icon');
  const saved = localStorage.getItem('theme');
  if(saved){ document.documentElement.dataset.theme = saved; }
  updateThemeIcon();
  toggle.addEventListener('click', ()=>{
    const cur = document.documentElement.dataset.theme;
    const next = cur === 'dark' ? 'light' : cur === 'light' ? 'dark' : (matchMedia('(prefers-color-scheme: dark)').matches ? 'light' : 'dark');
    document.documentElement.dataset.theme = next;
    localStorage.setItem('theme', next);
    updateThemeIcon();
  });
  function updateThemeIcon(){
    const t = document.documentElement.dataset.theme;
    icon.setAttribute('href', t === 'light' ? '#ico-moon' : '#ico-sun');
  }

  // ===== Backend status =====
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  async function checkHealth(){
    try{ const r = await fetch(`${API_URL}/health`, {credentials:'include'}); if(r.ok){statusDot.style.background='var(--ok)'; statusText.textContent='Conectado';} else throw new Error(); }
    catch{ statusDot.style.background='var(--err)'; statusText.textContent='Sin conexión'; }
  }
  checkHealth(); setInterval(checkHealth, 120000);

  // ===== Social grid (home) =====
  const social = [
    {k:'instagram', label:'Instagram', icon:'#logo-instagram'},
    {k:'tiktok',    label:'TikTok',    icon:'#logo-tiktok'},
    {k:'youtube',   label:'YouTube',   icon:'#logo-youtube'},
    {k:'x',         label:'X',         icon:'#logo-x'},
    {k:'threads',   label:'Threads',   icon:'#logo-threads'},
    {k:'facebook',  label:'Facebook',  icon:'#logo-facebook'},
    {k:'linkedin',  label:'LinkedIn',  icon:'#logo-linkedin'},
    {k:'spotify',   label:'Spotify',   icon:'#logo-spotify'},
    {k:'telegram',  label:'Telegram',  icon:'#logo-telegram'},
    {k:'whatsapp',  label:'WhatsApp',  icon:'#logo-whatsapp'}
  ];
  const socialGrid = document.getElementById('social-grid');
  socialGrid.innerHTML = social.map(s => `
    <article class="tile" data-net="${s.k}">
      <div class="ico"><svg><use href="${s.icon}"/></svg></div>
      <div class="lab">${s.label}</div>
    </article>
  `).join('');
  socialGrid.addEventListener('click', (e)=>{
    const tile = e.target.closest('.tile'); if(!tile) return;
    openNetwork(tile.dataset.net);
  });

  // ===== Recent clients (home + clientes page) =====
  const recent = [
    {user:'aaronmercury', name:'', net:'instagram', ava:''},
    {user:'televisadigital', name:'', net:'instagram', ava:''},
    {user:'joscanela', name:'', net:'instagram', ava:''},
    {user:'jimenagallegotv', name:'', net:'instagram', ava:''},
  ];
  function clientRow(c){
    return `
    <div class="client">
      <div class="ava">${c.ava ? `<img src="${c.ava}" alt="" style="width:100%;height:100%;object-fit:cover">` : `<svg><use href="#logo-instagram"/></svg>`}</div>
      <div class="tag-ig">
        <strong>@${c.user}</strong>
        <svg class="badge-verified"><use href="#ig-verified"/></svg>
      </div>
      <span class="muted" style="margin-left:auto">Instagram</span>
      <svg width="18" height="18" style="margin-left:6px"><use href="#logo-instagram"/></svg>
    </div>`;
  }
  const rc = document.getElementById('recent-clients');
  rc.innerHTML = recent.map(clientRow).join('');
  const cp = document.getElementById('clients-page');
  cp.innerHTML = recent.map(clientRow).join('');

  // ===== Quick automation =====
  document.getElementById('quick-run').addEventListener('click', ()=>{
    const v = (document.getElementById('quick-input').value || '').trim();
    toast(v ? ('Iniciando: '+v) : 'Escribe qué automatizar', !v);
    if(v) document.getElementById('quick-input').value='';
  });

  // ===== Network subviews (servicios) =====
  function openNetwork(key){
    // Crea un modal simple con los servicios de esa red
    const wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed; inset:0; z-index:40; display:grid; place-items:center; background:rgba(0,0,0,.35); padding:16px';
    wrap.innerHTML = `
      <div class="card" style="width:min(720px, 96vw); max-height:88vh; overflow:auto; padding:16px">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px">
          <div class="ico"><svg><use href="${(social.find(s=>s.k===key)||{}).icon||'#logo-instagram'}"/></svg></div>
          <div class="h1" style="font-size:1.2rem; margin:0">${(social.find(s=>s.k===key)||{}).label||''}</div>
          <button class="btn" id="close-net" style="margin-left:auto">Cerrar</button>
        </div>
        <div class="subview active">
          ${renderServices(key)}
        </div>
      </div>`;
    document.body.appendChild(wrap);
    wrap.addEventListener('click', (e)=>{ if(e.target.id==='close-net' || e.target===wrap) wrap.remove(); });
  }
  function renderServices(key){
    if(key==='instagram'){
      return `
        <div class="service-grid">
          <div class="card" style="padding:12px">
            <strong>Comentarios</strong>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">
              <div class="input" style="grid-column:1/-1"><span>🔗</span><input id="ig-url" placeholder="URL del post (https://www.instagram.com/p/...)"></div>
              <div class="input"><span>#</span><input id="ig-cant" type="number" min="1" max="100" value="30"></div>
              <div class="input"><span>🎛️</span><input id="ig-modo" value="auto" list="modos" placeholder="Modo"></div>
              <datalist id="modos"><option value="auto"><option value="personalizado"><option value="manual"></datalist>
              <div class="input" style="grid-column:1/-1"><span>🧑‍💼</span><input id="ig-apodo" placeholder="Apodo (opcional)"></div>
              <div class="input"><span>🎯</span><input id="ig-estilo" placeholder="Estilo"></div>
              <div class="input"><span>🏷️</span><input id="ig-act" placeholder="Actividad"></div>
              <div class="input" style="grid-column:1/-1"><span>📝</span><input id="ig-ej" placeholder="Ejemplos (uno por línea)"></div>
              <button class="btn-primary" id="ig-send" style="grid-column:1/2">Lanzar</button>
              <button class="btn" id="ig-cancel" style="grid-column:2/3">Cancelar</button>
            </div>
            <div id="ig-comments-status" class="muted" style="margin-top:6px">—</div>
          </div>
          <button class="btn">Likes</button>
          <button class="btn">Seguidores</button>
          <button class="btn">Vistas</button>
        </div>`;
    }
    if(key==='tiktok'){ return `<div class="service-grid"><button class="btn">Vistas</button><button class="btn">Likes</button><button class="btn">Seguidores</button></div>`; }
    if(key==='youtube'){ return `<div class="service-grid"><button class="btn">Vistas</button><button class="btn">Likes</button><button class="btn">Comentarios</button><button class="btn">Suscriptores</button></div>`; }
    if(key==='x'){ return `<div class="service-grid"><button class="btn">Likes</button><button class="btn">Reposts</button><button class="btn">Seguidores</button><button class="btn">Respuestas</button></div>`; }
    if(key==='threads'){ return `<div class="service-grid"><button class="btn">Likes</button><button class="btn">Respuestas</button><button class="btn">Seguidores</button></div>`; }
    if(key==='facebook'){ return `<div class="service-grid"><button class="btn">Reacciones</button><button class="btn">Comentarios</button><button class="btn">Compartidos</button></div>`; }
    if(key==='linkedin'){ return `<div class="service-grid"><button class="btn">Reacciones</button><button class="btn">Comentarios</button><button class="btn">Conexiones</button></div>`; }
    if(key==='telegram'){ return `<div class="service-grid"><button class="btn">Mensajes</button><button class="btn">Miembros</button><button class="btn">Reacciones</button></div>`; }
    if(key==='whatsapp'){ return `<div class="service-grid"><button class="btn">Mensajes</button><button class="btn">Grupos</button><button class="btn">Respuestas</button></div>`; }
    if(key==='spotify'){ return `<div class="service-grid"><button class="btn">Streams</button><button class="btn">Saves</button></div>`; }
    return `<div class="muted">Servicios próximamente</div>`;
  }

  // Instagram → Comentarios (POST)
  document.body.addEventListener('click', async (e)=>{
    if(e.target && e.target.id==='ig-send'){
      const url = document.getElementById('ig-url').value.trim();
      const cant = +document.getElementById('ig-cant').value || 30;
      const modo = document.getElementById('ig-modo').value || 'auto';
      const apodo = document.getElementById('ig-apodo').value || '';
      const estilo = document.getElementById('ig-estilo').value || '';
      const actividad = document.getElementById('ig-act').value || '';
      const ejemplos = document.getElementById('ig-ej').value || '';
      const st = document.getElementById('ig-comments-status');
      if(!url){ toast('Falta URL', true); return;}
      try{
        st.textContent='Enviando…';
        const r = await fetch(`${API_URL}/instagram/comentarios`, {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
          body: JSON.stringify({url, cantidad:cant, modo, apodo, estilo, actividad, ejemplos})
        });
        const d = await r.json().catch(()=>({}));
        if(r.ok){ st.textContent='✅ Comentarios en proceso'; toast('Comentarios lanzados'); }
        else { throw new Error(d.mensaje||'Error en comentarios'); }
      }catch(err){ st.textContent='❌ '+err.message; toast(err.message,true); }
    }
    if(e.target && e.target.id==='ig-cancel'){
      const st = document.getElementById('ig-comments-status'); if(st) st.textContent='—';
    }
  });

  // ===== Farm devices (phone frames) =====
  const devices = [
    {id:'dev1', name:'iPhone 14 Pro', os:'iOS', ip:'10.0.0.8'},
    {id:'dev2', name:'Galaxy S23', os:'Android', ip:'10.0.0.9'},
    {id:'dev3', name:'iPhone 13', os:'iOS', ip:'10.0.0.10'},
    {id:'dev4', name:'Pixel 8', os:'Android', ip:'10.0.0.11'},
    {id:'dev5', name:'iPhone 12 mini', os:'iOS', ip:'10.0.0.12'},
    {id:'dev6', name:'Galaxy A54', os:'Android', ip:'10.0.0.13'}
  ];
  const farmGrid = document.getElementById('farm-grid');
  function renderFarm(){
    farmGrid.innerHTML = devices.map(d=>{
      const src = localStorage.getItem('stream:'+d.id)||'';
      return `
        <div class="card phone">
          <div class="phone-head">
            <div><strong>${d.name}</strong> · ${d.os}</div>
            <div class="muted">${d.ip}</div>
          </div>
          <div class="screen">
            <div class="notch"></div>
            ${src ? (
              src.endsWith('.mjpg')||src.endsWith('.mjpeg') ? `<img src="${src}">` :
              src.endsWith('.m3u8') ? `<video src="${src}" autoplay muted playsinline></video>` :
              `<iframe src="${src}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`
            ) : `<img src="data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 600 270\\'><defs><linearGradient id=\\'g\\' x1=\\'0\\' x2=\\'1\\'><stop stop-color=\\'#0ea5e9\\'/><stop offset=\\'1\\' stop-color=\\'#8b5cf6\\'/></linearGradient></defs><rect width=\\'100%\\' height=\\'100%\\' fill=\\'#000\\'/><ellipse cx=\\'120\\' cy=\\'220\\' rx=\\'220\\' ry=\\'80\\' fill=\\'url(#g)\\' opacity=\\'.22\\'/><ellipse cx=\\'520\\' cy=\\'60\\' rx=\\'160\\' ry=\\'60\\' fill=\\'url(#g)\\' opacity=\\'.18\\'/></svg>')}" style="width:100%;height:100%;object-fit:cover">`}
          </div>
          <div class="actions">
            <button class="btn-primary" data-set="${d.id}">Asignar stream</button>
            <button class="btn" data-clear="${d.id}">Limpiar</button>
          </div>
        </div>
      `;
    }).join('');
  }
  renderFarm();
  farmGrid.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    if(b.dataset.set){
      const id = b.dataset.set; const cur = localStorage.getItem('stream:'+id)||'';
      const url = prompt('URL stream (HLS .m3u8, MJPEG .mjpg, o https):', cur);
      if(url!==null){ localStorage.setItem('stream:'+id, url.trim()); renderFarm(); toast('Stream actualizado'); }
    }
    if(b.dataset.clear){
      const id = b.dataset.clear; localStorage.removeItem('stream:'+id); renderFarm(); toast('Stream limpiado');
    }
  });

  // ===== Accounts: session + search =====
  const sessionSub = document.getElementById('session-sub');
  async function checkSession(){
    try{
      const r = await fetch(`${API_URL}/estado-sesion`, {credentials:'include'});
      const d = await r.json(); sessionSub.textContent = (d.status==='activo') ? `Sesión activa como @${d.usuario}` : 'No hay sesión activa';
    }catch{ sessionSub.textContent = 'Error al verificar sesión'; }
  }
  checkSession();

  document.getElementById('login-btn').addEventListener('click', async ()=>{
    const u = document.getElementById('login-username').value.trim().replace('@','');
    const p = document.getElementById('login-password').value.trim();
    if(!u||!p) return toast('Completa usuario y contraseña', true);
    try{
      const btn = document.getElementById('login-btn'); btn.textContent='Iniciando…'; btn.disabled=true;
      const r = await fetch(`${API_URL}/iniciar-sesion`, {method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({usuario:u, contrasena:p})});
      const d = await r.json(); if(d.exito){ toast('Sesión iniciada @'+d.usuario); sessionSub.textContent = `Sesión activa como @${d.usuario}`; } else throw new Error(d.mensaje||'Error al iniciar');
    }catch(err){ toast(err.message, true); }
    finally{ const btn = document.getElementById('login-btn'); btn.textContent='Iniciar sesión'; btn.disabled=false; }
  });

  document.getElementById('logout-btn').addEventListener('click', async ()=>{
    try{
      const btn = document.getElementById('logout-btn'); btn.textContent='Cerrando…'; btn.disabled=true;
      const r = await fetch(`${API_URL}/cerrar-sesion`, {credentials:'include'});
      const d = await r.json(); if(d.exito){ toast('Sesión cerrada'); sessionSub.textContent='No hay sesión activa'; } else throw new Error(d.mensaje||'Error al cerrar');
    }catch(err){ toast(err.message, true); }
    finally{ const btn = document.getElementById('logout-btn'); btn.textContent='Cerrar sesión'; btn.disabled=false; }
  });

  // buscar usuario IG
  document.getElementById('ig-search-btn').addEventListener('click', async ()=>{
    const u = (document.getElementById('ig-search').value||'').trim().replace('@','');
    const out = document.getElementById('ig-search-result');
    if(!u){ out.textContent = 'Escribe un usuario'; return; }
    out.textContent = 'Buscando…';
    try{
      const r = await fetch(`${API_URL}/instagram/user?u=${encodeURIComponent(u)}`, {credentials:'include'});
      if(!r.ok) throw new Error('No encontrado');
      const d = await r.json();
      out.innerHTML = `
        <div class="client" style="padding:10px">
          <div class="ava">${d.avatar?`<img src="${d.avatar}" style="width:100%;height:100%;object-fit:cover">`:`<svg><use href="#logo-instagram"/></svg>`}</div>
          <div class="tag-ig"><strong>@${d.username||u}</strong> ${d.verified?`<svg class="badge-verified"><use href="#ig-verified"/></svg>`:''}</div>
          <span class="muted" style="margin-left:auto">${d.full_name||''}</span>
        </div>
        <div class="muted">Seguidores: ${d.followers??'—'} · Siguiendo: ${d.following??'—'} · Posts: ${d.posts??'—'}</div>
      `;
    }catch(err){ out.textContent = 'No encontrado o error de red'; }
  });

  // cuentas activas (placeholder de polling)
  const accountsList = document.getElementById('accounts-list');
  async function loadAccounts(){
    try{
      const r = await fetch(`${API_URL}/cuentas-activas`, {credentials:'include'});
      const arr = await r.json();
      if(!Array.isArray(arr)||arr.length===0){accountsList.innerHTML='<div class="muted">No hay cuentas activas</div>'; return;}
      accountsList.innerHTML = arr.map(acc=>`
        <div class="card" style="padding:8px 10px; display:flex; align-items:center; justify-content:space-between; gap:8px">
          <div style="display:flex; align-items:center; gap:8px">
            <span style="width:10px; height:10px; border-radius:50%; background:${acc.status==='activo'?'var(--ok)':'var(--err)'}"></span>
            <strong>@${acc.username}</strong>
          </div>
          <div style="display:flex; gap:6px">
            ${acc.status==='activo' ? `<button class="btn" data-logout="${acc.username}">Logout</button>` : `<button class="btn btn-primary" data-login="${acc.username}">Login</button>`}
          </div>
        </div>
      `).join('');
    }catch{ accountsList.innerHTML='<div class="muted">Error al cargar cuentas</div>'; }
  }
  loadAccounts(); setInterval(loadAccounts, 30000);
  accountsList.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.login){
      toast('Iniciando @'+b.dataset.login+'…');
      try{ const r=await fetch(`${API_URL}/iniciar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.login})}); const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error'); toast('Sesión iniciada @'+b.dataset.login); loadAccounts(); }
      catch(err){ toast(err.message,true) }
    }
    if(b.dataset.logout){
      toast('Cerrando @'+b.dataset.logout+'…');
      try{ const r=await fetch(`${API_URL}/cerrar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.logout})}); const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error'); toast('Sesión cerrada @'+b.dataset.logout); loadAccounts(); }
      catch(err){ toast(err.message,true) }
    }
  });

  // ===== Toast =====
  function toast(msg, err){
    const el=document.createElement('div');
    el.textContent=msg;
    el.style.cssText=`position:fixed; left:50%; top:12px; transform:translateX(-50%); z-index:50; background:${err?'#ef4444':'#1f2937'}; color:#fff; padding:8px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.15)`;
    document.body.appendChild(el); setTimeout(()=>el.remove(), 2200);
  }

})();
</script>
</body>
</html>