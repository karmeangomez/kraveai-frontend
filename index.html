<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>KraveAI</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0b1220">

<!-- ICONOS -->
<link rel="icon" href="/icons/robot-192.png" sizes="192x192">
<link rel="icon" href="/icons/robot-512.png" sizes="512x512">
<link rel="apple-touch-icon" href="/icons/robot-192.png">

<style>
  :root{
    --bg:#0f1419;--card:#141a21;--card-2:#11171d;--muted:#8ea0b2;--text:#e9eef5;--line:#1f2833;
    --brand:#19c2ff;--accent:#0077ff;--chip:#1b2430;--chip-text:#dfe7ef;--success:#25d366;
    --gold1:#1b1a14;--gold2:#3b3523;--gold3:#c5a34a;
  }
  .light{--bg:#f6f8fb;--card:#fff;--card-2:#fff;--muted:#5c6b7a;--text:#0b1220;--line:#e7edf4;--brand:#0077ff;--accent:#0057d6;--chip:#eef3f8;--chip-text:#0b1220}
  .neon-theme{--bg:#0a0f14;--card:#1a2430;--text:#e0f7ff;--brand:#00ffcc;--accent:#ff00ff;--line:#2a3442}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  .hidden{display:none!important}
  .muted{color:var(--muted)}
  .btn{background:var(--card);color:var(--text);border:1px solid var(--line);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--brand));border-color:transparent;color:#fff}
  .btn.ghost{background:transparent}
  .input{width:100%;background:var(--card);color:var(--text);border:1px solid var(--line);padding:12px 14px;border-radius:14px;outline:none}

  .topbar{position:sticky;top:0;z-index:80;background:var(--card-2);border-bottom:1px solid var(--line);
    padding:14px calc(14px + env(safe-area-inset-left,0px)) 14px calc(14px + env(safe-area-inset-right,0px));
    display:flex;align-items:center;gap:12px;justify-content:space-between;width:100vw}
  .brand{display:flex;align-items:center;gap:8px;font-weight:800;position:relative; user-select:none}
  .robot{width:28px;height:28px;display:block}
  /* Bot√≥n secreto (tap 5x) */
  .brand .secret{position:absolute;left:-6px;top:-6px;width:14px;height:14px;border-radius:50%;opacity:.05;cursor:pointer}
  .right-head{display:flex;align-items:center;gap:12px}
  .pill{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:999px;background:#e0565b}
  .toggle,.mic-btn{border:1px solid var(--line);background:transparent;color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  .mic-btn{padding:8px}
  .mic-btn.recording{animation:pulse 1s infinite}
  @keyframes pulse{50%{box-shadow:0 0 10px var(--brand)}}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media(min-width:760px){.grid{grid-template-columns:repeat(4,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;
    padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;
    opacity:0;transform:scale(.95);transition:opacity .3s ease,transform .3s ease; min-height:64px}
  .card.visible{opacity:1;transform:scale(1)}
  .card:hover{transform:translateY(-1px)}
  .logo-wrap{width:28px;height:28px;display:grid;place-items:center}
  .card .title{font-weight:700}

  .card.mu{background:linear-gradient(160deg,var(--gold1),var(--gold2)); border-color:#5a5136;position:relative; overflow:hidden;}
  .card.mu::after{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(120px 40px at 85% -20%, rgba(197,163,74,.35), transparent 60%);}
  .pill-mu{font-size:11px;border:1px solid #7c6a3a;border-radius:999px;padding:4px 8px;opacity:.9}

  .card.beast{background:linear-gradient(45deg,var(--accent),var(--brand));border:1px solid rgba(25,194,255,.5);
    text-shadow:0 0 8px var(--brand),0 0 16px var(--accent);box-shadow:0 0 18px var(--brand), inset 0 0 12px var(--accent);animation:beast-glow 3s ease-in-out infinite;position:relative}
  @keyframes beast-glow{0%,100%{box-shadow:0 0 18px var(--brand), inset 0 0 12px var(--accent)}50%{box-shadow:0 0 28px var(--accent), inset 0 0 16px var(--brand)}}
  .beast-hot{background:#ff1a1a!important;border-color:#ff6b6b!important;box-shadow:0 0 34px #ff3b3b, inset 0 0 22px #ff9a9a!important}
  @keyframes radial-flash{0%{transform:scale(0);opacity:.85}100%{transform:scale(18);opacity:0}}
  .radial-effect{position:absolute;inset:0;border-radius:inherit;background:rgba(255,0,0,.35);animation:radial-flash .7s ease-out forwards;pointer-events:none}
  @keyframes circle-flash{0%{transform:scale(0);opacity:.35}100%{transform:scale(80);opacity:0}}
  .screen-circle{position:fixed;width:24px;height:24px;border-radius:999px;background:rgba(255,0,0,.35);pointer-events:none;z-index:110;animation:circle-flash .8s ease-out forwards}

  .list{display:flex;flex-direction:column;gap:12px;max-height:48vh;overflow:auto;padding-right:2px}
  .row{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;align-items:center;gap:12px;
    opacity:0;transform:scale(.95);transition:opacity .3s ease,transform .3s ease}
  .row.visible{opacity:1;transform:scale(1)}
  .avatar-wrap{width:40px;height:40px;border-radius:999px;padding:2px;flex:none;display:grid;place-items:center}
  .avatar{width:36px;height:36px;border-radius:999px;background:#2a3442;display:block}
  .ring-ig{background:conic-gradient(#feda75,#fa7e1e,#d62976,#962fbf,#4f5bd5)}
  .ring-close{background:conic-gradient(#35c759,#34d058,#35c759)}
  .user{font-weight:700;font-size:16px;display:flex;align-items:center;gap:4px}
  .grow{flex:1}
  .chip{background:var(--chip);color:var(--chip-text);border-radius:999px;padding:6px 10px;font-size:12px}
  .dots{border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer;padding:6px;line-height:0}

  .clients-grid{display:grid;gap:12px;max-width:1200px;margin:0 auto;grid-template-columns: repeat(4,1fr)}
  @media (max-width:480px){ .clients-grid{ grid-template-columns: 1fr } }
  @media (min-width:481px) and (max-width:900px){ .clients-grid{ grid-template-columns: repeat(2,1fr) } }
  @media (min-width:901px) and (max-width:1200px){ .clients-grid{ grid-template-columns: repeat(3,1fr) } }
  .client-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(4px);transition:opacity .3s ease,transform .3s ease;min-height:90px}
  .client-card.visible{opacity:1;transform:translateY(0)}
  .client-card .avatar-wrap{width:52px;height:52px;padding:3px}
  .client-card .avatar{width:46px;height:46px}
  .client-title{display:flex;align-items:center;gap:4px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .client-sub,.client-meta{color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .client-meta{font-size:12px}
  .ig-verified{width:1.05em;height:1.05em;display:inline-block;vertical-align:-.18em;margin-left:2px;shape-rendering:geometricPrecision}
  .row-menu,.card-menu{position:relative}
  .menu{position:absolute;right:0;top:120%;background:var(--card);border:1px solid var(--line);border-radius:10px;min-width:140px;z-index:40;display:none}
  .menu.show{display:block}
  .menu button{display:block;width:100%;text-align:left;background:transparent;border:none;color:var(--text);padding:8px 10px;cursor:pointer}

  .nav{position:fixed;left:0;right:0;bottom:0;z-index:60;background:var(--card-2);border-top:1px solid var(--line);display:flex;gap:10px;
    padding:12px calc(12px + env(safe-area-inset-left,0px)) calc(12px + env(safe-area-inset-bottom,0px)) calc(12px + env(safe-area-inset-right,0px));
    justify-content:space-around;width:100vw;box-sizing:border-box}
  .nav .item{flex:1;text-align:center;padding:12px 10px;border-radius:14px;color:var(--muted);font-size:13.5px;cursor:pointer;min-height:48px;line-height:1;-webkit-tap-highlight-color:transparent}
  .nav .item.active{color:var(--text);background:rgba(255,255,255,.02);border:1px solid var(--line);text-shadow:0 0 8px var(--brand),0 0 16px var(--accent)}

  .view{display:none;opacity:0;transform:scale(.98);transition:opacity .4s ease,transform .4s ease}
  .view.active{display:block;opacity:1;transform:scale(1);animation:holographic-enter .4s ease-out}
  @keyframes holographic-enter{0%{filter:blur(2px);opacity:0}100%{filter:blur(0);opacity:1}}

  .back{margin:6px 0 16px;display:inline-flex;gap:8px;align-items:center;color:var(--muted);cursor:pointer}

  .dashboard{position:fixed;top:80px;right:20px;background:var(--card-2);border:1px solid var(--line);border-radius:50%;width:180px;height:180px;padding:20px;z-index:100;display:none;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .dashboard.active{display:block}
  .dashboard h4{margin:0 0 8px;font-size:14px}
  .dashboard .stat{color:var(--muted);font-size:12px}
  .dashboard .close{position:absolute;top:5px;right:10px;cursor:pointer;color:var(--muted)}
  .credit{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(var(--nav-h,64px) + env(safe-area-inset-bottom,0px) + 22px);z-index:90;padding:8px 14px;border-radius:999px;font-size:12px;color:#fff;background:rgba(41,178,255,.12);border:1px solid rgba(41,178,255,.35);box-shadow:0 0 30px 6px rgba(41,178,255,.35), inset 0 0 24px rgba(41,178,255,.25);backdrop-filter:blur(6px);pointer-events:none;animation:pulse-glow 2.8s ease-in-out infinite;max-width:90vw;text-align:center;white-space:nowrap}

  body.locked{overflow:hidden}
  body.locked main, body.locked header, body.locked nav, body.locked .dashboard, body.locked .credit{display:none!important}

  @media(max-width:480px){.grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="background-3d"></div>

  <!-- HEADER -->
  <header class="topbar">
    <div class="brand" id="brandTap">
      <div class="secret" title=""></div>
      <svg class="robot" viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#19c2ff"/><stop offset="1" stop-color="#0077ff"/></linearGradient></defs><rect x="2" y="10" width="60" height="44" rx="12" fill="url(#g)"/><rect x="8" y="16" width="48" height="32" rx="8" fill="#0b1220"/><circle cx="22" cy="32" r="6" fill="#19c2ff"/><circle cx="42" cy="32" r="6" fill="#19c2ff"/><rect x="28" y="40" width="8" height="4" rx="2" fill="#19c2ff"/></svg>
      <span class="name">KraveAI</span>
    </div>

    <div class="right-head">
      <div class="pill"><span class="dot" id="connDot"></span> <span id="conn">Sin conexi√≥n</span></div>
      <button id="themeToggle" class="toggle" title="Cambiar tema">üåô</button>
      <button id="micToggle" class="mic-btn" title="Activar voz">üéôÔ∏è</button>
      <button id="installBtn" class="toggle hidden" title="Instalar app">‚¨áÔ∏è Instalar</button>
    </div>
  </header>

  <!-- CONTENIDO -->
  <main class="wrap">
    <section id="view-home" class="view">
      <h1>Redes sociales</h1>
      <div class="sub">Domina todas tus redes con IA</div>
      <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
        <span>Redes</span>
        <button id="addFromHome" class="mini btn ghost" title="A√±adir cliente">Ôºã</button>
      </div>
      <div class="grid" id="socialGrid"></div>
      <div class="section-title" style="margin-top:12px">Clientes recientes</div>
      <div class="list" id="recentList"></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <input id="aiPrompt" class="input" placeholder="¬øQu√© quieres automatizar hoy?" />
        <button class="btn primary" onclick="sendAction()">Enviar</button>
      </div>
    </section>

    <section id="view-clients" class="view">
      <div class="section-title" style="display:flex;align-items:center;justify-content:space-between">
        <span>Clientes</span>
        <button id="addClientBtn" class="mini btn ghost" title="A√±adir cliente">Ôºã</button>
      </div>
      <input id="clientSearch" class="input" placeholder="Buscar cliente (@usuario o nombre)" style="margin:8px 0 12px"/>
      <div class="clients-grid" id="clientsGrid" style="margin-bottom:12px"></div>
    </section>

    <section id="view-farm" class="view">
      <h1>Device Farm</h1>
      <div class="sub">Streams: HLS .m3u8, MJPEG .mjpg o visor https.</div>
      <div class="devices" id="farmGrid"></div>
    </section>

    <section id="view-accounts" class="view">
      <h1>Cuentas</h1>
      <div class="sub">Gesti√≥n de sesi√≥n y cuentas manuales</div>
      <div class="stack" style="max-width:560px">
        <div class="svc">
          <h4>Iniciar sesi√≥n</h4>
          <input class="input" placeholder="Usuario" />
          <input class="input" placeholder="Contrase√±a" type="password"/>
          <div style="display:flex;gap:10px">
            <button class="btn primary">Iniciar sesi√≥n</button>
            <button class="btn">Cerrar sesi√≥n</button>
          </div>
        </div>
        <div class="svc">
          <h4>Agregar cuenta manual</h4>
          <input class="input" placeholder="@usuario"/>
          <input class="input" placeholder="Token / Contrase√±a" type="password"/>
          <button class="btn primary">Guardar cuenta</button>
        </div>
      </div>
    </section>

    <section id="view-network" class="view">
      <div class="back" onclick="showView('home')">‚Üê Atr√°s</div>
      <h1 id="networkTitle">Servicios</h1>
      <div class="sub" id="networkSub">Selecciona un servicio para esta red</div>
      <div class="svc-grid" id="networkServices"></div>
    </section>
  </main>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard">
    <h4>Panel R√°pido</h4>
    <div class="stat">Acciones hoy: <span id="actions">0</span></div>
    <div class="stat">Dispositivos activos: <span id="devices">4</span></div>
    <span class="close" onclick="document.getElementById('dashboard').classList.remove('active')">‚úï</span>
  </div>

  <!-- BADGE -->
  <div class="credit">Created by Karmean Gomez</div>

  <!-- NAV -->
  <nav class="nav">
    <div class="item" data-go="home">Inicio</div>
    <div class="item" data-go="clients">Clientes</div>
    <div class="item" data-go="farm">Farm</div>
    <div class="item" data-go="accounts">Cuentas</div>
  </nav>

  <!-- MODAL FICHA -->
  <div class="modal" id="clientModal" role="dialog" aria-modal="true" aria-label="Ficha del cliente">
    <div class="sheet">
      <div class="close" data-close-modal>‚úï</div>
      <div class="top">
        <div id="mAvatarWrap" class="avatar-wrap"><img id="mAvatar" class="avatar" alt="avatar"/></div>
        <div>
          <div id="mUser" style="font-weight:800"></div>
          <div class="muted" id="mName"></div>
          <div class="meta">
            <div><b id="mPosts"></b> posts</div>
            <div><b id="mFollowers"></b> seguidores</div>
            <div><b id="mFollowing"></b> siguiendo</div>
          </div>
        </div>
      </div>
      <div class="bio" id="mBio"></div>
      <div style="margin-top:14px;display:flex;gap:10px">
        <a class="btn" id="mOpenIg" target="_blank" rel="noopener">Abrir Instagram</a>
        <button class="btn primary">Crear campa√±a</button>
      </div>
    </div>
  </div>

  <!-- MODAL PASSWORD -->
  <div class="modal" id="passwordModal" role="dialog" aria-modal="true" aria-label="Ingresar contrase√±a">
    <div class="sheet" style="max-width: 420px;">
      <div class="lock-robot-wrap" style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <svg class="lock-robot" viewBox="0 0 64 64" aria-hidden="true" style="width:44px;height:44px;filter:drop-shadow(0 0 8px rgba(25,194,255,.6))">
          <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="#19c2ff"/><stop offset="1" stop-color="#0077ff"/></linearGradient></defs>
          <rect x="2" y="10" width="60" height="44" rx="12" fill="url(#g2)"/>
          <rect x="8" y="16" width="48" height="32" rx="8" fill="#0b1220"/>
          <circle cx="22" cy="32" r="6" fill="#19c2ff"/><circle cx="42" cy="32" r="6" fill="#19c2ff"/>
          <rect x="28" y="40" width="8" height="4" rx="2" fill="#19c2ff"/>
        </svg>
        <h3 style="margin:0;font-weight:800">Enter password</h3>
      </div>
      <input id="passwordInput" class="input" type="password" placeholder="Password" autocomplete="current-password"/>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn primary" onclick="checkPassword()">Enter</button>
        <button class="btn ghost" onclick="document.getElementById('passwordInput').value = ''">Clear</button>
      </div>
      <div id="errorMessage" class="muted" style="margin-top:10px;display:none;color:#e0565b">Wrong password</div>
    </div>
  </div>

  <!-- ADMIN PANEL (secreto) -->
  <div id="adminPanel" class="modal" role="dialog" aria-modal="true" aria-label="Admin" style="backdrop-filter: blur(2px);">
    <div class="sheet" style="max-width:420px">
      <div class="close" data-close-modal>‚úï</div>
      <h3 style="margin-top:0">Admin</h3>
      <div class="muted" style="font-size:13px;margin-bottom:8px">Herramientas r√°pidas</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnAdminRetry">Reintentar conexi√≥n</button>
        <button class="btn" id="btnAdminFlush">Flush cache</button>
        <button class="btn" id="btnAdminWarm">Precalentar perfiles</button>
        <button class="btn" id="btnAdminPing">Ping x3</button>
        <button class="btn" id="btnAdminReboot">Reiniciar backend</button>
      </div>
      <div id="adminLog" class="muted" style="margin-top:10px;white-space:pre-wrap;font-size:12px"></div>
    </div>
  </div>

  <!-- SVGs -->
  <svg style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="igVerified" viewBox="0 0 24 24"><defs><radialGradient id="metaBlue" cx="50%" cy="40%" r="70%"><stop offset="0" stop-color="#67B7FF"/><stop offset="1" stop-color="#0B65FF"/></radialGradient></defs><path fill="url(#metaBlue)" d="M12 2.4l2.15 1.3 2.46-.14 1.15 2.17 2.17 1.15-.14 2.46 1.3 2.15-1.3 2.15.14 2.46-2.17 1.15-1.15 2.17-2.46-.14L12 21.6l-2.15-1.3-2.46.14-1.15-2.17-2.17-1.15.14-2.46L2.4 12l1.3-2.15-.14-2.46 2.17-1.15 1.15-2.17 2.46.14L12 2.4z"/><path fill="#fff" d="M10.25 14.6l-2.1-2.1 1.3-1.3 1.6 1.6 4.1-4.1 1.3 1.3-5.4 5.4z"/></symbol>
    <symbol id="ig" viewBox="0 0 24 24"><defs><linearGradient id="igG" x1="0" x2="1"><stop offset="0" stop-color="#ff7a00"/><stop offset="1" stop-color="#e600ff"/></linearGradient></defs><rect x="2" y="2" width="20" height="20" rx="5" fill="url(#igG)"/><circle cx="12" cy="12" r="4.2" fill="#fff"/><circle cx="18" cy="6" r="1.6" fill="#fff"/></symbol>
  </svg>

<script>
/* =======================
   API BASE
   ======================= */
let API_BASE = "https://api.kraveapi.xyz"; // cambia si hace falta (p.ej. LAN)
const apiUrl = (p) => `${API_BASE}${p}`;

/* Helper fetch con timeout y no-store */
function fetchWithTimeout(resource, options={}) {
  const { timeout = 8000, ...rest } = options;
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  const headers = new Headers(rest.headers||{});
  // Evita caches intermedios
  headers.set('Cache-Control','no-store');
  headers.set('Pragma','no-cache');
  return fetch(resource, { ...rest, signal: controller.signal, headers, cache:'no-store' })
    .finally(()=>clearTimeout(id));
}
function avatarSrc(u){ return apiUrl(`/avatar?username=${encodeURIComponent(u)}`); }

/* ====== Estado conexi√≥n real ====== */
const connEl=document.getElementById('conn');
const dotEl=document.getElementById('connDot');

function setConnState(ok, extra=''){
  if(ok){ connEl.textContent='Conectado'+(extra?' ¬∑ '+extra:''); dotEl.style.background='var(--success)'; }
  else { connEl.textContent='Sin conexi√≥n'; dotEl.style.background='#e0565b'; }
}

async function checkBackend(){
  // Si el navegador est√° offline, marca offline directo
  if(typeof navigator!=='undefined' && navigator && navigator.onLine===false){
    setConnState(false); return false;
  }
  try{
    // nonce para evitar proxy/CDN cache
    const url = apiUrl(`/health?nonce=${Date.now()}.${Math.random().toString(16).slice(2)}`);
    const r = await fetchWithTimeout(url, { timeout: 4500 });
    if(!r.ok) throw new Error('bad');
    // Forzamos leer el body; si no es JSON v√°lido, se toma como fallo
    const j = await r.json().catch(()=>null);
    if(j && j.status==='ok' && typeof j.nonce==='string'){
      setConnState(true, j.version||'');
      return true;
    }
    throw new Error('bad-json');
  }catch(_){
    setConnState(false);
    return false;
  }
}
checkBackend();
setInterval(checkBackend, 15000);

/* ====== Tema ====== */
const themeToggle=document.getElementById('themeToggle');
const savedTheme=localStorage.getItem('krave-theme');
if(savedTheme==='light')document.body.classList.add('light');
if(savedTheme==='neon')document.body.classList.add('neon-theme');
themeToggle.textContent=document.body.classList.contains('light')?'üåû':document.body.classList.contains('neon-theme')?'üí°':'üåô';
themeToggle.onclick=(e)=>{
  const menu=document.createElement('div');
  Object.assign(menu.style,{position:'absolute',top:'110%',right:'0',background:'var(--card)',border:'1px solid var(--line)',borderRadius:'10px',padding:'8px',zIndex:'1000'});
  menu.innerHTML=`<div style="padding:6px 10px;cursor:pointer">Claro</div><div style="padding:6px 10px;cursor:pointer">Ne√≥n</div><div style="padding:6px 10px;cursor:pointer">Oscuro</div>`;
  const [op1,op2,op3]=menu.children;
  op1.onclick=()=>{document.body.classList.add('light');document.body.classList.remove('neon-theme');localStorage.setItem('krave-theme','light');themeToggle.textContent='üåû';menu.remove()};
  op2.onclick=()=>{document.body.classList.add('neon-theme');document.body.classList.remove('light');localStorage.setItem('krave-theme','neon');themeToggle.textContent='üí°';menu.remove()};
  op3.onclick=()=>{document.body.classList.remove('light','neon-theme');localStorage.setItem('krave-theme','dark');themeToggle.textContent='üåô';menu.remove()};
  e.currentTarget.appendChild(menu);
};

/* ====== NAV ====== */
const views={home:document.getElementById('view-home'),clients:document.getElementById('view-clients'),farm:document.getElementById('view-farm'),accounts:document.getElementById('view-accounts'),network:document.getElementById('view-network')};
function showView(key){
  Object.entries(views).forEach(([k,v])=>{if(k===key){v.style.display='block';v.offsetHeight;v.classList.add('active')}else{v.classList.remove('active');v.style.display='none'}});
  document.querySelectorAll('.nav .item').forEach(i=>i.classList.toggle('active',i.getAttribute('data-go')===key));
  window.scrollTo({top:0,behavior:'smooth'});
}
document.querySelectorAll('.nav .item').forEach(el=>el.addEventListener('click',()=>showView(el.getAttribute('data-go'))));
showView('home');

/* ====== Ajuste badge ====== */
const navEl=document.querySelector('.nav');
function setNavHeight(){document.documentElement.style.setProperty('--nav-h',navEl.offsetHeight+'px')}
setNavHeight();addEventListener('resize',setNavHeight);addEventListener('orientationchange',setNavHeight);

/* ====== DATA REDES ====== */
const networks=[
  {key:'instagram',name:'Instagram',icon:'#ig',color:'#E1306C',services:['Likes','Comentarios','Seguidores','Vistas Reels','Compartidos','Guardados','Historias','Live Views']}
];

/* ====== RENDER GRID REDES ====== */
const socialGrid=document.getElementById('socialGrid');
socialGrid.innerHTML=networks.map(n=>`
  <div class="card" data-net="${n.key}">
    <div class="logo-wrap"><svg width="28" height="28"><use href="${n.icon}"></use></svg></div>
    <div class="title">${n.name}</div>
  </div>`).join('');
setTimeout(()=>socialGrid.querySelectorAll('.card').forEach(el=>el.classList.add('visible')),80);

/* ====== VERIFIED SVG ====== */
function verifiedSvg(){return `<svg class="ig-verified" viewBox="0 0 24 24" aria-hidden="true"><use href="#igVerified"></use></svg>`}

/* ====== CLIENTES (seed) ====== */
let clients=[
  {user:'cadillacf1',   name:'Cadillac Formula 1 Team', followers:'0', posts:'0', following:'0', verified:true},
  {user:'manuelturizo', name:'Manuel Turizo',           followers:'0', posts:'0', following:'0', verified:true},
  {user:'pesopluma',    name:'Peso Pluma',              followers:'0', posts:'0', following:'0', verified:true}
];
const pinnedClients=['cadillacf1','manuelturizo','pesopluma'];
function orderedClients(list=clients){
  const map=new Map(list.map(c=>[c.user,c]));
  const top=pinnedClients.map(u=>map.get(u)).filter(Boolean);
  const rest=list.filter(c=>!pinnedClients.includes(c.user));
  return [...top,...rest];
}

/* ====== CACHE LOCAL (15 min) ====== */
const LST_KEY='krave_profile_cache_v1';
const TTL_MS = 15*60*1000;
function loadCache(){ try{ return JSON.parse(localStorage.getItem(LST_KEY)||'{}'); }catch{ return {}; } }
function saveCache(store){ try{ localStorage.setItem(LST_KEY, JSON.stringify(store)); }catch{} }
function getCachedUser(u){
  const store=loadCache(); const ent=store[u];
  if(!ent) return null; if(Date.now()-ent.t>TTL_MS) return null; return ent.data;
}
function setCachedUser(u,data){
  const store=loadCache(); store[u]={t:Date.now(),data}; saveCache(store);
}

/* ====== NUMERO COMPACTO ====== */
function compactNumber(n){
  const num=Number(n);
  if(!isFinite(num)) return '0';
  if(num>=1_000_000) return (num/1_000_000).toFixed(1).replace(/\.0$/,'')+'M';
  if(num>=1_000) return (num/1_000).toFixed(1).replace(/\.0$/,'')+'K';
  return String(Math.round(num));
}

/* ====== APLICAR INFO REAL ====== */
function applyApiUserToClient(c, info){
  if(!info||typeof info!=='object') return;
  if(info.full_name)            c.name      = info.full_name;
  if(info.follower_count!=null) c.followers = compactNumber(info.follower_count);
  if(info.following_count!=null)c.following = String(info.following_count);
  if(info.media_count!=null)    c.posts     = String(info.media_count);
  if(info.biography)            c.bio       = info.biography;
  if(info.is_verified!=null)    c.verified  = !!info.is_verified;
}
function avatarUrl(u){ return avatarSrc(u); }

/* ====== UI HELPERS ====== */
function avatarWrapHtml(u){
  return `<div class="avatar-wrap"><img class="avatar" alt="" referrerpolicy="no-referrer" src="${avatarUrl(u)}"
    onerror="this.style.background='#2a3442'; this.removeAttribute('src')" /></div>`;
}

/* ====== HOME - recientes ====== */
const recentList=document.getElementById('recentList');
function paintRecent(){
  const _clients=orderedClients();
  recentList.innerHTML=_clients.map(c=>`
    <div class="row" data-user="${c.user}">
      ${avatarWrapHtml(c.user)}
      <div class="grow">
        <div class="user">@${c.user} ${c.verified?verifiedSvg():''}</div>
        <div class="muted">${c.name} ¬∑ ${(c.followers&&c.followers!=='0')?c.followers:'‚Äî'} seguidores</div>
      </div>
      <a class="chip" href="#" data-open="${c.user}">Ver ficha</a>
    </div>`).join('');
  setTimeout(()=>recentList.querySelectorAll('.row').forEach(el=>el.classList.add('visible')),80);
}

/* ====== CLIENTES (grid) ====== */
const clientsGrid=document.getElementById('clientsGrid');
function cardHtml(c){
  return `<div class="client-card" data-open="${c.user}">
    ${avatarWrapHtml(c.user)}
    <div class="grow">
      <div class="client-title">${c.name||c.user}${c.verified?verifiedSvg():''}</div>
      <div class="client-sub">@${c.user}</div>
      <div class="client-meta">${(c.followers&&c.followers!=='0')?c.followers:'‚Äî'} seguidores ¬∑ ${(c.posts&&c.posts!=='0')?c.posts:'‚Äî'} posts</div>
    </div>
  </div>`;
}
function paintClientsGrid(arr){
  const _arr=orderedClients(arr||clients);
  clientsGrid.innerHTML=_arr.map(cardHtml).join('');
  requestAnimationFrame(()=>clientsGrid.querySelectorAll('.client-card').forEach(el=>el.classList.add('visible')))
}

/* ====== BUSCADOR ====== */
document.getElementById('clientSearch').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase().trim();
  const filtered = clients.filter(c => c.user.toLowerCase().includes(q) || (c.name||'').toLowerCase().includes(q));
  paintClientsGrid(filtered);
});

/* ====== API REAL ====== */
async function fetchUser(username){
  const url = apiUrl(`/buscar-usuario?username=${encodeURIComponent(username)}`);
  const r = await fetchWithTimeout(url,{timeout:9000});
  if(!r.ok) throw new Error('bad');
  const j = await r.json();
  return j && (j.usuario || j.user || j.data || j);
}
async function hydrateClient(username){
  const idx = clients.findIndex(c=>c.user===username);
  if(idx===-1) return;
  const cached=getCachedUser(username);
  if(cached){ applyApiUserToClient(clients[idx], cached); paintRecent(); paintClientsGrid(clients); }

  try{
    const info = await fetchUser(username);
    if(info){ setCachedUser(username, info); applyApiUserToClient(clients[idx], info); }
    paintRecent(); paintClientsGrid(clients);
  }catch(_){}
}
async function hydrateAll(batchSize=5){
  const isUp = await checkBackend();
  if(!isUp) return; // si backend ca√≠do, no intentes hidratar
  const uniqueUsers=[...new Set(clients.map(c=>c.user))];
  for(let i=0;i<uniqueUsers.length;i+=batchSize){
    await Promise.all(uniqueUsers.slice(i,i+batchSize).map(u=>hydrateClient(u)));
    await new Promise(r=>setTimeout(r, 150)); // respiro corto
  }
}

/* ====== A√ëADIR CLIENTE ====== */
async function promptAdd(){
  const u=prompt('Usuario (sin @):'); if(!u) return;
  const n=prompt('Nombre para mostrar:') || u;
  const nuevo={user:u,name:n,followers:'0',posts:'0',following:'0',verified:true};
  const i = clients.findIndex(c=>c.user===u); if(i>=0) clients.splice(i,1);
  clients.unshift(nuevo);
  paintRecent(); paintClientsGrid(clients);
  hydrateClient(u);
}
document.getElementById('addClientBtn').addEventListener('click',promptAdd);
document.getElementById('addFromHome').addEventListener('click',()=>{showView('clients'); promptAdd()});

/* ====== MODAL (ficha) ====== */
const modal=document.getElementById('clientModal');
function fillModal(c){
  const av=document.getElementById('mAvatar'); av.src=avatarUrl(c.user);
  av.onerror=function(){this.style.background='#2a3442'; this.removeAttribute('src')};
  document.getElementById('mUser').innerHTML=`@${c.user} ${c.verified?verifiedSvg():''}`;
  document.getElementById('mName').textContent=c.name||'';
  document.getElementById('mPosts').textContent=c.posts||'0';
  document.getElementById('mFollowers').textContent=c.followers||'0';
  document.getElementById('mFollowing').textContent=c.following||'0';
  document.getElementById('mBio').textContent=c.bio||'';
  document.getElementById('mOpenIg').href=`https://instagram.com/${c.user}`;
}
function openCard(user){
  const c=clients.find(x=>x.user===user); if(!c) return;
  fillModal(c);
  modal.classList.add('show');
  hydrateClient(user);
}
function closeModal(){modal.classList.remove('show')}
document.addEventListener('click',(e)=>{
  if(e.target.hasAttribute('data-close-modal') || e.target===modal) closeModal();
  const openEl=e.target.closest('[data-open]'); if(openEl){e.preventDefault(); openCard(openEl.getAttribute('data-open')); }
});

/* ====== Render inicial ====== */
paintRecent(); paintClientsGrid(clients);
setTimeout(()=>hydrateAll(5), 600);
setInterval(()=>hydrateAll(5), 10*60*1000);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) hydrateAll(5); });

/* ====== ADMIN secreto (5 taps en el logo) ====== */
const adminPanel=document.getElementById('adminPanel');
const adminLog=document.getElementById('adminLog');
(function secretAdmin(){
  const brand=document.getElementById('brandTap');
  let taps=0, timer=null;
  function reset(){ taps=0; clearTimeout(timer); timer=null; }
  brand.addEventListener('click', ()=>{
    taps++; if(timer) clearTimeout(timer);
    timer=setTimeout(reset, 1000);
    if(taps>=5){ reset(); adminPanel.classList.add('show'); document.body.classList.add('locked'); }
  });
  adminPanel.addEventListener('click',(e)=>{ if(e.target===adminPanel || e.target.hasAttribute('data-close-modal')){ adminPanel.classList.remove('show'); document.body.classList.remove('locked'); }});
  const log=(m)=>{ adminLog.textContent = (adminLog.textContent?adminLog.textContent+'\n':'') + m; };
  document.getElementById('btnAdminRetry').onclick=async()=>{ log('Reintentando /health...'); const ok=await checkBackend(); log(ok?'OK':'FALL√ì'); };
  document.getElementById('btnAdminFlush').onclick=async()=>{
    try{ const r=await fetchWithTimeout(apiUrl('/flush-cache'),{timeout:6000}); log('Flush: '+(r.ok?'OK':'ERR '+r.status)); }catch{ log('Flush: timeout/ERR'); }
  };
  document.getElementById('btnAdminWarm').onclick=async()=>{
    try{ const users=[...new Set(clients.map(c=>c.user))].slice(0,20);
      const r=await fetchWithTimeout(apiUrl('/warmup?users='+encodeURIComponent(users.join(','))),{timeout:15000});
      const j=await r.json().catch(()=>({}));
      log('Warmup: '+(j?.ok?'OK '+(j.count||0)+' usuarios':'ERR'));
    }catch{ log('Warmup: timeout/ERR'); }
  };
  document.getElementById('btnAdminPing').onclick=async()=>{
    log('Ping x3:'); for(let i=1;i<=3;i++){ const ok=await checkBackend(); log(`  #${i}: ${ok?'OK':'FAIL'}`); await new Promise(r=>setTimeout(r,300)); }
  };
  document.getElementById('btnAdminReboot').onclick=async()=>{
    try{ const r=await fetchWithTimeout(apiUrl('/admin/reboot'),{method:'POST',timeout:6000}); log('Reboot: '+(r.ok?'202/OK (simulado)':'ERR '+r.status)); }catch{ log('Reboot: timeout/ERR'); }
  };
})();

/* ====== PWA ====== */
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(()=>{})})}
let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e; installBtn.classList.remove('hidden');});
installBtn.addEventListener('click',async()=>{if(!deferredPrompt) return; try{await deferredPrompt.prompt(); const choice=await deferredPrompt.userChoice; if(choice?.outcome==='accepted'){showToast('App instalada')}}catch(_){} deferredPrompt=null; installBtn.classList.add('hidden')});
window.addEventListener('appinstalled',()=>{showToast('App instalada'); installBtn.classList.add('hidden')});

/* ====== PASSWORD GATE (demo) ====== */
const validPasswords = new Set(['Andrick99','invitado25']);
document.body.classList.add('locked');
function checkPassword() {
  const input = document.getElementById('passwordInput').value;
  const errorMessage = document.getElementById('errorMessage');
  if (validPasswords.has(input)) {
    document.getElementById('passwordModal').classList.remove('show');
    document.body.classList.remove('locked');
    showToast('Access granted');
    document.getElementById('passwordInput').value='';
  } else {
    errorMessage.style.display = 'block';
    document.getElementById('passwordInput').value = '';
    showToast('Wrong password');
  }
}
document.getElementById('passwordModal').classList.add('show');
document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

/* TOAST */
function showToast(message){const t=document.createElement('div'); t.className='toast'; t.textContent=message;
  t.style.position='fixed'; t.style.bottom='calc(var(--nav-h,64px) + 80px)'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.background='var(--card)'; t.style.color='var(--text)'; t.style.padding='12px 20px'; t.style.borderRadius='12px';
  t.style.border='1px solid var(--line)'; t.style.boxShadow='0 4px 12px rgba(0,0,0,.1)'; t.style.zIndex='200'; t.style.opacity='0';
  document.body.appendChild(t); requestAnimationFrame(()=>{t.style.transition='opacity .3s'; t.style.opacity='1'}); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),300)},2300);
}

/* Fondo nodos */
(function createNodes(count){const bg=document.querySelector('.background-3d'); for(let i=0;i<count;i++){const n=document.createElement('div');n.className='node'; n.style.left=`${Math.random()*100}vw`; n.style.top=`${Math.random()*100}vh`; n.style.background='var(--brand)'; n.style.position='absolute'; n.style.width='4px';n.style.height='4px';n.style.borderRadius='50%'; bg.appendChild(n);}})(15);
</script>
</body>
</html>