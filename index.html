<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <title>KraveAI - Panel de Control</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Todos los estilos originales preservados */
    :root {
      --primary: #6e44ff;
      --primary-dark: #5a35d5;
      --secondary: #00c9b7;
      --dark: #121212;
      --darker: #0a0a0a;
      --light: #f0f0f0;
      --gray: #8c8ca1;
      --card-bg: #1a1a1a;
      --success: #4CAF50;
      --warning: #ff9800;
      --error: #f44336;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: linear-gradient(135deg, var(--darker), var(--dark));
      color: var(--light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      line-height: 1.6;
    }

    /* ... (todos los dem√°s estilos se mantienen igual) ... */
  </style>
</head>
<body>
  <!-- Header -->
  <div class="app-header">
    <div class="logo">
      <i class="fas fa-brain"></i>
      <span>KraveAI</span>
    </div>
    <div class="user-avatar">KG</div>
    <div class="refresh-btn" id="refresh-btn">
      <i class="fas fa-sync-alt"></i>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="app-content">
    <div class="section">
      <div class="section-title">
        <i class="fas fa-hashtag"></i> Redes sociales
      </div>
      <div class="section-subtitle">Domina todas tus redes con IA</div>

      <div class="social-grid">
        <a href="#" class="social-item" id="instagram-link">
          <div class="social-icon" style="background: rgba(225, 48, 108, 0.15);">
            <i class="fab fa-instagram" style="color: #E1306C;"></i>
          </div>
          <div class="social-name">Instagram</div>
        </a>
        <a href="#" class="social-item" id="tiktok-link">
          <div class="social-icon" style="background: rgba(105, 201, 208, 0.15);">
            <i class="fab fa-tiktok" style="color: #69C9D0;"></i>
          </div>
          <div class="social-name">Tiktok</div>
        </a>
        <a href="#" class="social-item" id="youtube-link">
          <div class="social-icon" style="background: rgba(255, 0, 0, 0.15);">
            <i class="fab fa-youtube" style="color: #FF0000;"></i>
          </div>
          <div class="social-name">YouTube</div>
        </a>
        <a href="#" class="social-item" id="spotify-link">
          <div class="social-icon" style="background: rgba(29, 185, 84, 0.15);">
            <i class="fab fa-spotify" style="color: #1DB954;"></i>
          </div>
          <div class="social-name">Spotify</div>
        </a>
        <a href="#" class="social-item" id="threads-link">
          <div class="social-icon" style="background: rgba(255, 255, 255, 0.15);">
            <i class="fab fa-threads" style="color: #fff;"></i>
          </div>
          <div class="social-name">Threads</div>
        </a>
      </div>

      <button class="beast-mode pulse">
        <i class="fas fa-paw"></i> Modo Bestia
      </button>

      <div class="status-indicator">
        <div class="status-dot" id="system-status-dot"></div>
        <span id="system-status-text">Conectando al backend...</span>
        <div id="active-accounts" style="margin-top:6px;font-size:0.85rem;color:#8c8ca1;"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <i class="fas fa-users"></i> Clientes recientes
      </div>

      <div class="clients-list">
        <div class="client-item">
          <div class="client-icon" style="background: rgba(225, 48, 108, 0.15);">
            <i class="fab fa-instagram" style="color: #E1306C;"></i>
          </div>
          <div class="client-info">
            <div class="client-name">arianaoficial</div>
            <div class="client-platform">Instagram</div>
          </div>
        </div>

        <div class="client-item">
          <div class="client-icon" style="background: rgba(255, 0, 0, 0.15);">
            <i class="fab fa-youtube" style="color: #FF0000;"></i>
          </div>
          <div class="client-info">
            <div class="client-name">plenkay</div>
            <div class="client-platform">YouTube</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <i class="fas fa-bolt"></i> Automatizaci√≥n
      </div>

      <div class="automation-box">
        <input type="text" placeholder="¬øQu√© quieres automatizar hoy?" id="automation-input">
        <button class="send-button" id="send-btn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <div class="created-by">
      Created by Karmean G√≥mez
    </div>
  </div>

  <!-- Instagram Panel -->
  <div id="instagram-panel">
    <div class="back-button" id="volver-inicio">
      <i class="fas fa-arrow-left"></i> Volver
    </div>

    <div class="app-content">
      <div class="section">
        <div class="section-title">
          <i class="fab fa-instagram" style="color: #E1306C;"></i> Panel de Instagram
        </div>
        <div class="section-subtitle">Elige qu√© deseas automatizar</div>

        <div class="instagram-grid">
          <div class="instagram-item">
            <div class="instagram-icon">üë•</div>
            <div class="instagram-name">Clientes</div>
          </div>
          <div class="instagram-item">
            <div class="instagram-icon">üîß</div>
            <div class="instagram-name">Servicios</div>
          </div>
          <div class="instagram-item">
            <div class="instagram-icon">‚ù§Ô∏è</div>
            <div class="instagram-name">Likes</div>
          </div>
          <div class="instagram-item">
            <div class="instagram-icon">‚ûï</div>
            <div class="instagram-name">Seguidores</div>
          </div>
          <div class="instagram-item">
            <div class="instagram-icon">üëÅÔ∏è</div>
            <div class="instagram-name">Vistas</div>
          </div>
          <div class="instagram-item" id="comments-link">
            <div class="instagram-icon">üí¨</div>
            <div class="instagram-name">Comentarios</div>
          </div>
          <div class="instagram-item">
            <div class="instagram-icon">üîÅ</div>
            <div class="instagram-name">Compartidos</div>
          </div>
          <div class="instagram-item" id="crear-cuentas-link">
            <div class="instagram-icon">‚ûï</div>
            <div class="instagram-name">Crear cuentas</div>
          </div>
          <div class="instagram-item" id="login-link">
            <div class="instagram-icon">üîê</div>
            <div class="instagram-name">Login</div>
          </div>
          <div class="instagram-item" id="ver-cuentas-link">
            <div class="instagram-icon">üìã</div>
            <div class="instagram-name">Ver cuentas generadas</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Accounts Panel -->
  <div id="create-accounts-panel">
    <div class="back-button" id="volver-instagram">
      <i class="fas fa-arrow-left"></i> Volver
    </div>

    <div class="app-content">
      <div class="section">
        <div class="section-title">
          <i class="fas fa-user-plus"></i> Crear nuevas cuentas
        </div>
        <div class="section-subtitle">
          Sistema automatizado para creaci√≥n de cuentas de Instagram
        </div>

        <div class="create-form">
          <div class="form-group">
            <label class="form-label">N√∫mero de cuentas a crear</label>
            <input type="number" id="account-count" class="form-input" value="5" min="1" max="100">
          </div>

          <div class="form-actions">
            <button class="form-btn cancel-btn" id="cancel-btn">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="form-btn submit-btn" id="create-btn">
              <i class="fas fa-play"></i> Iniciar creaci√≥n
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Panel -->
  <div id="login-panel">
    <div class="back-button" id="volver-login">
      <i class="fas fa-arrow-left"></i> Volver
    </div>

    <div class="app-content">
      <div class="section">
        <div class="section-title">
          <i class="fas fa-key"></i> Gesti√≥n de Sesiones
        </div>
        <div class="section-subtitle">Controla tus inicios de sesi√≥n en Instagram</div>

        <div class="create-form" id="login-form">
          <div class="form-group">
            <label class="form-label">Usuario de Instagram</label>
            <input type="text" id="login-username" class="form-input" placeholder="Usuario de Instagram">
          </div>

          <div class="form-group">
            <label class="form-label">Contrase√±a</label>
            <div style="position:relative;">
              <input type="password" id="login-password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <span id="togglePassword" style="position:absolute;right:15px;top:50%;transform:translateY(-50%);cursor:pointer;color:#8c8ca1;">üëÅÔ∏è</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Estado de sesi√≥n</label>
            <div class="status-indicator-panel" id="session-status">
              <div class="status-dot-panel"></div>
              <span id="session-status-text">No hay sesi√≥n activa</span>
            </div>
          </div>

          <div class="form-actions">
            <button class="form-btn submit-btn" id="login-btn">
              <i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n
            </button>
            <button class="form-btn cancel-btn" id="logout-btn">
              <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
            </button>
          </div>
        </div>

        <div class="create-form" style="margin-top: 20px;">
          <div class="form-title">
            <i class="fas fa-user-plus"></i> Agregar Cuenta Manual
          </div>
          <div class="form-group">
            <label class="form-label">Usuario</label>
            <input type="text" id="manual-username" class="form-input" placeholder="Ingresa el usuario" required>
          </div>
          <div class="form-group">
            <label class="form-label">Contrase√±a</label>
            <input type="password" id="manual-password" class="form-input" placeholder="Ingresa la contrase√±a" required>
          </div>
          <div class="form-actions">
            <button class="form-btn submit-btn" id="add-account-btn">
              <i class="fas fa-save"></i> Guardar Cuenta
            </button>
          </div>
        </div>

        <!-- Secci√≥n de cuentas activas -->
        <div class="create-form" style="margin-top: 20px;">
          <div class="form-group">
            <label class="form-label">Cuentas activas:</label>
            <ul id="cuentas-activas-list" class="cuentas-list">
              <li>Cargando cuentas...</li>
            </ul>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <div class="form-group">
            <label class="form-label">Buscar usuario de Instagram</label>
            <input type="text" id="username-search" class="form-input" placeholder="@usuario">
          </div>
          <button class="form-btn submit-btn" id="search-user-btn" style="width: 100%;">
            <i class="fas fa-search"></i> Buscar usuario
          </button>
          <div id="user-result" class="user-result">
            <div class="user-header">
              <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
              <div>
                <h3 id="user-username"></h3>
                <div id="user-fullname"></div>
              </div>
            </div>
            <div class="user-stats">
              <div class="stat">
                <div class="stat-value" id="user-posts">0</div>
                <div class="stat-label">Publicaciones</div>
              </div>
              <div class="stat">
                <div class="stat-value" id="user-followers">0</div>
                <div class="stat-label">Seguidores</div>
              </div>
              <div class="stat">
                <div class="stat-value" id="user-following">0</div>
                <div class="stat-label">Siguiendo</div>
              </div>
            </div>
            <div class="user-bio">
              <p id="user-bio-text"></p>
            </div>
            <div class="user-details">
              <span id="user-private" class="status-indicator-panel">
                <div class="status-dot-panel"></div>
                <span>Privado: Desconocido</span>
              </span>
              <span id="user-verified" class="status-indicator-panel">
                <div class="status-dot-panel"></div>
                <span>Verificado: No</span>
              </span>
              <span id="user-business" class="status-indicator-panel">
                <div class="status-dot-panel"></div>
                <span>Negocio: No</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Comments Panel -->
  <div id="comments-panel">
    <div class="back-button" id="volver-inicio-comments">
      <i class="fas fa-arrow-left"></i> Volver
    </div>
    <div class="app-content">
      <div class="section">
        <div class="section-title">
          <i class="fas fa-comments"></i> Automatizaci√≥n de Comentarios
        </div>
        <div class="section-subtitle">
          Configura y lanza comentarios masivos en Instagram.
        </div>
        <form id="formComentarios" class="create-form">
          <div class="form-group">
            <label class="form-label">URL del Post</label>
            <input type="text" name="url" class="form-input" placeholder="https://www.instagram.com/p/CXXXXX/" required>
          </div>
          <div class="form-group">
            <label class="form-label">Cantidad de Comentarios</label>
            <input type="number" name="cantidad" class="form-input" value="30" min="1" max="100" required>
          </div>
          <div class="form-group">
            <label class="form-label">Modo</label>
            <select name="modo" class="form-input">
              <option value="auto">Auto (basado en imagen)</option>
              <option value="personalizado">Personalizado (con estilo)</option>
              <option value="manual">Manual (pegar comentarios)</option>
            </select>
          </div>
          <div class="form-group" id="manualSection" style="display: none;">
            <label class="form-label">Comentarios Manuales</label>
            <textarea name="comentarios" class="form-input" placeholder="Pega un comentario por l√≠nea" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Apodo (Opcional)</label>
            <input type="text" name="apodo" class="form-input" placeholder="Ej: Gera">
          </div>
          <div class="form-group">
            <label class="form-label">Estilo</label>
            <input type="text" name="estilo" class="form-input" placeholder="Ej: fitness, sexy, guapo">
          </div>
          <div class="form-group">
            <label class="form-label">Actividad</label>
            <input type="text" name="actividad" class="form-input" placeholder="Ej: entrenador personal">
          </div>
          <div class="form-group">
            <label class="form-label">Ejemplos de Comentarios</label>
            <textarea name="ejemplos" class="form-input" placeholder="Un comentario por l√≠nea" rows="4"></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="form-btn submit-btn">Lanzar Comentarios</button>
            <button type="button" class="form-btn cancel-btn" id="cancelComment">Cancelar</button>
          </div>
        </form>
        <div id="commentStatus" class="status-indicator" style="display: none;">
          <div class="status-dot"></div>
          <span id="commentMessage"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="nav-bar">
    <a href="#" class="nav-item active">
      <i class="fas fa-home"></i>
      <span>Inicio</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-chart-line"></i>
      <span>Anal√≠tica</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-cogs"></i>
      <span>Ajustes</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Perfil</span>
    </a>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i> <span id="notification-text"></span>
  </div>

  <script>
    // Elementos DOM para navegaci√≥n
    const instagramLink = document.getElementById('instagram-link');
    const volverInicio = document.getElementById('volver-inicio');
    const crearCuentasLink = document.getElementById('crear-cuentas-link');
    const volverInstagram = document.getElementById('volver-instagram');
    const loginLink = document.getElementById('login-link');
    const volverLogin = document.getElementById('volver-login');
    const commentsLink = document.getElementById('comments-link');
    const volverInicioComments = document.getElementById('volver-inicio-comments');
    const instagramPanel = document.getElementById('instagram-panel');
    const createAccountsPanel = document.getElementById('create-accounts-panel');
    const loginPanel = document.getElementById('login-panel');
    const commentsPanel = document.getElementById('comments-panel');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notification-text');
    const automationInput = document.getElementById('automation-input');
    const sendBtn = document.getElementById('send-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const beastModeBtn = document.querySelector('.beast-mode');

    // Elementos para login y b√∫squeda
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const sessionStatus = document.getElementById('session-status');
    const sessionStatusText = document.getElementById('session-status-text');
    const addAccountBtn = document.getElementById('add-account-btn');
    const manualUsername = document.getElementById('manual-username');
    const manualPassword = document.getElementById('manual-password');
    const searchUserBtn = document.getElementById('search-user-btn');
    const usernameSearch = document.getElementById('username-search');
    const userResult = document.getElementById('user-result');
    const systemStatusDot = document.getElementById('system-status-dot');
    const systemStatusText = document.getElementById('system-status-text');
    const cuentasActivasList = document.getElementById('cuentas-activas-list');

    // Elementos para creaci√≥n de cuentas
    const cancelBtn = document.getElementById('cancel-btn');
    const createBtn = document.getElementById('create-btn');
    const accountCountInput = document.getElementById('account-count');

    // Configuraci√≥n de la API
    const API_URL = "https://api.kraveapi.xyz";

    // Estado
    let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    let cuentasActivasInterval;
    let cuentasActivas = [];

    // Mostrar notificaci√≥n
    function showNotification(message, isError = false) {
      notificationText.textContent = message;
      notification.classList.add('show');
      if (isError) {
        notification.classList.add('error');
      } else {
        notification.classList.remove('error');
      }
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Navegaci√≥n entre paneles (FUNCIONALIDAD CORREGIDA)
    instagramLink.addEventListener('click', function(e) {
      e.preventDefault();
      instagramPanel.classList.add('active');
      document.querySelector('.app-content').style.display = 'none';
    });

    volverInicio.addEventListener('click', function(e) {
      e.preventDefault();
      instagramPanel.classList.remove('active');
      document.querySelector('.app-content').style.display = 'block';
    });

    crearCuentasLink.addEventListener('click', function(e) {
      e.preventDefault();
      createAccountsPanel.classList.add('active');
      instagramPanel.classList.remove('active');
    });

    volverInstagram.addEventListener('click', function(e) {
      e.preventDefault();
      createAccountsPanel.classList.remove('active');
      instagramPanel.classList.add('active');
    });

    loginLink.addEventListener('click', function(e) {
      e.preventDefault();
      loginPanel.classList.add('active');
      instagramPanel.classList.remove('active');
      checkSessionStatus().then(() => {
        actualizarListaCuentasActivas();
        // Iniciar el intervalo para actualizar cada 30 segundos
        if (cuentasActivasInterval) {
          clearInterval(cuentasActivasInterval);
        }
        cuentasActivasInterval = setInterval(actualizarListaCuentasActivas, 30000);
      });
    });

    volverLogin.addEventListener('click', function(e) {
      e.preventDefault();
      loginPanel.classList.remove('active');
      instagramPanel.classList.add('active');
      // Limpiamos el intervalo
      if (cuentasActivasInterval) {
        clearInterval(cuentasActivasInterval);
      }
    });

    commentsLink.addEventListener('click', function(e) {
      e.preventDefault();
      commentsPanel.classList.add('active');
      instagramPanel.classList.remove('active');
    });

    volverInicioComments.addEventListener('click', function(e) {
      e.preventDefault();
      commentsPanel.classList.remove('active');
      instagramPanel.classList.add('active');
    });

    // Bot√≥n de enviar
    sendBtn.addEventListener('click', function() {
      if (automationInput.value.trim() !== '') {
        showNotification(`Automatizando: "${automationInput.value}"`);
        automationInput.value = '';
      }
    });

    // Bot√≥n de refresh
    refreshBtn.addEventListener('click', function() {
      this.style.animation = 'rotate 1s linear';
      showNotification('Datos actualizados');
      setTimeout(() => {
        this.style.animation = '';
      }, 1000);
    });

    // Bot√≥n Modo Bestia
    beastModeBtn.addEventListener('click', function() {
      this.innerHTML = '<i class="fas fa-paw"></i> ¬°Activando Modo Bestia!';
      this.style.background = 'linear-gradient(135deg, #ff8c00, #ff0080)';
      setTimeout(() => {
        this.innerHTML = '<i class="fas fa-paw"></i> ¬°Modo Bestia Activado!';
        this.style.background = 'linear-gradient(135deg, #00c9b7, #6e44ff)';
        showNotification('Modo Bestia activado');
      }, 1500);
    });

    // Conexi√≥n al backend
    async function checkBackendConnection() {
      try {
        const response = await fetch(`${API_URL}/health`);
        if (response.ok) {
          systemStatusDot.style.backgroundColor = 'var(--success)';
          systemStatusText.textContent = 'Conectado al backend | Sistema al 100%';
          return true;
        } else {
          throw new Error('Backend responded with error');
        }
      } catch (error) {
        systemStatusDot.style.backgroundColor = 'var(--error)';
        systemStatusText.textContent = 'Error de conexi√≥n con el backend';
        return false;
      }
    }

    // Funcionalidades de login (CORREGIDO)
    async function checkSessionStatus() {
      try {
        const response = await fetch(`${API_URL}/estado-sesion`);
        const data = await response.json();

        if (data.status === 'activo') {
          isLoggedIn = true;
          localStorage.setItem('isLoggedIn', 'true');
          sessionStatus.className = 'status-indicator-panel status-active';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
          sessionStatusText.textContent = `‚úÖ Sesi√≥n activa como @${data.usuario}`;
          document.getElementById('login-form').style.display = 'none';
          logoutBtn.classList.remove('hidden');
          showNotification(`Sesi√≥n activa como @${data.usuario}`);
        } else {
          isLoggedIn = false;
          localStorage.setItem('isLoggedIn', 'false');
          sessionStatus.className = 'status-indicator-panel status-error';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
          sessionStatusText.textContent = '‚ùå No hay sesi√≥n activa';
          document.getElementById('login-form').style.display = 'block';
          logoutBtn.classList.add('hidden');
        }
      } catch (error) {
        isLoggedIn = false;
        localStorage.setItem('isLoggedIn', 'false');
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = '‚ùå Error al verificar sesi√≥n';
        document.getElementById('login-form').style.display = 'block';
        logoutBtn.classList.add('hidden');
        showNotification('Error al verificar sesi√≥n', true);
      }
    }

    // Login principal (CORREGIDO)
    async function login() {
      const username = loginUsername.value.trim().replace('@', '');
      const password = loginPassword.value.trim();

      if (!username || !password) {
        showNotification('Por favor completa ambos campos', true);
        return;
      }

      try {
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';
        loginBtn.disabled = true;

        const response = await fetch(`${API_URL}/iniciar-sesion`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username, contrasena: password })
        });

        const data = await response.json();

        if (data.exito) {
          isLoggedIn = true;
          localStorage.setItem('isLoggedIn', 'true');
          sessionStatus.className = 'status-indicator-panel status-active';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--success)';
          sessionStatusText.textContent = `‚úÖ Sesi√≥n iniciada como @${data.usuario}`;
          document.getElementById('login-form').style.display = 'none';
          logoutBtn.classList.remove('hidden');
          showNotification(`Sesi√≥n iniciada como @${data.usuario}`);
          
          // Actualizar la lista de cuentas activas
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al iniciar sesi√≥n');
        }
      } catch (error) {
        sessionStatus.className = 'status-indicator-panel status-error';
        sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
        sessionStatusText.textContent = `‚ùå ${error.message}`;
        document.getElementById('login-form').style.display = 'block';
        logoutBtn.classList.add('hidden');
        showNotification(`Error: ${error.message}`, true);
      } finally {
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesi√≥n';
        loginBtn.disabled = false;
      }
    }

    // Logout principal (CORREGIDO)
    async function logout() {
      try {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cerrando...';
        logoutBtn.disabled = true;

        const response = await fetch(`${API_URL}/cerrar-sesion`);
        const data = await response.json();

        if (data.exito) {
          isLoggedIn = false;
          localStorage.setItem('isLoggedIn', 'false');
          sessionStatus.className = 'status-indicator-panel status-error';
          sessionStatus.querySelector('.status-dot-panel').style.backgroundColor = 'var(--error)';
          sessionStatusText.textContent = '‚ùå Sesi√≥n cerrada';
          document.getElementById('login-form').style.display = 'block';
          logoutBtn.classList.add('hidden');
          showNotification('Sesi√≥n cerrada correctamente');
        } else {
          throw new Error(data.mensaje || 'Error al cerrar sesi√≥n');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      } finally {
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n';
        logoutBtn.disabled = false;
      }
    }

    // Guardar cuentas manuales (CORREGIDO)
    async function addAccount() {
      const username = manualUsername.value.trim();
      const password = manualPassword.value.trim();

      if (!username || !password) {
        showNotification('Por favor completa ambos campos', true);
        return;
      }

      try {
        addAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        addAccountBtn.disabled = true;

        // CORRECCI√ìN: URL correcta sin typo
        const response = await fetch(`${API_URL}/guardar-cuenta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username, contrasena: password })
        });

        const data = await response.json();

        if (data.exito) {
          showNotification(`Cuenta @${username} guardada exitosamente`);
          manualUsername.value = '';
          manualPassword.value = '';
          
          // Manejo de challenge de verificaci√≥n
          if (data.mensaje && data.mensaje.includes("verificaci√≥n manual")) {
            showNotification("Instagram requiere verificaci√≥n manual. Acepta desde la app original.", true);
          } else {
            // Actualizar lista de cuentas activas
            actualizarListaCuentasActivas();
          }
        } else {
          throw new Error(data.mensaje || 'Error al guardar la cuenta');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      } finally {
        addAccountBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cuenta';
        addAccountBtn.disabled = false;
      }
    }

    // B√∫squeda de usuario (CORREGIDO)
    async function searchUser() {
      const username = usernameSearch.value.trim().replace('@', '');
      if (!username) {
        showNotification('Por favor ingresa un nombre de usuario', true);
        return;
      }

      try {
        searchUserBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
        searchUserBtn.disabled = true;

        const response = await fetch(`${API_URL}/buscar-usuario?username=${username}`);
        const userData = await response.json();

        // Validar que exista username
        if (!userData.username) {
          throw new Error('El usuario no existe o no se pudo obtener');
        }

        document.getElementById('user-avatar').src = userData.foto || 'https://via.placeholder.com/150?text=Sin+imagen';
        const usernameElement = document.getElementById('user-username');
        usernameElement.innerHTML = `@${userData.username}`;
        if (userData.verificado) {
          usernameElement.innerHTML += `
            <span class="verified-tick">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="12" fill="#0095f6"/>
                <path d="M9 12.5L11 14.5L15 10.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          `;
        }
        document.getElementById('user-fullname').textContent = userData.nombre || 'Sin nombre';
        document.getElementById('user-posts').textContent = userData.publicaciones?.toLocaleString() || '0';
        document.getElementById('user-followers').textContent = userData.seguidores?.toLocaleString() || '0';
        document.getElementById('user-following').textContent = userData.seguidos?.toLocaleString() || '0';
        document.getElementById('user-bio-text').textContent = userData.biografia || 'Sin biograf√≠a disponible';

        document.getElementById('user-private').innerHTML = `
          <div class="status-dot-panel" style="background-color: ${userData.privado ? 'var(--warning)' : 'var(--success)'}"></div>
          <span>Privado: ${userData.privado ? 'S√≠' : 'No'}</span>
        `;
        document.getElementById('user-verified').innerHTML = `
          <div class="status-dot-panel" style="background-color: ${userData.verificado ? 'var(--success)' : 'var(--gray)'}"></div>
          <span>Verificado: ${userData.verificado ? 'S√≠' : 'No'}</span>
        `;
        document.getElementById('user-business').innerHTML = `
          <div class="status-dot-panel" style="background-color: ${userData.negocio ? 'var(--primary)' : 'var(--gray)'}"></div>
          <span>Negocio: ${userData.negocio ? 'S√≠' : 'No'}</span>
        `;

        userResult.style.display = 'block';
        showNotification(`Usuario @${userData.username} encontrado`);
      } catch (error) {
        console.error('Error buscando usuario:', error);
        showNotification(`Error: ${error.message || 'No se pudo encontrar el usuario'}`, true);
        userResult.style.display = 'none';
      } finally {
        searchUserBtn.innerHTML = '<i class="fas fa-search"></i> Buscar usuario';
        searchUserBtn.disabled = false;
      }
    }

    // Funci√≥n para actualizar lista de cuentas activas (CORREGIDO)
    async function actualizarListaCuentasActivas() {
      const lista = document.getElementById("cuentas-activas-list");
      if (!lista) return;
      
      try {
        const response = await fetch(`${API_URL}/cuentas-activas`);
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        
        const data = await response.json();
        if (!data.exito) throw new Error(data.mensaje || 'Error al obtener cuentas activas');
        
        // Eliminar duplicados
        const uniqueAccounts = [];
        const seen = new Set();
        for (const acc of data.cuentas) {
          if (!seen.has(acc.username)) {
            seen.add(acc.username);
            uniqueAccounts.push(acc);
          }
        }

        if (uniqueAccounts.length === 0) {
          lista.innerHTML = "<li>No hay cuentas activas a√∫n</li>";
        } else {
          lista.innerHTML = "";
          uniqueAccounts.forEach(acc => {
            const item = document.createElement("li");
            item.innerHTML = `
              <div class="cuenta-info">
                <div class="status-dot" style="background-color:${acc.status === 'activo' ? 'var(--success)' : 'var(--warning)'}"></div>
                @${acc.username}
              </div>
              <div class="cuenta-actions">
                <button class="cuenta-btn" onclick="iniciarSesionCuenta('${acc.username}')">
                  <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="cuenta-btn" onclick="cerrarSesionCuenta('${acc.username}')">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            `;
            lista.appendChild(item);
          });
        }
      } catch (err) {
        lista.innerHTML = "<li>Error al cargar las cuentas</li>";
        console.error(err);
      }
    }

    // Funci√≥n para iniciar sesi√≥n con cuenta espec√≠fica (CORREGIDO)
    async function iniciarSesionCuenta(username) {
      try {
        showNotification(`Iniciando sesi√≥n con @${username}...`);
        
        const response = await fetch(`${API_URL}/iniciar-sesion-cuenta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username })
        });
        
        const data = await response.json();
        
        if (data.exito) {
          showNotification(`‚úÖ Sesi√≥n iniciada con @${username}`);
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al iniciar sesi√≥n');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      }
    }

    // Funci√≥n para cerrar sesi√≥n de cuenta espec√≠fica (CORREGIDO)
    async function cerrarSesionCuenta(username) {
      try {
        showNotification(`Cerrando sesi√≥n con @${username}...`);
        
        const response = await fetch(`${API_URL}/cerrar-sesion-cuenta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario: username })
        });
        
        const data = await response.json();
        
        if (data.exito) {
          showNotification(`‚úÖ Sesi√≥n cerrada con @${username}`);
          actualizarListaCuentasActivas();
        } else {
          throw new Error(data.mensaje || 'Error al cerrar sesi√≥n');
        }
      } catch (error) {
        showNotification(`Error: ${error.message}`, true);
      }
    }

    // Creaci√≥n de cuentas
    async function iniciarCreacionCuentas() {
      try {
        const cantidad = parseInt(accountCountInput.value);
        if (!cantidad || cantidad <= 0 || cantidad > 100) {
          showNotification('‚ö†Ô∏è Ingresa una cantidad v√°lida (1-100)', true);
          return;
        }
        showNotification('Funcionalidad de creaci√≥n pendiente de implementaci√≥n completa');
      } catch (error) {
        showNotification('‚ùå Error iniciando creaci√≥n de cuentas', true);
      }
    }

    // Event Listeners (CORREGIDOS)
    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', logout);
    addAccountBtn.addEventListener('click', addAccount);
    searchUserBtn.addEventListener('click', searchUser);
    usernameSearch.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchUser();
      }
    });
    createBtn.addEventListener('click', iniciarCreacionCuentas);

    // Inicializaci√≥n (CORREGIDA)
    document.addEventListener('DOMContentLoaded', async () => {
      showNotification('KraveAI listo - ¬°Bienvenido!');
      await checkBackendConnection();
      
      // Verificar estado de sesi√≥n al cargar
      await checkSessionStatus();
      
      // Cargar cuentas activas iniciales
      await actualizarListaCuentasActivas();
      
      // Verificar conexi√≥n peri√≥dicamente
      setInterval(async () => {
        await checkBackendConnection();
      }, 120000);
    });
    
    // Funcionalidad para mostrar/ocultar contrase√±a
    document.getElementById('togglePassword')?.addEventListener('click', () => {
      const pwd = document.getElementById('login-password');
      pwd.type = pwd.type === 'password' ? 'text' : 'password';
    });
  </script>
</body>
</html>
