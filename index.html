<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>KraveAI — Panel</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0B0D12">
<style>
/* ========================= TOKENS ========================= */
:root{
  /* Dark */
  --bg:#0a0e14; --elev:#0e131b; --card:#111827; --text:#e9eef7; --muted:#93a0b4; --line:#1f2a3a;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  --grad:linear-gradient(135deg,#7c5cff 0%,#00d3c2 100%);
  --r:14px; --gap:12px; --shadow:0 18px 40px rgba(0,0,0,.35);
  --safe-b: env(safe-area-inset-bottom, 0px);
}
[data-theme="light"]{
  --bg:#f7f8fb; --elev:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
  --shadow:0 12px 28px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:15px/1.45 system-ui,-apple-system,"SF Pro Text",Inter,Roboto;
}

/* ========================= LAYOUT ========================= */
.app{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}
.top{
  position:sticky;top:0;z-index:30;
  display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;
  padding:10px max(14px,env(safe-area-inset-left)) 8px max(14px,env(safe-area-inset-right));
  background:color-mix(in oklab,var(--elev) 92%, transparent);
  border-bottom:1px solid var(--line); backdrop-filter:saturate(1.1) blur(14px);
}
.brand{display:flex;align-items:center;gap:10px}
.badge{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:var(--grad)}
.word{font-weight:900;letter-spacing:.16em}
.status{justify-self:center;color:var(--muted);display:flex;align-items:center;gap:8px;font-size:.9rem}
.status .dot{width:8px;height:8px;border-radius:50%;background:#8b8b8b}
.theme-toggle{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;border:1px solid var(--line);background:rgba(255,255,255,.04);cursor:pointer}

.main{
  height: calc(var(--app-h, 100svh) - var(--top-h, 58px) - var(--nav-h, 70px) - var(--safe-b));
  padding:12px 14px;
  /* clave para evitar huecos: */
  min-height:0;
}
.main > .view{min-height:0;}

/* ========================= NAV BOTTOM ========================= */
.nav{
  position:sticky;bottom:0;z-index:25;
  display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
  padding:8px max(12px,env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom,0px)) max(12px,env(safe-area-inset-right));
  background:color-mix(in oklab,var(--elev) 92%, transparent);
  border-top:1px solid var(--line); backdrop-filter:saturate(1.1) blur(14px);
}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px;border-radius:12px;color:var(--muted);border:1px solid transparent;cursor:pointer}
.tab small{font-size:.74rem}
input[name="tab"]{position:absolute;opacity:0;pointer-events:none}
#t-home:checked ~ .app .nav label[for="t-home"],
#t-search:checked ~ .app .nav label[for="t-search"],
#t-clients:checked ~ .app .nav label[for="t-clients"],
#t-farm:checked ~ .app .nav label[for="t-farm"],
#t-acc:checked ~ .app .nav label[for="t-acc"]{
  color:var(--text); background:rgba(255,255,255,.05); border-color:var(--line)
}

/* ========================= VIEWS ========================= */
.view{display:none;height:100%}
#t-home:checked ~ .app .view[data-tab="home"],
#t-search:checked ~ .app .view[data-tab="serv"],
#t-clients:checked ~ .app .view[data-tab="clients"],
#t-farm:checked ~ .app .view[data-tab="farm"],
#t-acc:checked ~ .app .view[data-tab="acc"]{display:grid}

/* ====== HOME ====== */
.home{
  grid-template-rows:auto 1fr auto;
  gap:12px; max-width:980px; margin-inline:auto;
}
.h-hero{display:flex;align-items:center;justify-content:space-between;padding:6px 2px}
.h-hero h1{margin:0 0 2px;font-size:clamp(22px,4.6vw,28px)}
.h-hero p{margin:0;color:var(--muted)}
.s-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
.s-btn{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card);cursor:pointer}
.s-btn:hover{outline:2px solid color-mix(in oklab,var(--text) 16%, transparent)}
.s-ico{width:22px;height:22px;display:grid;place-items:center}

/* ====== CLIENTES ====== */
.clients{display:grid;gap:8px}
.c-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:var(--card)}
.c-ava{width:28px;height:28px;border-radius:50%;overflow:hidden;background:#0a0}
.c-u{font-weight:800}
.c-net{font-size:.86rem;color:var(--muted)}
.c-r{margin-left:auto;opacity:.9}

/* Quick */
.quick{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--line);border-radius:14px;background:var(--card)}
.quick input{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:.95rem}
.btn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
.btn-primary{border:0;background:var(--grad);color:#0b0d13}

/* ====== SERVICIOS ====== */
.serv{
  grid-template-rows:auto auto 1fr;
  gap:12px; max-width:1100px; margin-inline:auto;
  min-height:0; /* clave */
}
.s-head{display:flex;align-items:center;gap:10px}
.back{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.05);cursor:pointer}
.s-title{font-weight:900;font-size:1.1rem}
.s-chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);cursor:pointer}
.panel{
  height:100%; min-height:0; overflow:auto;
  border:1px solid var(--line);border-radius:14px;background:var(--card);padding:12px;
}
.s-grid-cards{
  display:grid;gap:12px;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
}
.s-card{
  display:grid;gap:10px;padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03)
}
.s-row{display:flex;gap:8px}
.s-row .input{flex:1}

/* ====== FARM ====== */
.farm{grid-template-rows:auto 1fr;gap:12px;max-width:1100px;margin-inline:auto;min-height:0}
.fgrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));overflow:auto}
.dev{display:grid;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card)}
.d-head{display:flex;align-items:center;justify-content:space-between;font-weight:800}
.screen{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000;height:180px;position:relative}
.screen iframe,.screen img,.screen video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.d-actions{display:flex;gap:8px;flex-wrap:wrap}

/* ====== ACC ====== */
.acc{grid-template-rows:auto 1fr;gap:12px;max-width:820px;margin-inline:auto;min-height:0}
.box{padding:12px;border:1px solid var(--line);border-radius:14px;background:var(--card)}
.box-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media (max-width:560px){.box-grid{grid-template-columns:1fr}}

/* ====== FIRMA ====== */
.credit{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom: calc(56px + var(--safe-b) + 10px);
  padding:8px 14px; border-radius:999px; font-weight:800; font-size:.88rem;
  color:var(--text); background:color-mix(in oklab,var(--elev) 96%, transparent);
  border:1px solid var(--line); pointer-events:none; z-index:40;
  animation:breath 4s ease-in-out infinite, glow 2.6s ease-in-out infinite;
}
@keyframes breath{50%{transform:translateX(-50%) scale(1.04)}}
@keyframes glow{
  0%{box-shadow:0 0 10px rgba(124,92,255,.45),0 0 18px rgba(0,211,194,.28)}
  50%{box-shadow:0 0 18px rgba(124,92,255,.75),0 0 30px rgba(0,211,194,.48)}
  100%{box-shadow:0 0 10px rgba(124,92,255,.45),0 0 18px rgba(0,211,194,.28)}
}

/* Helpers */
input, button { font-size:16px; } /* evita zoom iOS */
.section-title{font-weight:900;margin:2px 0 4px}
.hint{color:var(--muted);font-size:.86rem;margin:0 0 8px}
.hide{display:none}
svg.brand-icon{color:var(--text);}
</style>
</head>
<body>

<!-- TABS -->
<input type="radio" name="tab" id="t-home" checked>
<input type="radio" name="tab" id="t-search">
<input type="radio" name="tab" id="t-clients">
<input type="radio" name="tab" id="t-farm">
<input type="radio" name="tab" id="t-acc">

<!-- ========== SPRITE (LOGOS) ========== -->
<svg width="0" height="0" aria-hidden="true" style="position:absolute">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7c5cff"/><stop offset="100%" stop-color="#00d3c2"/></linearGradient>
    <symbol id="klogo" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="30" fill="url(#g)" opacity=".14"/><path d="M18 14h10v16l16-16h12L40 30l16 20H44L28 36v14H18V14z" fill="url(#g)"/>
    </symbol>

    <!-- Nav icons -->
    <symbol id="ico-home" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v9a2 2 0 0 1-2 2h-4v-7H9v7H5a2 2 0 0 1-2-2z" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-tools" viewBox="0 0 24 24"><path d="M3 21l6-6M7 3l3 3-2 2 6 6 2-2 3 3M14 7l3-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-users" viewBox="0 0 24 24"><path d="M7 14a4 4 0 1 1 4-4M3 21a6 6 0 0 1 12 0M17 11a3 3 0 1 1 6 0M15 21a6 6 0 0 1 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="ico-devices" viewBox="0 0 24 24"><rect x="3" y="4" width="14" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><rect x="19" y="8" width="2" height="8" rx="1" fill="currentColor"/></symbol>
    <symbol id="ico-lock" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="9" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="ico-left" viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></symbol>

    <!-- Verified IG (oficial) -->
    <symbol id="ig-verified" viewBox="0 0 24 24">
      <path d="M12 2.5l2 1.7 2.6-.6 1.2 2.4 2.6.7-.3 2.7 1.9 1.9-1.9 1.9.3 2.7-2.6.7-1.2 2.4-2.6-.6-2 1.7-2-1.7-2.6.6-1.2-2.4-2.6-.7.3-2.7-1.9-1.9 1.9-1.9-.3-2.7 2.6-.7 1.2-2.4 2.6.6 2-1.7z" fill="#1095F6"/>
      <path d="M8.2 12.4l2.2 2.2 5.4-5.8" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Brand logos -->
    <symbol id="logo-instagram" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="12" cy="12" r="4" fill="none" stroke="#E1306C" stroke-width="2"/>
      <circle cx="17.2" cy="6.8" r="1.2" fill="#E1306C"/>
    </symbol>
    <symbol id="logo-tiktok" viewBox="0 0 24 24">
      <path d="M10 4v9a4 4 0 1 1-3 6.6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M14 4c.6 2.6 2.6 4.3 5 4.7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="logo-youtube" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="3" fill="#FF0000"/><path d="M10 9l6 3-6 3z" fill="#fff"/></symbol>
    <symbol id="logo-threads" viewBox="0 0 24 24">
      <path d="M6 12c0-4 3-7 6-7s6 3 6 7-3 7-6 7c-2 0-3.5-1-3.5-2.5S9 14 12 14c2.5 0 3.8-1.2 3.8-3S14.5 8 12 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="logo-x" viewBox="0 0 24 24"><path d="M4 4l16 16M20 4L4 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    <symbol id="logo-facebook" viewBox="0 0 24 24"><path d="M14 8h3V5h-3c-2 0-3 .9-3 3v2H8v3h3v6h3v-6h3l1-3h-4V8c0-.7.3-1 1-1z" fill="#1877F2"/></symbol>
    <symbol id="logo-linkedin" viewBox="0 0 24 24"><rect x="3" y="8" width="4" height="12" fill="#0A66C2"/><circle cx="5" cy="5.5" r="2" fill="#0A66C2"/><rect x="9" y="8" width="12" height="12" rx="2" fill="none" stroke="#0A66C2" stroke-width="2"/></symbol>
    <symbol id="logo-spotify" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#1DB954"/><path d="M7 10c3-1 7-1 10 1M7 13c3-1 6-1 9 1M7 16c2-.5 4-.5 6 .5" stroke="#fff" stroke-width="2" fill="none"/></symbol>
    <symbol id="logo-telegram" viewBox="0 0 24 24"><path d="M21 3L3 11l6 2 2 6 3-4 4-10z" fill="#0088cc"/></symbol>
    <symbol id="logo-whatsapp" viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 1 0 18 9.4 9.4 0 0 1-4-.9L5 21l.9-3.1A9.4 9.4 0 0 1 3 12 9 9 0 0 1 12 3z" fill="#25D366"/><path d="M9 8c0 3 3 6 5 6l1-1" stroke="#fff" stroke-width="2"/></symbol>
  </defs>
</svg>

<div class="app" id="app">
  <!-- Top -->
  <header class="top">
    <div class="brand">
      <div class="badge"><svg viewBox="0 0 64 64" width="20" height="20"><use href="#klogo"/></svg></div>
      <div class="word">KraveAI</div>
    </div>
    <div class="status"><span class="dot" id="status-dot"></span><small id="status-text">Conectando…</small></div>
    <div class="theme-toggle" id="themeToggle" title="Tema"><span id="themeEmoji">🌙</span></div>
  </header>

  <!-- Main -->
  <main class="main">

    <!-- HOME -->
    <section class="view home" data-tab="home">
      <div class="h-hero">
        <div>
          <h1>Redes sociales</h1>
          <p>Domina todas tus redes con IA</p>
        </div>
      </div>

      <div>
        <div class="section-title">Redes sociales</div>
        <div class="s-grid" id="socialGrid"></div>
      </div>

      <div>
        <div class="section-title">Clientes recientes</div>
        <div class="clients" id="clientsBrief"></div>
      </div>

      <div class="quick">
        <span>➕</span>
        <input id="quickInput" placeholder="¿Qué quieres automatizar hoy?">
        <button class="btn btn-primary" id="quickRun">Enviar</button>
      </div>
    </section>

    <!-- SERVICIOS -->
    <section class="view serv" data-tab="serv">
      <div class="s-head">
        <div class="back" id="backHome"><svg width="18" height="18"><use href="#ico-left"/></svg> Atrás</div>
        <div class="s-title" id="servTitle">Servicios</div>
      </div>
      <div class="s-chips" id="servChips"></div>
      <div class="panel" id="servPanel">
        <!-- tarjetas se renderizan aquí -->
      </div>
    </section>

    <!-- CLIENTES -->
    <section class="view clients-page" data-tab="clients">
      <div class="section-title">Clientes recientes</div>
      <div class="clients" id="clientsFull"></div>
    </section>

    <!-- DEVICE FARM -->
    <section class="view farm" data-tab="farm">
      <div class="section-title">Device Farm</div>
      <div class="hint">Streams: HLS .m3u8, MJPEG .mjpg o visor https (se guarda en localStorage).</div>
      <div class="fgrid" id="farmGrid"></div>
    </section>

    <!-- CUENTAS -->
    <section class="view acc" data-tab="acc">
      <div class="box">
        <div style="display:flex;align-items:center;gap:10px"><svg width="20" height="20"><use href="#ico-lock"/></svg><strong>Sesión</strong></div>
        <div class="hint" id="sessionSub">Verificando…</div>
        <div class="box-grid">
          <div class="input" style="grid-column:1/-1"><span>@</span><input id="loginUser" placeholder="Usuario"></div>
          <div class="input" style="grid-column:1/-1"><span>🔒</span><input id="loginPass" type="password" placeholder="Contraseña"></div>
          <button class="btn btn-primary" id="loginBtn">Iniciar sesión</button>
          <button class="btn" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>

      <!-- Buscador IG -->
      <div class="box" id="userSearchBox">
        <div style="display:flex;align-items:center;gap:10px">
          <svg width="20" height="20"><use href="#ico-users"/></svg>
          <strong>Buscar usuario de Instagram</strong>
        </div>
        <div class="box-grid">
          <div class="input" style="grid-column:1/-1">
            <span>@</span><input id="igSearchUser" placeholder="@usuario (sin espacios)">
          </div>
          <button class="btn btn-primary" id="igSearchBtn">Buscar</button>
        </div>
        <div id="igSearchResult" class="clients" style="margin-top:10px"></div>
      </div>

      <div class="box">
        <div style="display:flex;align-items:center;gap:10px"><svg width="20" height="20"><use href="#logo-instagram"/></svg><strong>Agregar cuenta manual</strong></div>
        <div class="box-grid">
          <div class="input" style="grid-column:1/-1"><span>@</span><input id="manualUser" placeholder="@usuario"></div>
          <div class="input" style="grid-column:1/-1"><span>🔒</span><input id="manualPass" type="password" placeholder="••••••••"></div>
          <button class="btn btn-primary" id="addAccBtn">Guardar cuenta</button>
        </div>
      </div>

      <div class="box">
        <div style="display:flex;align-items:center;gap:10px"><svg width="20" height="20"><use href="#ico-users"/></svg><strong>Cuentas activas</strong></div>
        <div id="accountsList" class="clients"><div class="hint">Cargando…</div></div>
      </div>
    </section>

  </main>

  <!-- Bottom Nav -->
  <nav class="nav">
    <label class="tab" for="t-home"><svg width="18" height="18"><use href="#ico-home"/></svg><small>Inicio</small></label>
    <label class="tab" for="t-acc"><svg width="18" height="18"><use href="#ico-users"/></svg><small>Buscar</small></label>
    <label class="tab" for="t-clients"><svg width="18" height="18"><use href="#ico-users"/></svg><small>Clientes</small></label>
    <label class="tab" for="t-farm"><svg width="18" height="18"><use href="#ico-devices"/></svg><small>Farm</small></label>
    <label class="tab" for="t-acc"><svg width="18" height="18"><use href="#ico-lock"/></svg><small>Cuentas</small></label>
  </nav>
</div>

<!-- Firma -->
<div class="credit">Created by Karmean Gómez</div>

<script>
(function(){
  const API_URL = "https://api.kraveapi.xyz";

  /* ===== Altura real ===== */
  function setLayoutHeights(){
    const app = document.getElementById('app');
    const top = app.querySelector('.top');
    const nav = app.querySelector('.nav');
    const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--app-h', vh + 'px');
    const topH = top?.getBoundingClientRect().height || 58;
    const navH = nav?.getBoundingClientRect().height || 70;
    document.documentElement.style.setProperty('--top-h',  Math.round(topH) + 'px');
    document.documentElement.style.setProperty('--nav-h',  Math.round(navH) + 'px');
    const safeB = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-b'))||0;
    const credit = document.querySelector('.credit');
    if(credit){ credit.style.bottom = `calc(${Math.round(navH)}px + ${safeB}px + 10px)`; }
  }
  setLayoutHeights();
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', setLayoutHeights);
    window.visualViewport.addEventListener('scroll', setLayoutHeights);
  }
  window.addEventListener('orientationchange', setLayoutHeights, {passive:true});
  window.addEventListener('resize', setLayoutHeights, {passive:true});

  /* ===== Tema ===== */
  const themeToggle = document.getElementById('themeToggle');
  const themeEmoji = document.getElementById('themeEmoji');
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeEmoji.textContent = savedTheme==='dark' ? '🌙' : '☀️';
  themeToggle.addEventListener('click', ()=>{
    const t = document.documentElement.getAttribute('data-theme')==='dark' ? 'light':'dark';
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    themeEmoji.textContent = t==='dark' ? '🌙' : '☀️';
  });

  /* ===== Salud backend ===== */
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  async function checkHealth(){
    try{
      const r = await fetch(`${API_URL}/health`, {credentials:'include'});
      if(r.ok){statusDot.style.background='var(--ok)'; statusText.textContent='Conectado';}
      else throw new Error(await r.text());
    }catch{ statusDot.style.background='var(--err)'; statusText.textContent='Sin conexión'; }
  }
  checkHealth(); setInterval(checkHealth, 120000);

  /* ===== GRID redes ===== */
  const networks = [
    {key:'instagram', name:'Instagram', icon:'#logo-instagram'},
    {key:'tiktok', name:'TikTok', icon:'#logo-tiktok'},
    {key:'youtube', name:'YouTube', icon:'#logo-youtube'},
    {key:'threads', name:'Threads', icon:'#logo-threads'},
    {key:'x', name:'X', icon:'#logo-x'},
    {key:'facebook', name:'Facebook', icon:'#logo-facebook'},
    {key:'linkedin', name:'LinkedIn', icon:'#logo-linkedin'},
    {key:'spotify', name:'Spotify', icon:'#logo-spotify'},
    {key:'telegram', name:'Telegram', icon:'#logo-telegram'},
    {key:'whatsapp', name:'WhatsApp', icon:'#logo-whatsapp'}
  ];
  const socialGrid = document.getElementById('socialGrid');
  socialGrid.innerHTML = networks.map(n => `
    <button class="s-btn" data-net="${n.key}">
      <span class="s-ico"><svg width="22" height="22" class="brand-icon"><use href="${n.icon}"/></svg></span>
      <span>${n.name}</span>
    </button>`).join('');

  /* ===== Clientes mock ===== */
  const IG_VER = '<svg class="c-verified"><use href="#ig-verified"/></svg>';
  const CLIENTS = [
    {user:'@aaronmercury', net:'Instagram', avatar:'', verified:true},
    {user:'@televisadigital', net:'Instagram', avatar:'', verified:true},
    {user:'@joscanela', net:'Instagram', avatar:'', verified:true},
    {user:'@jimenagallegotv', net:'Instagram', avatar:'', verified:true},
  ];
  const brief = document.getElementById('clientsBrief');
  const full = document.getElementById('clientsFull');
  function avatarFor(c){
    if(c.avatar) return `<img class="c-ava" src="${c.avatar}" alt="">`;
    const map = {Instagram:'#logo-instagram', YouTube:'#logo-youtube', TikTok:'#logo-tiktok'};
    const use = map[c.net] || '#logo-instagram';
    return `<div class="c-ava" style="display:grid;place-items:center;background:rgba(255,255,255,.06)">
              <svg width="18" height="18" class="brand-icon"><use href="${use}"/></svg>
            </div>`;
  }
  if(brief){
    brief.innerHTML = CLIENTS.slice(0,4).map(c=>`
      <div class="c-item">
        ${avatarFor(c)}
        <div>
          <div class="c-u">${c.user} ${c.verified?IG_VER:''}</div>
          <div class="c-net">${c.net}</div>
        </div>
        <div class="c-r"><svg width="18" height="18" class="brand-icon"><use href="#logo-instagram"/></svg></div>
      </div>`).join('');
  }
  if(full){
    full.innerHTML = CLIENTS.map(c=>`
      <div class="c-item">
        ${avatarFor(c)}
        <div>
          <div class="c-u">${c.user} ${c.verified?IG_VER:''}</div>
          <div class="c-net">${c.net}</div>
        </div>
        <div class="c-r"><svg width="18" height="18" class="brand-icon"><use href="#logo-instagram"/></svg></div>
      </div>`).join('');
  }

  /* ===== Quick ===== */
  function toast(msg, err){
    const el=document.createElement('div'); el.textContent=msg;
    el.style.cssText=`position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:9999;
      background:${err?'#ef4444':'#1f2937'};color:#fff;padding:8px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.15);box-shadow:0 6px 15px rgba(0,0,0,.2);font-weight:700`;
    document.body.appendChild(el); setTimeout(()=>el.remove(),2000);
  }
  document.getElementById('quickRun').addEventListener('click', ()=>{
    const v=(document.getElementById('quickInput').value||'').trim();
    if(!v) return toast('Escribe qué automatizar', true);
    toast('Automatizando: '+v);
    document.getElementById('quickInput').value='';
  });

  /* ===== Servicios ===== */
  const servTitle = document.getElementById('servTitle');
  const servChips = document.getElementById('servChips');
  const servPanel = document.getElementById('servPanel');

  // catálogo de servicios por red
  const SERVICES_BY_NET = {
    instagram: ['Likes','Comentarios','Seguidores','Vistas','Historias'],
    tiktok: ['Vistas','Likes','Seguidores'],
    youtube: ['Vistas','Likes','Suscripciones','Comentarios'],
    threads: ['Likes','Respuestas'],
    x: ['Likes','Reposts','Seguidores','Respuestas'],
    facebook: ['Reacciones','Comentarios','Compartidos'],
    linkedin: ['Reacciones','Comentarios','Conexiones','Visitas'],
    spotify: ['Streams','Saves'],
    telegram: ['Mensajes','Miembros','Reacciones'],
    whatsapp: ['Mensajes','Grupos','Respuestas']
  };

  // definición de endpoints/inputs por servicio (genérico)
  const SERVICE_DEFS = {
    Likes:       {slug:'likes',       fields:['url','cantidad']},
    Comentarios: {slug:'comentarios', fields:['url','cantidad','modo','apodo','estilo','actividad','ejemplos']},
    Seguidores:  {slug:'seguidores',  fields:['usuario','cantidad']},
    Vistas:      {slug:'vistas',      fields:['url','cantidad']},
    Historias:   {slug:'historias',   fields:['usuario','cantidad']},
    Suscripciones:{slug:'suscripciones',fields:['url','cantidad']},
    Respuestas:  {slug:'respuestas',  fields:['url','cantidad']},
    Reposts:     {slug:'reposts',     fields:['url','cantidad']},
    Reacciones:  {slug:'reacciones',  fields:['url','cantidad']},
    Conexiones:  {slug:'conexiones',  fields:['usuario','cantidad']},
    Visitas:     {slug:'visitas',     fields:['usuario','cantidad']},
    Streams:     {slug:'streams',     fields:['track','cantidad']},
    Saves:       {slug:'saves',       fields:['track','cantidad']},
    Mensajes:    {slug:'mensajes',    fields:['chat','mensaje','cantidad']},
    Miembros:    {slug:'miembros',    fields:['grupo','cantidad']},
    Compartidos: {slug:'compartidos', fields:['url','cantidad']},
    Grupos:      {slug:'grupos',      fields:['nombre','cantidad']}
  };

  // mapeo de placeholders
  const PH = {
    url:'URL del post (https://…)', cantidad:'Cantidad', modo:'Modo (auto/personalizado)',
    apodo:'Apodo (opcional)', estilo:'Estilo (fitness, etc)', actividad:'Actividad (entrenador, etc)',
    ejemplos:'Ejemplos (uno por línea)', usuario:'@usuario', track:'URL o ID del track',
    chat:'@usuario o link al chat', mensaje:'Mensaje', grupo:'@grupo', nombre:'Nombre del grupo'
  };

  function fieldInput(name){
    const type = (name==='cantidad')?'number':'text';
    const extra = name==='cantidad' ? 'min="1" max="10000" value="30"' : '';
    return `<div class="input"><span>✚</span><input name="${name}" ${extra} placeholder="${PH[name]||name}"></div>`;
  }

  function serviceCard(net, serviceName){
    const def = SERVICE_DEFS[serviceName];
    const fields = def?.fields || ['url','cantidad'];
    return `
      <div class="s-card" data-net="${net}" data-s="${serviceName}">
        <div style="font-weight:800">${serviceName}</div>
        <div class="s-row">${fields.slice(0,2).map(fieldInput).join('')}</div>
        ${fields.length>2 ? `<div class="s-row">${fields.slice(2,4).map(fieldInput).join('')}</div>`:''}
        ${fields.length>4 ? `<div class="s-row">${fields.slice(4,6).map(fieldInput).join('')}</div>`:''}
        ${fields.includes('modo') ? `
          <datalist id="modos"><option value="auto"><option value="personalizado"><option value="manual"></datalist>
          <script>/* noop: datalist global */</script>` : '' }
        ${fields.includes('modo') ? '' : ''}
        ${fields.includes('modo') ? '' : ''}
        ${fields.includes('modo') ? '' : ''}
        ${fields.includes('modo') ? '' : ''}
        <div class="s-row">
          <button class="btn btn-primary s-run">Lanzar</button>
          <button class="btn s-cancel">Cancelar</button>
        </div>
        <div class="hint s-status">—</div>
      </div>`;
  }

  function renderServiceChips(key){
    const items = SERVICES_BY_NET[key]||[];
    servChips.innerHTML = items.map(s=>`<button class="chip" data-s="${s}">${s}</button>`).join('');
  }

  function renderServicePanel(netKey){
    const items = SERVICES_BY_NET[netKey]||[];
    servPanel.innerHTML = `<div class="s-grid-cards">${items.map(s=>serviceCard(netKey,s)).join('')}</div>`;
    attachServiceHandlers();
  }

  function attachServiceHandlers(){
    servPanel.querySelectorAll('.s-card').forEach(card=>{
      const status = card.querySelector('.s-status');
      const run = card.querySelector('.s-run');
      const cancel = card.querySelector('.s-cancel');
      run.onclick = async ()=>{
        const net = card.dataset.net;
        const service = card.dataset.s;
        const def = SERVICE_DEFS[service]||{slug:service.toLowerCase(),fields:[]};
        const payload = {};
        card.querySelectorAll('input').forEach(i=>{
          const k=i.name; const v=(i.value||'').trim();
          if(v) payload[k]= (k==='cantidad')? Number(v) : v;
        });
        if(def.fields.includes('url') && !payload.url){ status.textContent='❌ Falta URL'; return; }
        if(def.fields.includes('usuario') && !payload.usuario){ status.textContent='❌ Falta usuario'; return; }
        try{
          status.textContent='Enviando…';
          const r = await fetch(`${API_URL}/${net}/${def.slug}`,{
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
            body:JSON.stringify(payload)
          });
          const d = await r.json().catch(()=>({}));
          if(r.ok){ status.textContent='✅ En proceso'; toast(`${service} lanzado`); }
          else throw new Error(d.mensaje||'Error');
        }catch(err){ status.textContent='❌ '+err.message; toast(err.message,true); }
      };
      cancel.onclick = ()=>{ status.textContent='—'; card.querySelectorAll('input').forEach(i=>i.value=''); };
    });
  }

  socialGrid.addEventListener('click',(e)=>{
    const b=e.target.closest('.s-btn'); if(!b) return;
    const key=b.dataset.net;
    document.getElementById('t-search').checked=true;
    openNetwork(key);
  });

  function openNetwork(key){
    const n = networks.find(n=>n.key===key); if(!n) return;
    servTitle.textContent = `Servicios · ${n.name}`;
    renderServiceChips(key);
    renderServicePanel(key); // panel lleno (tarjetas)
  }

  servChips.addEventListener('click',(e)=>{
    const c=e.target.closest('.chip'); if(!c) return;
    const key = (servTitle.textContent.split('·')[1]||'').trim().toLowerCase();
    const netKey = networks.find(n=>n.name.toLowerCase()===key)?.key;
    if(netKey){
      // scroll al card del servicio seleccionado
      const idx = (SERVICES_BY_NET[netKey]||[]).indexOf(c.dataset.s);
      const target = servPanel.querySelectorAll('.s-card')[idx];
      if(target){ target.scrollIntoView({behavior:'smooth',block:'start'}); }
    }
  });

  // Atrás
  document.getElementById('backHome').addEventListener('click', ()=>{ document.getElementById('t-home').checked=true; });

  /* ===== Farm ===== */
  const DEVICES = [
    {id:'dev1',name:'iPhone 14 Pro',os:'iOS',ip:'10.0.0.8'},
    {id:'dev2',name:'Galaxy S23',os:'Android',ip:'10.0.0.9'},
    {id:'dev3',name:'iPhone 13',os:'iOS',ip:'10.0.0.10'},
    {id:'dev4',name:'Pixel 8',os:'Android',ip:'10.0.0.11'},
    {id:'dev5',name:'iPhone 12 mini',os:'iOS',ip:'10.0.0.12'},
    {id:'dev6',name:'Galaxy A54',os:'Android',ip:'10.0.0.13'},
  ];
  const farmGrid = document.getElementById('farmGrid');
  function renderFarm(){
    farmGrid.innerHTML = DEVICES.map(d=>{
      const src = localStorage.getItem('stream:'+d.id)||'';
      return `
      <div class="dev">
        <div class="d-head"><div>${d.name} · ${d.os}</div><div style="opacity:.7">${d.ip}</div></div>
        <div class="screen">
          ${src ? (
            (src.endsWith('.mjpg')||src.endsWith('.mjpeg'))?`<img src="${src}">`:
            (src.endsWith('.m3u8'))?`<video src="${src}" autoplay muted playsinline></video>`:
            `<iframe src="${src}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`
          ) : '<div style="position:absolute;inset:0;background:radial-gradient(120% 80% at 10% 10%, rgba(124,92,255,.22), transparent 60%),radial-gradient(120% 80% at 90% 90%, rgba(0,211,194,.18), transparent 60%),#000"></div>'}
        </div>
        <div class="d-actions">
          <button class="btn btn-primary" data-set="${d.id}">Asignar stream</button>
          <button class="btn" data-clear="${d.id}">Limpiar</button>
        </div>
      </div>`}).join('');
  }
  renderFarm();
  farmGrid.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.set){
      const id=b.dataset.set; const cur=localStorage.getItem('stream:'+id)||'';
      const url=prompt('URL stream (HLS .m3u8, MJPEG .mjpg, o https):',cur);
      if(url!==null){ localStorage.setItem('stream:'+id,url.trim()); renderFarm(); toast('Stream actualizado'); }
    }
    if(b.dataset.clear){
      const id=b.dataset.clear; localStorage.removeItem('stream:'+id); renderFarm(); toast('Stream limpiado');
    }
  });

  /* ===== Cuentas ===== */
  const sessionSub=document.getElementById('sessionSub');
  async function checkSession(){
    try{
      const r=await fetch(`${API_URL}/estado-sesion`,{credentials:'include'});
      const d=await r.json();
      sessionSub.textContent=(d.status==='activo')?`Sesión activa como @${d.usuario}`:'No hay sesión activa';
    }catch{ sessionSub.textContent='Error al verificar sesión'; }
  }
  checkSession();

  document.getElementById('loginBtn').addEventListener('click', async ()=>{
    const u=document.getElementById('loginUser').value.trim().replace('@','');
    const p=document.getElementById('loginPass').value.trim();
    if(!u||!p) return toast('Completa usuario y contraseña',true);
    try{
      const r=await fetch(`${API_URL}/iniciar-sesion`,{
        method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',
        body:JSON.stringify({usuario:u,contrasena:p})
      });
      const d=await r.json();
      if(d.exito){ toast('Sesión iniciada @'+d.usuario); sessionSub.textContent=`Sesión activa como @${d.usuario}`; }
      else throw new Error(d.mensaje||'Error al iniciar');
    }catch(err){ toast(err.message,true); }
  });
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    try{
      const r=await fetch(`${API_URL}/cerrar-sesion`,{credentials:'include'});
      const d=await r.json();
      if(d.exito){ toast('Sesión cerrada'); sessionSub.textContent='No hay sesión activa'; }
      else throw new Error(d.mensaje||'Error al cerrar');
    }catch(err){ toast(err.message,true); }
  });

  // Enfocar buscador al abrir pestaña Cuentas
  document.addEventListener('change',(e)=>{
    if(e.target && e.target.id==='t-acc'){
      const el = document.getElementById('igSearchUser');
      if(el) setTimeout(()=>el.focus(), 80);
    }
  });

  /* ===== Buscador IG ===== */
  const igSearchBtn = document.getElementById('igSearchBtn');
  const igSearchUser = document.getElementById('igSearchUser');
  const igSearchResult = document.getElementById('igSearchResult');

  async function buscarUsuarioIG(username){
    try{
      igSearchResult.innerHTML = '<div class="hint">Buscando…</div>';
      const q = username.replace(/^@/,'').trim();
      if(!q) throw new Error('Escribe un usuario');
      const r = await fetch(`${API_URL}/buscar-usuario?username=${encodeURIComponent(q)}`, {credentials:'include'});
      const d = await r.json();
      if(!r.ok) throw new Error(d.mensaje || 'No se pudo buscar');

      const {
        username:uname, full_name, is_verified, follower_count, following_count,
        media_count, biography, profile_pic_url, external_url
      } = d;

      igSearchResult.innerHTML = `
        <div class="c-item">
          ${profile_pic_url
            ? `<img class="c-ava" src="${profile_pic_url}" alt="">`
            : `<div class="c-ava" style="display:grid;place-items:center;background:rgba(255,255,255,.06)">
                 <svg width="16" height="16" class="brand-icon"><use href="#logo-instagram"/></svg>
               </div>`
          }
          <div>
            <div class="c-u">@${uname} ${is_verified ? '<svg class="c-verified"><use href="#ig-verified"/></svg>' : ''}</div>
            <div class="c-net">${full_name || ''}</div>
            <div class="hint">
              ${follower_count!=null?`👥 ${follower_count.toLocaleString()} seguidores · `:''}
              ${following_count!=null?`${following_count.toLocaleString()} seguidos · `:''}
              ${media_count!=null?`${media_count.toLocaleString()} posts`:''}
            </div>
            ${external_url?`<div class="hint">🔗 <a href="${external_url}" target="_blank" rel="noopener">${external_url}</a></div>`:''}
            ${biography?`<div class="hint" style="margin-top:6px;white-space:pre-wrap">${biography}</div>`:''}
          </div>
          <div class="c-r"><svg width="18" height="18" class="brand-icon"><use href="#logo-instagram"/></svg></div>
        </div>`;
    }catch(err){
      igSearchResult.innerHTML = `<div class="hint">❌ ${err.message}</div>`;
    }
  }
  if(igSearchBtn){ igSearchBtn.addEventListener('click', ()=> buscarUsuarioIG(igSearchUser.value||'')); }
  if(igSearchUser){ igSearchUser.addEventListener('keydown', (e)=>{ if(e.key==='Enter') buscarUsuarioIG(igSearchUser.value||''); }); }

  /* ===== Cuentas activas ===== */
  const accList=document.getElementById('accountsList');
  async function loadAccounts(){
    try{
      const r=await fetch(`${API_URL}/cuentas-activas`,{credentials:'include'});
      const arr=await r.json();
      if(!Array.isArray(arr)||arr.length===0){ accList.innerHTML='<div class="hint">No hay cuentas activas</div>'; return; }
      accList.innerHTML = arr.map(acc=>`
        <div class="c-item">
          <div class="c-ava" style="display:grid;place-items:center;background:rgba(255,255,255,.06)"><svg width="16" height="16" class="brand-icon"><use href="#logo-instagram"/></svg></div>
          <div><div class="c-u">@${acc.username}</div><div class="c-net">${acc.status==='activo'?'Activa':'Inactiva'}</div></div>
          <div class="c-r">
            ${acc.status==='activo' ? `<button class="btn" data-logout="${acc.username}">Logout</button>` : `<button class="btn btn-primary" data-login="${acc.username}">Login</button>`}
          </div>
        </div>`).join('');
    }catch{ accList.innerHTML='<div class="hint">Error al cargar cuentas</div>'; }
  }
  loadAccounts(); setInterval(loadAccounts, 30000);
  accList.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.login){
      toast('Iniciando @'+b.dataset.login+'…');
      try{
        const r=await fetch(`${API_URL}/iniciar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.login})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        toast('Sesión iniciada @'+b.dataset.login); loadAccounts();
      }catch(err){ toast(err.message,true); }
    }
    if(b.dataset.logout){
      toast('Cerrando @'+b.dataset.logout+'…');
      try{
        const r=await fetch(`${API_URL}/cerrar-sesion-cuenta`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({usuario:b.dataset.logout})});
        const d=await r.json(); if(!d.exito) throw new Error(d.mensaje||'Error');
        toast('Sesión cerrada @'+b.dataset.logout); loadAccounts();
      }catch(err){ toast(err.message,true); }
    }
  });

})();
</script>
</body>
</html>